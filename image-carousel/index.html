<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Interactive Carousel Block</title>
    <link rel="stylesheet" href="https://cloud.mail.milwaukeetool.eu/customblock-styles">
    <style>
        body{margin:0;padding:20px;font-family:Arial,sans-serif;background-color:#f5f5f5}.container{max-width:800px;margin:0 auto;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);transition:opacity 0.3s ease}.container.loading{opacity:0.6;pointer-events:none}
        
        /* Enhanced input fields with floating labels */
        .field-group{position:relative;margin-bottom:24px}
        .field-input{width:100%;padding:20px 12px 8px 12px;border:2px solid #e1e4e8;border-radius:8px;font-size:14px;transition:all 0.2s ease;background:#fafbfc;box-sizing:border-box}
        .field-input:focus{border-color:#0074d9;background:white;box-shadow:0 0 0 3px rgba(0,116,217,0.1);outline:none}
        .field-label{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;color:#586069;pointer-events:none;transition:all 0.2s ease;background:white;padding:0 4px;font-weight:bold}
        .field-input:focus ~ .field-label,.field-input:not(:placeholder-shown) ~ .field-label{top:-8px;font-size:12px;color:#0074d9}
        
        .field-input.error{border-color:#ff0000}.field-error{color:#ff0000;font-size:12px;margin-top:4px;display:none}.field-input.error + .field-error{display:block}
        
        .section-divider{margin-top:30px;padding-top:20px;border-top:2px solid #eee}.section-title{font-size:16px;font-weight:bold;color:#333;margin-bottom:15px;border-bottom:2px solid #eee;padding-bottom:10px}.slides-container{display:flex;flex-direction:column;gap:15px}
        
        /* Enhanced slide items */
        .slide-item{background:linear-gradient(145deg,#fafbfc,#f6f8fa);padding:20px;border:2px solid #e1e4e8;border-radius:12px;position:relative;transition:all 0.3s cubic-bezier(0.4,0,0.2,1)}
        .slide-item:hover{border-color:#d1d5da;transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.1)}
        .slide-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .slide-title{font-weight:bold;font-size:16px;margin:0;color:#24292e}
        .slide-controls{display:flex;gap:8px}
        
        /* Enhanced control buttons */
        .slide-control-btn{background:none;border:2px solid transparent;cursor:pointer;padding:8px;font-size:16px;line-height:1;color:#586069;transition:all 0.2s ease;border-radius:6px;width:36px;height:36px;display:flex;align-items:center;justify-content:center}
        .slide-control-btn:hover{color:#0074d9;border-color:#0074d9;background:rgba(0,116,217,0.1);transform:scale(1.05)}
        .slide-control-btn:active{transform:scale(0.95)}
        .slide-control-btn:disabled{color:#d1d5da;cursor:not-allowed;border-color:transparent;background:none;transform:none}
        
        /* Enhanced button styling */
        .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 20px;background:linear-gradient(135deg,#0074d9,#0366d6);color:white;text-decoration:none;border-radius:8px;border:none;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden}
        .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.6s}
        .btn:hover{background:linear-gradient(135deg,#005a9e,#044289);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,116,217,0.3)}
        .btn:hover::before{left:100%}
        .btn:active{transform:translateY(0);transition:transform 0.1s}
        .add-slide-btn{margin-top:20px}
        
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:none;align-items:center;justify-content:center;z-index:9999}.loading-overlay.show{display:flex}.loading-spinner{border:3px solid #f3f3f3;border-top:3px solid #0074d9;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.error-banner{background-color:#fee;border:1px solid #fcc;color:#c00;padding:10px;margin-bottom:20px;border-radius:4px;display:none}.error-banner.show{display:block}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>

    <div class="container" id="mainContainer">
        <h2 style="margin-top: 0; color: #333;">Interactive Carousel</h2>
        <div class="error-banner" id="errorBanner"></div>

        <div class="section-title">Slides</div>
        <div id="slidesContainer" class="slides-container">
            <!-- Slides will be dynamically inserted here -->
        </div>
        <button id="addSlideBtn" class="btn add-slide-btn">Add New Slide</button>

        <div class="section-divider" style="margin-top:0; padding-top:0; border-top:none;">
             <div class="section-title" style="border-bottom:none; margin-bottom:0;">Fallback Image Settings</div>
             <p style="font-size:12px; color:#666; margin-top:0; margin-bottom:15px;">Optional: Provide a specific image for email clients that don't support carousels. If left blank, the first slide will be used as the fallback.</p>
             <div class="field-group">
                <input type="url" id="fallbackImageUrl" class="field-input" placeholder=" ">
                <label for="fallbackImageUrl" class="field-label">Fallback Image URL</label>
                <div class="field-error">Please enter a valid image URL.</div>
            </div>
            <div class="field-group">
                <input type="url" id="fallbackLinkUrl" class="field-input" placeholder=" ">
                <label for="fallbackLinkUrl" class="field-label">Fallback Link URL</label>
                <div class="field-error">Please enter a valid link URL.</div>
            </div>
            <div class="field-group">
                <input type="text" id="fallbackAltText" class="field-input" placeholder=" ">
                <label for="fallbackAltText" class="field-label">Fallback Image Alt Text</label>
            </div>
        </div>

    </div>

    <!-- Template for a single slide's UI -->
    <template id="slideTemplate">
        <div class="slide-item">
            <div class="slide-header">
                <h3 class="slide-title">Slide</h3>
                <div class="slide-controls">
                    <button class="slide-control-btn move-up-btn" title="Move Up">▲</button>
                    <button class="slide-control-btn move-down-btn" title="Move Down">▼</button>
                    <button class="slide-control-btn remove-btn" title="Remove Slide">×</button>
                </div>
            </div>
            <div class="field-group">
                <input type="url" class="field-input" data-field="imageUrl" placeholder=" ">
                <label class="field-label">Image URL (620x350px)</label>
                <div class="field-error">Please enter a valid image URL.</div>
            </div>
            <div class="field-group">
                <input type="url" class="field-input" data-field="linkUrl" placeholder=" ">
                <label class="field-label">Link URL</label>
                <div class="field-error">Please enter a valid link URL.</div>
            </div>
            <div class="field-group">
                <input type="text" class="field-input" data-field="altText" placeholder=" ">
                <label class="field-label">Image Alt Text</label>
            </div>
        </div>
    </template>

    <script src="https://cloud.mail.milwaukeetool.eu/customblock-base"></script>
    <script src="https://cloud.mail.milwaukeetool.eu/customblock-blocksdk"></script>
    <script>
        'use strict';

        const moduleConfig = {
            name: 'Interactive Carousel',
            fields: {
                slides: {
                    type: 'list',
                    defaultValue: [
                        { id: crypto.randomUUID(), imageUrl: 'https://placehold.co/620x350/DB021D/FFFFFF?text=Slide+1', linkUrl: 'https://example.com/1', altText: 'Slide 1 Alt Text' },
                        { id: crypto.randomUUID(), imageUrl: 'https://placehold.co/620x350/313131/FFFFFF?text=Slide+2', linkUrl: 'https://example.com/2', altText: 'Slide 2 Alt Text' }
                    ]
                },
                fallbackImageUrl: { type: 'url', defaultValue: '' },
                fallbackLinkUrl: { type: 'url', defaultValue: '' },
                fallbackAltText: { type: 'text', defaultValue: '' }
            },
            debounceDelay: 400,
            maxRetries: 3
        };

        const state = { sdk: null, blockData: {}, isLoading: false, isInitialized: false, retryCount: 0, eventListeners: [] };
        const elements = {};
        let rafId = null;

        // Advanced memory management
        const slideMetadata = new WeakMap();
        const cleanupRegistry = new FinalizationRegistry((heldValue) => {
            console.log('Cleanup registry triggered for slide:', heldValue);
        });

        const utils = {
            debounce(func, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), wait); }; },
            isValidUrl(s) { if (!s || s.trim() === '') return true; try { const u = new URL(s); return u.protocol === 'http:' || u.protocol === 'https:'; } catch (e) { return false; } },
            showError(msg, p = false) { console.error(msg); if(elements.errorBanner) { elements.errorBanner.textContent=msg; elements.errorBanner.classList.add('show'); if(!p) setTimeout(()=>elements.errorBanner.classList.remove('show'),5000); } },
            getFieldValue(f) { const v = state.blockData[f]; return v !== undefined ? v : moduleConfig.fields[f].defaultValue; },
            
            addEventListenerTracked(element, event, handler) {
                element.addEventListener(event, handler);
                state.eventListeners.push({ element, event, handler });
            }
        };

        function cacheElements() {
            elements.mainContainer = document.getElementById('mainContainer');
            elements.loadingOverlay = document.getElementById('loadingOverlay');
            elements.errorBanner = document.getElementById('errorBanner');
            elements.slidesContainer = document.getElementById('slidesContainer');
            elements.addSlideBtn = document.getElementById('addSlideBtn');
            elements.slideTemplate = document.getElementById('slideTemplate');
            elements.fallbackImageUrl = document.getElementById('fallbackImageUrl');
            elements.fallbackLinkUrl = document.getElementById('fallbackLinkUrl');
            elements.fallbackAltText = document.getElementById('fallbackAltText');
            elements.fallbackImageUrlError = elements.fallbackImageUrl.nextElementSibling;
            elements.fallbackLinkUrlError = elements.fallbackLinkUrl.nextElementSibling;
        }

        function setLoadingState(loading) {
            state.isLoading = loading;
            elements.mainContainer.classList.toggle('loading', loading);
            elements.loadingOverlay.classList.toggle('show', loading);
        }

        function updateDataFromUI() {
            // Use DocumentFragment for efficient DOM operations and modern array methods
            const newSlides = Array.from(
                elements.slidesContainer.querySelectorAll('.slide-item'),
                slideEl => {
                    const id = slideEl.dataset.id;
                    const imageUrl = slideEl.querySelector('[data-field="imageUrl"]').value;
                    const linkUrl = slideEl.querySelector('[data-field="linkUrl"]').value;
                    const altText = slideEl.querySelector('[data-field="altText"]').value;
                    return { id, imageUrl, linkUrl, altText };
                }
            );
            
            state.blockData.slides = newSlides;
            state.blockData.fallbackImageUrl = elements.fallbackImageUrl.value;
            state.blockData.fallbackLinkUrl = elements.fallbackLinkUrl.value;
            state.blockData.fallbackAltText = elements.fallbackAltText.value;
            refreshPreview();
        }
        
        const debouncedUpdateDataFromUI = utils.debounce(updateDataFromUI, moduleConfig.debounceDelay);

        function renderSlidesUI() {
            const slides = utils.getFieldValue('slides');
            
            if (!slides || slides.length === 0) {
                elements.slidesContainer.replaceChildren();
                return;
            }

            // Use DocumentFragment for batch DOM operations
            const fragment = document.createDocumentFragment();

            slides.forEach((slide, index) => {
                const slideFragment = elements.slideTemplate.content.cloneNode(true);
                const slideEl = slideFragment.querySelector('.slide-item');
                slideEl.dataset.id = slide.id;
                slideEl.querySelector('.slide-title').textContent = `Slide ${index + 1}`;
                slideEl.querySelector('[data-field="imageUrl"]').value = slide.imageUrl || '';
                slideEl.querySelector('[data-field="linkUrl"]').value = slide.linkUrl || '';
                slideEl.querySelector('[data-field="altText"]').value = slide.altText || '';
                
                if(index === 0) slideEl.querySelector('.move-up-btn').disabled = true;
                if(index === slides.length - 1) slideEl.querySelector('.move-down-btn').disabled = true;
                
                fragment.appendChild(slideFragment);
                
                // Track slide metadata
                const metadata = { id: slide.id, index, element: slideEl };
                slideMetadata.set(slideEl, metadata);
                cleanupRegistry.register(slideEl, slide.id);
            });

            // Single DOM update
            elements.slidesContainer.replaceChildren();
            elements.slidesContainer.appendChild(fragment);
        }

        // Optimized Event Delegation with Action Maps
        const slideActions = {
            '.remove-btn': (slide, index, slides) => {
                slides.splice(index, 1);
                return true;
            },
            '.move-up-btn': (slide, index, slides) => {
                if (index > 0) {
                    [slides[index], slides[index - 1]] = [slides[index - 1], slides[index]];
                    return true;
                }
                return false;
            },
            '.move-down-btn': (slide, index, slides) => {
                if (index < slides.length - 1) {
                    [slides[index], slides[index + 1]] = [slides[index + 1], slides[index]];
                    return true;
                }
                return false;
            },
            '.duplicate-btn': (slide, index, slides) => {
                const newSlide = { ...slide, id: crypto.randomUUID() };
                slides.splice(index + 1, 0, newSlide);
                return true;
            }
        };

        function createDelegatedHandler(fieldName, actionMap) {
            return (event) => {
                // Handle add button clicks
                if (event.target.closest('#addSlideBtn')) {
                    const currentSlides = utils.getFieldValue(fieldName);
                    const newSlides = [...currentSlides, { id: crypto.randomUUID(), imageUrl: '', linkUrl: '', altText: '' }];
                    state.blockData[fieldName] = newSlides;
                    renderSlidesUI();
                    updateDataFromUI();
                    return;
                }

                // Find the closest slide element
                const slideEl = event.target.closest('.slide-item');
                if (!slideEl) return;

                const id = slideEl.dataset.id;
                const currentSlides = state.blockData[fieldName];
                const slideIndex = currentSlides.findIndex(s => s.id === id);
                
                if (slideIndex === -1) return;

                const slide = currentSlides[slideIndex];
                let actionExecuted = false;

                // Execute action using action map
                for (const [selector, action] of Object.entries(actionMap)) {
                    if (event.target.closest(selector)) {
                        const result = action(slide, slideIndex, currentSlides);
                        
                        if (result) {
                            actionExecuted = true;
                            renderSlidesUI();
                            updateDataFromUI();
                        }
                        break;
                    }
                }

                if (!actionExecuted) {
                    console.log('No matching action found for selector');
                }
            };
        }

        function initializeEventHandlers() {
            // Use tracked event listeners
            utils.addEventListenerTracked(elements.mainContainer, 'input', (e) => {
                if(e.target.classList.contains('field-input')) {
                    const input = e.target;
                    const errorEl = input.nextElementSibling;
                    if(input.type === 'url') {
                        const isValid = utils.isValidUrl(input.value);
                        input.classList.toggle('error', !isValid);
                        if(errorEl) errorEl.style.display = isValid ? 'none' : 'block';
                        if(!isValid) return;
                    }
                    debouncedUpdateDataFromUI();
                }
            });

            // Optimized event delegation for slide items
            const slideHandler = createDelegatedHandler('slides', slideActions);
            
            utils.addEventListenerTracked(elements.addSlideBtn, 'click', slideHandler);
            utils.addEventListenerTracked(elements.slidesContainer, 'click', slideHandler);
        }

        function generateTemplate() {
            const slides = utils.getFieldValue('slides');
            if (!slides || slides.length === 0) {
                return '<table align="center" style="width:620px; height:350px; background-color:#ccc;"><tr><td style="text-align:center;font-family:Arial,sans-serif;">Add slides to build your carousel.</td></tr></table>';
            }

            let fallbackImageUrl = utils.getFieldValue('fallbackImageUrl');
            let fallbackLinkUrl = utils.getFieldValue('fallbackLinkUrl');
            let fallbackAltText = utils.getFieldValue('fallbackAltText');

            // Fallback logic remains the same: default to the first slide if fields are empty
            if (!fallbackImageUrl && slides.length > 0) {
                const firstSlide = slides[0];
                fallbackImageUrl = firstSlide.imageUrl || '';
                fallbackLinkUrl = firstSlide.linkUrl || '#';
                fallbackAltText = firstSlide.altText || '';
            }

            const slideCount = slides.length;
            const carouselSlidesWidth = slideCount * 100;
            // FIX 1: Use the raw calculation for better precision, matching AMPscript's output more closely.
            const carouselSlideWidth = 100 / slideCount; 
            
            const radioInputs = slides.map((s, i) => `<input type="radio" name="carousel" id="slide${i + 1}" ${i === 0 ? 'checked="checked"' : ''} style="display: none !important; mso-hide: all !important;">`).join('\n        ');
            const slideDivs = slides.map(s => `<div class="carousel-slide"><a href="${s.linkUrl || '#'}" target="_blank"><img src="${s.imageUrl || ''}" alt="${s.altText || ''}" width="620" height="350" style="display: block; width: 100%; height: 100%;"></a></div>`).join('\n            ');
            const arrowLabels = Array.from({length: slideCount}, (_, i) => `<label for="slide${i + 1}" class="arrow-left"></label>\n            <label for="slide${i + 1}" class="arrow-right"></label>`).join('\n          ');
            const dotLabels = Array.from({length: slideCount}, (_, i) => `<label for="slide${i + 1}"></label>`).join('\n            ');

            const dynamicCSS = slides.map((s, i) => {
                const slideNum = i + 1;
                const transformX = i * carouselSlideWidth;
                const prevSlide = slideNum - 1;
                const nextSlide = slideNum + 1;
                return `
      #slide${slideNum}:checked ~ .carousel-container .carousel-slides {
        transform: translateX(-${transformX}%);
        -webkit-transform: translateX(-${transformX}%);
      }
      ${slideNum > 1 ? `
      #slide${slideNum}:checked ~ .carousel-container .arrow-controls .arrow-left[for="slide${prevSlide}"] { display: block; }` : ''}
      ${slideNum < slideCount ? `
      #slide${slideNum}:checked ~ .carousel-container .arrow-controls .arrow-right[for="slide${nextSlide}"] { display: block; }` : ''}

      #slide${slideNum}:checked ~ .carousel-container .progress-dots label[for="slide${slideNum}"] {
        /* FIX 2: Corrected the active dot color to match the original. */
        background-color: #DB021D;
        border-color: rgba(0, 0, 0, 0.5);
      }
    `;
            }).join('');

            return `
<!--[if !mso]><!-->
<style type="text/css">
/* Reset styles */
body, table, td, a { -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }
table, td { mso-table-lspace: 0pt; mso-table-rspace: 0pt; }
img { -ms-interpolation-mode: bicubic; border: 0; outline: none; text-decoration: none; }

/* Hide radio buttons */
input[type="radio"] {
    display: none !important;
    mso-hide: all !important;
}

/* Mobile responsive styles */
@media screen and (max-width: 580px) {
    .content-outer {
        width: 100% !important;
        height: auto !important;
    }
}

/* Interactive carousel styles for supporting clients */
@media screen and (-webkit-min-device-pixel-ratio: 0) {
    /* Hide fallback content */
    .fallback {
        display: none !important;
    }
    
    /* Show carousel */
    .carousel-wrapper {
        display: block !important;
        max-height: none !important;
        overflow: visible !important;
    }
    
    .carousel-container {
        position: relative;
        overflow: hidden;
        width: 620px;
        height: 350px;
    }
    
    /* Carousel slides container */
    .carousel-slides {
        position: relative;
        width: ${carouselSlidesWidth}%;
        height: 100%;
        transition: transform 0.5s ease-in-out;
        -webkit-transition: -webkit-transform 0.5s ease-in-out;
    }
    
    /* Individual slides */
    .carousel-slide {
        float: left;
        width: ${carouselSlideWidth}%;
        height: 100%;
    }
    
    .carousel-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    
    /* Arrow controls */
    .arrow-controls {
        position: absolute;
        top: 50%;
        width: 100%;
        margin-top: -25px;
        pointer-events: none;
    }
    
    .arrow-controls label {
        display: none;
        position: absolute;
        width: 50px;
        height: 50px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        cursor: pointer;
        pointer-events: all;
        transition: background-color 0.3s;
    }
    
    .arrow-controls label:hover {
        background-color: rgba(0, 0, 0, 0.7);
    }
    
    /* Arrow icons */
    .arrow-controls label:before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 12px;
        height: 12px;
        margin: -6px 0 0 -4px;
        border-top: 3px solid #ffffff;
        border-right: 3px solid #ffffff;
    }
    
    .arrow-left {
        left: 20px;
    }
    
    .arrow-left:before {
        transform: rotate(-135deg);
        -webkit-transform: rotate(-135deg);
    }
    
    .arrow-right {
        right: 20px;
    }
    
    .arrow-right:before {
        transform: rotate(45deg);
        -webkit-transform: rotate(45deg);
        margin-left: -8px !important;
    }
    
    /* Progress dots */
    .progress-dots {
        position: absolute;
        bottom: 20px;
        left: 0;
        right: 0;
        text-align: center;
    }
    
    .progress-dots label {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #000000;
        margin: 0 5px;
        cursor: pointer;
        transition: background-color 0.3s;
        border: 2px solid rgba(0, 0, 0, 0.3);
    }
    
    .progress-dots label:hover {
        background-color: #333333;
    }
    
    /* --- DYNAMIC CSS GENERATED BY JAVASCRIPT --- */
    ${dynamicCSS}
    /* --- END DYNAMIC CSS --- */

    @media only screen and (max-width: 620px) {
        .carousel-container {
            width: 100% !important;
            height: auto !important;
        }
        
        .carousel-container img {
            height: auto !important;
        }
    }
}

/* Hide carousel from problematic clients */
#MessageViewBody .fallback, body.MsgBody .fallback { display: block !important; }
#MessageViewBody .carousel-wrapper, body.MsgBody .carousel-wrapper { display: none !important; }

/* Outlook.com specific targeting */
[class~="x_carousel-wrapper"] { display: none !important; }
[class~="x_fallback"] { display: block !important; }

/* FIX 3: Added the missing Yahoo-specific media query. */
@media screen yahoo {
    .fallback { display: block !important; max-height: none !important; }
    .carousel-wrapper { display: none !important; max-height: 0 !important; overflow: hidden !important; }
}
</style>
<!--<![endif]-->
<!-- Separate style block for Outlook.com \\0 hack -->
<style type="text/css">
.carousel-wrapper\\0 { display: none !important; }
.fallback\\0 { display: block !important; }
</style>

<!-- Full Width Image Carousel -->
<table align="center" border="0" cellpadding="0" cellspacing="0" class="content-outer" role="presentation" style="width: 620px;">
  <tr>
    <td align="center" style="padding: 0;" valign="top">
      
      <!-- Interactive Carousel with Arrows -->
      <!--[if !mso]><!-->
      <div class="carousel-wrapper" style="display: none; max-height: 0; overflow: hidden;">
        
        <!-- Radio buttons for slide control (DYNAMIC) -->
        ${radioInputs}

        <div class="carousel-container">
          <div class="carousel-slides">
            
            <!-- Slides (DYNAMIC) -->
            ${slideDivs}

          </div>
          
          <!-- Arrow Controls (DYNAMIC) -->
          <div class="arrow-controls">
            ${arrowLabels}
          </div>
          
          <!-- Progress Dots (DYNAMIC) -->
          <div class="progress-dots">
            ${dotLabels}
          </div>

        </div>
      </div>
      <!--<![endif]-->
      
      <!-- Fallback Content (Shown by default) - Single Hero Image -->
      <div class="fallback">
        <table align="center" border="0" cellpadding="0" cellspacing="0" style="width: 100%;">
          <tr>
            <td align="center" style="padding: 0;">
              <a href="${fallbackLinkUrl}" target="_blank">
                <img src="${fallbackImageUrl}" alt="${fallbackAltText}" width="620" height="350" style="display: block; width: 100%; max-width: 620px; height: auto;">
              </a>
            </td>
          </tr>
        </table>
      </div>

    </td>

  </tr>
</table>`;
        }

        function refreshPreview() {
            if (rafId) cancelAnimationFrame(rafId);
            
            rafId = requestAnimationFrame(() => {
                if (state.isLoading || !state.sdk) return;
                try {
                    const html = generateTemplate();
                    state.sdk.setContent(html);
                    
                    // Save the data for persistence and for the Preview tab
                    if (state.sdk.setData) {
                        state.sdk.setData({ ...state.blockData, content: html });
                    }
                } catch (error) {
                    utils.showError(`Preview update failed: ${error.message}`);
                }
            });
        }

        function loadData() {
            if (!state.sdk) return utils.showError('SDK not available');
            setLoadingState(true);
            
            state.sdk.getData((data) => {
                try {
                    // When loading, prioritize the structured 'slides' data over saved 'content'
                    state.blockData.slides = (data && data.slides && data.slides.length > 0) ? data.slides : utils.getFieldValue('slides');
                    state.blockData.slides.forEach(s => { if (!s.id) s.id = crypto.randomUUID(); });
                    
                    state.blockData.fallbackImageUrl = data?.fallbackImageUrl || '';
                    state.blockData.fallbackLinkUrl = data?.fallbackLinkUrl || '';
                    state.blockData.fallbackAltText = data?.fallbackAltText || '';

                    renderSlidesUI();

                    elements.fallbackImageUrl.value = state.blockData.fallbackImageUrl;
                    elements.fallbackLinkUrl.value = state.blockData.fallbackLinkUrl;
                    elements.fallbackAltText.value = state.blockData.fallbackAltText;

                    refreshPreview();
                    state.retryCount = 0;
                } catch (error) {
                    utils.showError(`Failed to load data: ${error.message}`);
                    state.blockData = {}; // Reset to defaults on error
                    renderSlidesUI();
                    refreshPreview();
                } finally {
                    setLoadingState(false);
                }
            });
        }
        
        // Enhanced cleanup function with memory management
        function cleanup() {
            // Clean up event listeners
            state.eventListeners.forEach(({ element, event, handler }) => { 
                if (element && element.removeEventListener) element.removeEventListener(event, handler); 
            }); 
            state.eventListeners = [];
            
            // Cancel any pending RAF
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
            
            // Clear slide metadata
            slideMetadata.clear();
            
            console.log('Image Carousel cleanup completed');
        }
        
        function initializeWithRetry() {
            try {
                if (!window.sfdc || !window.sfdc.BlockSDK) throw new Error('BlockSDK not loaded');
                
                state.sdk = new window.sfdc.BlockSDK({
                    tabs: ['htmlblock']
                });
                cacheElements();
                initializeEventHandlers();
                loadData();
                
                // Add cleanup on page unload
                window.addEventListener('beforeunload', cleanup);
                
                state.isInitialized = true;
            } catch (error) {
                utils.showError(`Initialization failed: ${error.message}`);
                if (state.retryCount < moduleConfig.maxRetries) {
                    state.retryCount++;
                    setTimeout(() => initializeWithRetry(), 1000 * state.retryCount);
                } else {
                    utils.showError('Failed to initialize after multiple attempts. Please refresh.', true);
                }
                setLoadingState(false);
            }
        }

        document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', initializeWithRetry) : initializeWithRetry();
    </script>
</body>
</html>