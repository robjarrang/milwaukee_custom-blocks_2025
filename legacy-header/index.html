<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Legacy Header Block</title>
    
    <!-- Quill.js CSS (locally hosted) -->
    <link href="../shared-assets/quill.snow.css" rel="stylesheet">
    <!-- Local assets for fastest loading -->
    <link rel="stylesheet" href="../shared-assets/customblock-styles.css">
    <style>
        body{margin:0;padding:10px;font-family:Arial,sans-serif;background-color:white}.container{max-width:800px;margin:0 auto;background:white;padding:20px;border-radius:8px;transition:opacity 0.3s ease}.container.loading{opacity:0.6;pointer-events:none}.field-group{margin-bottom:20px}.field-label{display:block;margin-bottom:5px;font-weight:bold;color:#333;font-size:14px}.field-input{width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;transition:border-color 0.3s ease}.field-input:focus{outline:none;border-color:#0074d9;box-shadow:0 0 0 2px rgba(0,116,217,0.2)}.field-input.error{border-color:#ff0000}.field-error{color:#ff0000;font-size:12px;margin-top:4px;display:none}.field-input.error + .field-error{display:block}.option-selector{display:flex;gap:10px}.option-button{flex:1;padding:8px;text-align:center;border:2px solid #ddd;border-radius:4px;cursor:pointer;transition:all .2s ease;font-size:13px}.option-button:hover{border-color:#0074d9;background-color:#f0f8ff}.option-button.selected{border-color:#0074d9;background-color:#0074d9;color:white}.section-divider{margin:30px 0;border-top:2px solid #eee;padding-top:20px}.section-title{font-size:16px;font-weight:bold;color:#333;margin-bottom:15px}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:none;align-items:center;justify-content:center;z-index:9999}.loading-overlay.show{display:flex}.loading-spinner{border:3px solid #f3f3f3;border-top:3px solid #0074d9;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.error-banner{background-color:#fee;border:1px solid #fcc;color:#c00;padding:10px;margin-bottom:20px;border-radius:4px;display:none}.error-banner.show{display:block}
        .config-tools{position:absolute;top:20px;right:20px;display:flex;gap:8px;z-index:100}
        .config-btn{width:36px;height:36px;background:none;border:1px solid #ddd;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease}
        .config-btn:hover{border-color:#0074d9;background-color:#f0f8ff}
        .config-btn svg{width:20px;height:20px;stroke:#666}
        .config-btn:hover svg{stroke:#0074d9}
        .config-btn.success{background-color:#d4edda;border-color:#28a745}
        .config-btn.success svg{fill:#28a745;stroke:none}
        @keyframes fadeSuccess{0%{opacity:1}100%{opacity:0}}
        .config-btn.fade-out{animation:fadeSuccess 0.5s ease-out forwards}
        .paste-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center}
        .paste-modal.show{display:flex}
        .paste-modal-content{background:white;padding:40px;max-width:400px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.3);animation:modalSlideIn 0.3s ease-out;text-align:center}
        @keyframes modalSlideIn{from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}
        .paste-modal-icon{width:64px;height:64px;margin:0 auto 20px;background:#f0f8ff;border-radius:50%;display:flex;align-items:center;justify-content:center}
        .paste-modal-icon svg{width:32px;height:32px;fill:#0074d9}
        .paste-modal-title{font-size:22px;font-weight:bold;color:#333;margin:0 0 12px 0}
        .paste-modal-instructions{color:#666;font-size:15px;line-height:1.5;margin-bottom:24px}
        .paste-modal-hint{background:#f9f9f9;padding:12px;border-radius:6px;color:#888;font-size:13px;margin-bottom:24px;transition:all 0.3s ease}
        .paste-modal-hint.error{background:#fee;border:1px solid #fcc;color:#c00}
        .paste-modal-footer{display:flex;gap:10px;justify-content:center}
        .paste-modal-btn{padding:12px 24px;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:bold;transition:all 0.2s;min-width:100px}
        .paste-modal-btn.primary{background-color:#0074d9;color:white;box-shadow:0 2px 8px rgba(0,116,217,0.3)}
        .paste-modal-btn.primary:hover{background-color:#005a9e;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,116,217,0.4)}
        .paste-modal-btn.secondary{background-color:#f0f0f0;color:#666}
        .paste-modal-btn.secondary:hover{background-color:#e0e0e0}
        .paste-hidden-textarea{position:absolute;left:-9999px;opacity:0}
        /* Badge type selector - scrollable grid */
        .badge-selector{display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;max-height:300px;overflow-y:auto;padding:4px;border:1px solid #eee;border-radius:4px}
        .badge-option{padding:10px 8px;text-align:center;border:2px solid #ddd;border-radius:4px;cursor:pointer;transition:all .2s ease;font-size:12px;background:white}
        .badge-option:hover{border-color:#0074d9;background-color:#f0f8ff}
        .badge-option.selected{border-color:#0074d9;background-color:#0074d9;color:white}
        .badge-option.category-header{grid-column:1/-1;background:#f5f5f5;font-weight:bold;cursor:default;border:none;color:#666;font-size:11px;text-transform:uppercase;letter-spacing:0.5px}
        .badge-option.category-header:hover{background:#f5f5f5;border:none}
        /* Quill editor styles */
        .quill-container{background:white;border:1px solid #ddd;border-radius:4px}.ql-toolbar{border:none;border-bottom:1px solid #ddd;border-radius:4px 4px 0 0}.ql-container{border:none;border-radius:0 0 4px 4px;font-size:14px}.ql-editor{min-height:2.5em;padding:8px 12px}.limited-toolbar .ql-toolbar{padding:5px}.limited-toolbar .ql-toolbar button{width:24px;height:24px}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>

    <div class="container" id="mainContainer">
        <h2 style="margin-top: 0; color: #333;">Legacy Header</h2>
        <div class="error-banner" id="errorBanner"></div>
        
        <div class="config-tools">
            <button id="copyConfigBtn" class="config-btn" title="Copy Configuration">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            </button>
            <button id="pasteConfigBtn" class="config-btn" title="Paste Configuration">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
            </button>
        </div>

        <div class="section-divider" style="margin-top:0; padding-top:0; border-top:none;">
            <div class="section-title">Badge Settings</div>
            
            <div class="field-group">
                <label class="field-label">Show Badge</label>
                <div class="option-selector" id="showBadgeSelector">
                    <div class="option-button selected" data-value="true">Yes</div>
                    <div class="option-button" data-value="false">No</div>
                </div>
            </div>

            <div class="field-group" id="badgeTypeGroup">
                <label class="field-label">Badge Type</label>
                <div class="badge-selector" id="badgeTypeSelector">
                    <!-- Special Options -->
                    <div class="badge-option category-header">Special</div>
                    <div class="badge-option selected" data-value="dynamic">Dynamic (Profile)</div>
                    
                    <!-- System Logos -->
                    <div class="badge-option category-header">System Logos</div>
                    <div class="badge-option" data-value="M12">M12</div>
                    <div class="badge-option" data-value="M18">M18</div>
                    <div class="badge-option" data-value="MXFuel">MX Fuel</div>
                    <div class="badge-option" data-value="TruckTour">Truck Tour</div>
                    <div class="badge-option" data-value="AuthorisedDistribution">Authorised Dist.</div>
                    
                    <!-- Trade Logos -->
                    <div class="badge-option category-header">Trade Logos</div>
                    <div class="badge-option" data-value="Automotive">Automotive</div>
                    <div class="badge-option" data-value="Carpentry">Carpentry</div>
                    <div class="badge-option" data-value="Construction">Construction</div>
                    <div class="badge-option" data-value="Demolition">Demolition</div>
                    <div class="badge-option" data-value="DrainCleaning">Drain Cleaning</div>
                    <div class="badge-option" data-value="Drywall">Drywall</div>
                    <div class="badge-option" data-value="Electrical">Electrical</div>
                    <div class="badge-option" data-value="FireAndRescue">Fire & Rescue</div>
                    <div class="badge-option" data-value="Hire">Hire</div>
                    <div class="badge-option" data-value="Landscaping">Landscaping</div>
                    <div class="badge-option" data-value="MaintenanceAndOperations">Maintenance</div>
                    <div class="badge-option" data-value="Manufacturing">Manufacturing</div>
                    <div class="badge-option" data-value="Networking">Networking</div>
                    <div class="badge-option" data-value="Plumbing">Plumbing</div>
                    <div class="badge-option" data-value="Utilities">Utilities</div>
                </div>
            </div>
        </div>

        <div class="section-divider">
            <div class="section-title">Header Text</div>
            
            <div class="field-group">
                <label class="field-label">Show Header</label>
                <div class="option-selector" id="showHeaderSelector">
                    <div class="option-button selected" data-value="true">Yes</div>
                    <div class="option-button" data-value="false">No</div>
                </div>
            </div>

            <div class="field-group" id="headerTextGroup">
                <label class="field-label">Header Message</label>
                <div id="headerTextEditor" class="quill-container limited-toolbar"></div>
            </div>
        </div>
    </div>

    <div id="pasteModal" class="paste-modal">
        <div class="paste-modal-content">
            <div class="paste-modal-icon">
                <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
            </div>
            <h3 class="paste-modal-title">Ready to Paste</h3>
            <p class="paste-modal-instructions">Press <strong>Ctrl+V</strong> (or <strong>Cmd+V</strong> on Mac) to paste your copied block configuration.</p>
            <div class="paste-modal-hint" id="pasteModalHint">The block will automatically update with the pasted settings</div>
            <div class="paste-modal-footer">
                <button id="pasteModalCancel" class="paste-modal-btn secondary">Cancel</button>
            </div>
        </div>
    </div>
    <textarea id="pasteHiddenTextarea" class="paste-hidden-textarea"></textarea>

    <!-- Quill.js script -->
    <script src="../shared-assets/quill.js"></script>
    <!-- Local bundle for fastest loading -->
    <script src="../shared-assets/customblock-bundle.js"></script>
    <script src="../shared-assets/quill-config.js"></script>
    <script>
        'use strict';

        const moduleConfig = {
            name: 'Legacy Header',
            fields: {
                showBadge: { type: 'text', defaultValue: 'true' },
                badgeType: { type: 'text', defaultValue: 'dynamic' },
                showHeader: { type: 'text', defaultValue: 'true' },
                headerText: { type: 'text', defaultValue: 'See what MILWAUKEE® customers have to say.', maxLength: 200 }
            },
            debounceDelay: 300,
            maxRetries: 3
        };

        const state = {
            sdk: null,
            editors: {},
            blockData: {},
            isLoading: false,
            isInitialized: false,
            eventListeners: [],
            retryCount: 0
        };
        const elements = {};
        let rafId = null;

        const utils = {
            debounce(func, wait) {
                let timeout;
                return function(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func.apply(this, args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            showError(m, p = false) {
                if (elements.errorBanner) {
                    elements.errorBanner.textContent = m;
                    elements.errorBanner.classList.add('show');
                    if (!p) setTimeout(() => elements.errorBanner.classList.remove('show'), 5000);
                }
                console.error('Legacy Header Error:', m);
            },
            getFieldValue(fieldName) {
                const value = state.blockData[fieldName];
                const fieldConfig = moduleConfig.fields[fieldName];
                return (value !== undefined && value !== null) ? value : fieldConfig.defaultValue;
            },
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        function cacheElements() {
            elements.mainContainer = document.getElementById('mainContainer');
            elements.loadingOverlay = document.getElementById('loadingOverlay');
            elements.errorBanner = document.getElementById('errorBanner');
            elements.showBadgeSelector = document.getElementById('showBadgeSelector');
            elements.badgeTypeSelector = document.getElementById('badgeTypeSelector');
            elements.badgeTypeGroup = document.getElementById('badgeTypeGroup');
            elements.showHeaderSelector = document.getElementById('showHeaderSelector');
            elements.headerTextGroup = document.getElementById('headerTextGroup');
            elements.headerTextEditor = document.getElementById('headerTextEditor');
        }

        function setLoadingState(loading) {
            state.isLoading = loading;
            if (elements.mainContainer && elements.loadingOverlay) {
                elements.mainContainer.classList.toggle('loading', loading);
                elements.loadingOverlay.classList.toggle('show', loading);
            }
        }

        function toggleBadgeTypeVisibility(showBadge) {
            if (elements.badgeTypeGroup) {
                elements.badgeTypeGroup.style.display = showBadge === 'true' ? 'block' : 'none';
            }
        }

        function toggleHeaderTextVisibility(showHeader) {
            if (elements.headerTextGroup) {
                elements.headerTextGroup.style.display = showHeader === 'true' ? 'block' : 'none';
            }
        }

        function initializeHeaderEditor() {
            if (!elements.headerTextEditor || state.editors.headerText) return;

            // Create editor with title preset (includes superscript)
            const editor = new Quill(elements.headerTextEditor, QuillConfigManager.createConfig('title', {
                placeholder: 'See what MILWAUKEE® customers have to say.'
            }));

            state.editors.headerText = editor;

            // Set initial content
            const content = utils.getFieldValue('headerText');
            if (content && content.trim()) {
                QuillConfigManager.setContent(editor, content);
            }

            // Handle content changes
            const updateHandler = QuillConfigManager.createUpdateHandler(() => {
                const html = QuillConfigManager.getCleanContent(editor);
                updateData('headerText', html);
            }, moduleConfig.debounceDelay);

            editor.on('text-change', updateHandler);
        }

        function getHeaderTextContent() {
            if (state.editors.headerText) {
                return QuillConfigManager.getCleanContent(state.editors.headerText);
            }
            return utils.getFieldValue('headerText');
        }

        function updateData(field, value) {
            if (state.blockData[field] != value) {
                state.blockData[field] = value;
                refreshPreview();
            }
        }

        const debouncedUpdateData = utils.debounce(updateData, moduleConfig.debounceDelay);

        // Define which badge types are system logos vs trade logos
        const systemLogos = ['M12', 'M18', 'MXFuel', 'TruckTour', 'AuthorisedDistribution'];
        const tradeLogos = ['Automotive', 'Carpentry', 'Construction', 'Demolition', 'DrainCleaning', 'Drywall', 'Electrical', 'FireAndRescue', 'Hire', 'Landscaping', 'MaintenanceAndOperations', 'Manufacturing', 'Networking', 'Plumbing', 'Utilities'];

        // Generate the AMPscript block for badge URL lookup
        function generateAmpScript() {
            const showBadge = utils.getFieldValue('showBadge');
            const badgeType = utils.getFieldValue('badgeType');

            // If badge is hidden, minimal AMPscript
            if (showBadge !== 'true') {
                return `<!--%%[
VAR @ShowBadge
SET @ShowBadge = "false"
]%%-->`;
            }

            // Dynamic mode - let Content Block handle everything (attribute checking + URL lookup)
            if (badgeType === 'dynamic') {
                return `<!--%%[
/* Legacy Header - Dynamic Badge Configuration */
VAR @UserCulture, @LogoImageURL, @LogoLinkURL, @LogoType, @ShowBadge
SET @UserCulture = AttributeValue("UserCulture")
SET @ShowBadge = "true"

IF Empty(@UserCulture) THEN
    SET @UserCulture = "EN-GB"
ENDIF

SET @LogoImageURL = ""
SET @LogoLinkURL = ""
SET @LogoType = ""

/* Dynamic mode - Content Block checks subscriber profile attributes and sets URLs */
]%%--><!--%%=ContentBlockById("563072")=%%--><!--%%[
/* Hide badge if no logo was determined */
IF Empty(@LogoImageURL) THEN
    SET @ShowBadge = "false"
ENDIF
]%%-->`;
            }

            // Manual system logo - handle inline
            if (systemLogos.includes(badgeType)) {
                return `<!--%%[
/* Legacy Header - Manual System Logo: ${badgeType} */
VAR @UserCulture, @LogoImageURL, @LogoLinkURL, @LogoType, @ShowBadge
SET @UserCulture = AttributeValue("UserCulture")
SET @ShowBadge = "true"

IF Empty(@UserCulture) THEN
    SET @UserCulture = "EN-GB"
ENDIF

SET @LogoImageURL = ""
SET @LogoLinkURL = ""
SET @LogoType = "${badgeType}"

/* System Logo URL Lookup */
${generateSystemLogoUrlLookup(badgeType)}
]%%-->`;
            }

            // Manual trade logo - set @Manual_* variable and call Content Block
            if (tradeLogos.includes(badgeType)) {
                return `<!--%%[
/* Legacy Header - Manual Trade Logo: ${badgeType} */
VAR @UserCulture, @LogoImageURL, @LogoLinkURL, @LogoType, @ShowBadge, @Manual_${badgeType}
SET @UserCulture = AttributeValue("UserCulture")
SET @ShowBadge = "true"

IF Empty(@UserCulture) THEN
    SET @UserCulture = "EN-GB"
ENDIF

SET @LogoImageURL = ""
SET @LogoLinkURL = ""
SET @LogoType = ""
SET @Manual_${badgeType} = "true"

/* Content Block handles URL lookup for trade logo */
]%%--><!--%%=ContentBlockById("563072")=%%--><!--%%[
/* Hide badge if no logo was determined */
IF Empty(@LogoImageURL) THEN
    SET @ShowBadge = "false"
ENDIF
]%%-->`;
            }

            // Fallback (should not happen)
            return `<!--%%[
VAR @ShowBadge
SET @ShowBadge = "false"
]%%-->`;
        }

        // Generate URL lookup for a specific system logo
        function generateSystemLogoUrlLookup(logoType) {
            const systemLogoUrls = {
                M12: {
                    image: "https://image.mail.milwaukeetool.eu/lib/fe2f11717564047a761c78/m/1/aee3c719-16d2-4817-9f74-67e0da54bb52.png",
                    path: "/systems/m12/"
                },
                M18: {
                    image: "https://image.mail.milwaukeetool.eu/lib/fe2f11717564047a761c78/m/1/8c31c2cd-e939-4b3c-b02d-f94706922741.png",
                    path: "/systems/m18/"
                },
                MXFuel: {
                    image: "https://image.mail.milwaukeetool.eu/lib/fe2f11717564047a761c78/m/1/9bb4dd26-9f86-4a1c-9d9f-af3845341a4f.png",
                    path: "/systems/mx-fuel/"
                },
                TruckTour: {
                    image: "https://image.mail.milwaukeetool.eu/lib/fe2f11717564047a761c78/m/1/0c023144-dbc0-4a70-9e01-b2aa70593c98.png",
                    link: "https://uk.milwaukeetool.eu/trucktour2025/"
                },
                AuthorisedDistribution: {
                    image: "https://image.mail.milwaukeetool.eu/lib/fe2f11717564047a761c78/m/1/5d3c1b88-4540-4505-af5f-82c03525794a.png",
                    path: "/"
                }
            };

            const config = systemLogoUrls[logoType];
            if (!config) return '';

            // TruckTour has a fixed URL
            if (logoType === 'TruckTour') {
                return `SET @LogoImageURL = "${config.image}"
SET @LogoLinkURL = "${config.link}"`;
            }

            // Other system logos use culture-based URLs
            return `SET @LogoImageURL = "${config.image}"
IF @UserCulture == "BG-BG" THEN SET @LogoLinkURL = "https://bg.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "CS-CZ" THEN SET @LogoLinkURL = "https://cz.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "DA-DK" THEN SET @LogoLinkURL = "https://dk.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "NL-BE" THEN SET @LogoLinkURL = "https://benl.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "NL-NL" THEN SET @LogoLinkURL = "https://nl.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "EN-ZA" THEN SET @LogoLinkURL = "https://za.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "AR-AE" THEN SET @LogoLinkURL = "https://ae.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "EN-GB" THEN SET @LogoLinkURL = "https://uk.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "ET-EE" THEN SET @LogoLinkURL = "https://ee.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "FI-FI" THEN SET @LogoLinkURL = "https://fi.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "FR-BE" THEN SET @LogoLinkURL = "https://befr.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "FR-FR" THEN SET @LogoLinkURL = "https://fr.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "FR-LU" THEN SET @LogoLinkURL = "https://frlu.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "FR-CH" THEN SET @LogoLinkURL = "https://frch.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "DE-AT" THEN SET @LogoLinkURL = "https://deat.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "DE-DE" THEN SET @LogoLinkURL = "https://de.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "DE-LU" THEN SET @LogoLinkURL = "https://delu.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "DE-CH" THEN SET @LogoLinkURL = "https://dech.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "HU-HU" THEN SET @LogoLinkURL = "https://hu.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "IT-IT" THEN SET @LogoLinkURL = "https://it.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "LV-LV" THEN SET @LogoLinkURL = "https://lv.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "LT-LT" THEN SET @LogoLinkURL = "https://lt.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "NO-NO" OR @UserCulture == "NN-NO" THEN SET @LogoLinkURL = "https://no.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "PL-PL" THEN SET @LogoLinkURL = "https://pl.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "PT-PT" THEN SET @LogoLinkURL = "https://pt.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "RO-RO" THEN SET @LogoLinkURL = "https://ro.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "SK-SK" THEN SET @LogoLinkURL = "https://sk.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "ES-ES" THEN SET @LogoLinkURL = "https://es.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "SV-SE" THEN SET @LogoLinkURL = "https://se.milwaukeetool.eu${config.path}"
ELSEIF @UserCulture == "TR-TR" THEN SET @LogoLinkURL = "https://tr.milwaukeetool.eu${config.path}"
ELSE SET @LogoLinkURL = "https://www.milwaukeetool.eu${config.path}"
ENDIF`;
        }

        // Get human-readable label for badge type
        function getBadgeAltText(badgeType) {
            const labels = {
                'dynamic': 'Milwaukee Badge (Dynamic)',
                'M12': 'Milwaukee M12 System',
                'M18': 'Milwaukee M18 System',
                'MXFuel': 'Milwaukee MX FUEL System',
                'TruckTour': 'Milwaukee Truck Tour',
                'AuthorisedDistribution': 'Milwaukee Authorised Distributor',
                'Automotive': 'Milwaukee Automotive Trade',
                'Carpentry': 'Milwaukee Carpentry Trade',
                'Construction': 'Milwaukee Construction Trade',
                'Demolition': 'Milwaukee Demolition Trade',
                'DrainCleaning': 'Milwaukee Drain Cleaning Trade',
                'Drywall': 'Milwaukee Drywall Trade',
                'Electrical': 'Milwaukee Electrical Trade',
                'FireAndRescue': 'Milwaukee Fire & Rescue Trade',
                'Hire': 'Milwaukee Hire Trade',
                'Landscaping': 'Milwaukee Landscaping Trade',
                'MaintenanceAndOperations': 'Milwaukee Maintenance & Operations Trade',
                'Manufacturing': 'Milwaukee Manufacturing Trade',
                'Networking': 'Milwaukee Networking Trade',
                'Plumbing': 'Milwaukee Plumbing Trade',
                'Utilities': 'Milwaukee Utilities Trade'
            };
            return labels[badgeType] || 'Milwaukee Badge';
        }

        function generateTemplate() {
            const showBadge = utils.getFieldValue('showBadge');
            const badgeType = utils.getFieldValue('badgeType');
            const showHeader = utils.getFieldValue('showHeader');
            const headerText = getHeaderTextContent();
            const ampScript = generateAmpScript();
            const badgeAltText = getBadgeAltText(badgeType);

            // Badge HTML - conditionally shown via AMPscript
            const badgeHtml = showBadge === 'true' ? `<!--%%[ IF @ShowBadge == "true" AND NOT Empty(@LogoImageURL) THEN ]%%--><a href="%%=RedirectTo(@LogoLinkURL)=%%" target="_blank"><img alt="${badgeAltText}" src="%%=v(@LogoImageURL)=%%" style="border: none; display: inline-block; height: auto; outline: none; text-decoration: none;" width="100"></a><!--%%[ ENDIF ]%%-->` : '';

            // Header text section (black bar)
            const headerHtml = showHeader === 'true' ? `<tr>
<td class="side" style="background-color: #000000; width: 20px;">&nbsp;</td>
<td align="center" class="content-inner" style="background-color: #000000; width: 580px;" valign="top">
<div style="clear: both; display: block; font-size: 10px; height: 10px; line-height: 10px; margin: 0px; mso-line-height-rule: exactly; padding: 0px;">&nbsp;</div>
<table align="center" border="0" cellpadding="0" cellspacing="0" class="sect" role="presentation" style="width: 100%;">
<tr>
<td align="left" class="block mobile-text-center" style="color: #FFFFFF; font-weight: bold; text-align: center; text-transform: uppercase; width: 100%; font-family: 'Helvetica-Neue', sans-serif, 'Open-Sans';" valign="">
<span style="color:#ffffff;">${headerText}</span>
</td>
</tr>
</table>
<div style="clear: both; display: block; font-size: 10px; height: 10px; line-height: 10px; margin: 0px; mso-line-height-rule: exactly; padding: 0px;">&nbsp;</div>
</td>
<td class="side" style="background-color: #000000; width: 20px;">&nbsp;</td>
</tr>` : '';

            return `<!-- START .legacy-header -->
${ampScript}
<table align="center" border="0" cellpadding="0" cellspacing="0" class="content-outer" role="presentation" style="background-color: #DB021D; width: 620px;">
${headerHtml}
<tr>
<td class="side" style="width: 20px;">&nbsp;</td>
<td align="center" class="content-inner" style="width: 580px;" valign="top">
<div style="clear: both; display: block; font-size: 10px; height: 10px; line-height: 10px; margin: 0px; mso-line-height-rule: exactly; padding: 0px;">&nbsp;</div>
<table align="center" border="0" cellpadding="0" cellspacing="0" class="sect" role="presentation" style="width: 100%;">
<tr>
<!--[if !mso]><!--><td align="left" class="mobile-text-left" style="text-align: left; width: 100%;" valign="">
<a class="no-hover" href="https://%%CountryCode%%.milwaukeetool.eu/" target="_blank"><img alt="Milwaukee" class="no-hover dark-hide" src="https://image.mail.milwaukeetool.eu/lib/fe2f11717564047a761c78/m/1/7bb643b2-1197-4a31-aae6-fd107aec5f3c.gif" style="border: none; display: inline-block; height: auto; outline: none; text-decoration: none;" width="150"><img alt="Milwaukee" class="no-hover dark-swap" src="https://image.s50.sfmc-content.com/lib/fe301171756404787c1679/m/1/23813e44-a2cf-4337-8e45-eb794e970d16.gif" style="border: none; display: none; height: auto; outline: none; text-decoration: none;" width="150"></a>
</td><!--<![endif]-->
<!--[if mso]>
<td class="mobile-text-left" valign="" align="left">
<a href="https://%%CountryCode%%.milwaukeetool.eu/" target="_blank">
<img alt="Milwaukee" src="https://image.s50.sfmc-content.com/lib/fe301171756404787c1679/m/1/64df413e-b0d9-4895-8713-e2b03950c008.png" width="150" style="display: inline-block;">
</a>
</td>
<![endif]-->
<td align="right" class="imp mobile-text-right" style="text-align: right; width: 100%;" valign="">
${badgeHtml}
</td>
</tr>
</table>
<div style="clear: both; display: block; font-size: 10px; height: 10px; line-height: 10px; margin: 0px; mso-line-height-rule: exactly; padding: 0px;">&nbsp;</div>
</td>
<td class="side" style="width: 20px;">&nbsp;</td>
</tr>
</table>
<!-- END .legacy-header -->`;
        }

        function refreshPreview() {
            if (rafId) cancelAnimationFrame(rafId);

            rafId = requestAnimationFrame(() => {
                if (state.isLoading || !state.sdk) return;
                try {
                    const html = generateTemplate();
                    state.sdk.setContent(html);
                    if (typeof state.sdk.setData === 'function') {
                        state.sdk.setData({ ...state.blockData, content: html });
                    }
                } catch (error) {
                    utils.showError(`Preview update failed: ${error.message}`);
                }
            });
        }

        function initializeEventHandlers() {
            state.eventListeners = [];

            // Show Badge selector
            function setupOptionSelector(el, key, callback) {
                if (!el) return;
                el.querySelectorAll('.option-button').forEach(opt => {
                    const handler = (e) => {
                        const btn = e.currentTarget;
                        updateData(key, btn.dataset.value);
                        el.querySelectorAll('.option-button').forEach(o => o.classList.remove('selected'));
                        btn.classList.add('selected');
                        if (callback) callback(btn.dataset.value);
                    };
                    opt.addEventListener('click', handler);
                    state.eventListeners.push({ element: opt, event: 'click', handler });
                });
            }

            setupOptionSelector(elements.showBadgeSelector, 'showBadge', toggleBadgeTypeVisibility);
            setupOptionSelector(elements.showHeaderSelector, 'showHeader', toggleHeaderTextVisibility);

            // Badge Type selector (grid of options)
            if (elements.badgeTypeSelector) {
                elements.badgeTypeSelector.querySelectorAll('.badge-option:not(.category-header)').forEach(opt => {
                    const handler = (e) => {
                        const btn = e.currentTarget;
                        updateData('badgeType', btn.dataset.value);
                        elements.badgeTypeSelector.querySelectorAll('.badge-option').forEach(o => o.classList.remove('selected'));
                        btn.classList.add('selected');
                    };
                    opt.addEventListener('click', handler);
                    state.eventListeners.push({ element: opt, event: 'click', handler });
                });
            }

            // Initialize header text Quill editor
            initializeHeaderEditor();

            // Copy/Paste configuration buttons
            const copyConfigBtn = document.getElementById('copyConfigBtn');
            const pasteConfigBtn = document.getElementById('pasteConfigBtn');

            if (copyConfigBtn) {
                copyConfigBtn.addEventListener('click', () => copyConfiguration());
            }

            if (pasteConfigBtn) {
                pasteConfigBtn.addEventListener('click', () => pasteConfiguration());
            }
        }

        function updateUIFromData() {
            // Update header text editor content
            if (state.editors.headerText) {
                const content = utils.getFieldValue('headerText');
                QuillConfigManager.setContent(state.editors.headerText, content);
            }

            // Update Show Badge selector
            const showBadge = utils.getFieldValue('showBadge');
            elements.showBadgeSelector.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.value === showBadge);
            });
            toggleBadgeTypeVisibility(showBadge);

            // Update Badge Type selector
            const badgeType = utils.getFieldValue('badgeType');
            elements.badgeTypeSelector.querySelectorAll('.badge-option').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.value === badgeType);
            });

            // Update Show Header selector
            const showHeader = utils.getFieldValue('showHeader');
            elements.showHeaderSelector.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.value === showHeader);
            });
            toggleHeaderTextVisibility(showHeader);
        }

        // Copy/Paste Configuration Functions
        function copyConfiguration() {
            const copyBtn = document.getElementById('copyConfigBtn');
            try {
                const configString = JSON.stringify(state.blockData, null, 2);
                navigator.clipboard.writeText(configString).then(() => {
                    copyBtn.classList.add('success');
                    copyBtn.innerHTML = '<svg viewBox="0 0 24 24" width="20" height="20"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
                    setTimeout(() => {
                        copyBtn.classList.remove('success');
                        copyBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
                    }, 2000);
                });
            } catch (error) {
                utils.showError('Failed to copy configuration');
            }
        }

        function pasteConfiguration() {
            const modal = document.getElementById('pasteModal');
            const hint = document.getElementById('pasteModalHint');
            const textarea = document.getElementById('pasteHiddenTextarea');
            const cancelBtn = document.getElementById('pasteModalCancel');

            modal.classList.add('show');
            hint.textContent = 'The block will automatically update with the pasted settings';
            hint.classList.remove('error');
            textarea.value = '';
            textarea.focus();

            const handlePaste = (e) => {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                try {
                    const parsed = JSON.parse(pastedText);
                    Object.keys(moduleConfig.fields).forEach(key => {
                        if (parsed.hasOwnProperty(key)) {
                            state.blockData[key] = parsed[key];
                        }
                    });
                    updateUIFromData();
                    refreshPreview();
                    modal.classList.remove('show');
                    document.removeEventListener('paste', handlePaste);
                } catch (error) {
                    hint.textContent = 'Invalid configuration format. Please copy from another Legacy Header block.';
                    hint.classList.add('error');
                }
            };

            document.addEventListener('paste', handlePaste);

            cancelBtn.onclick = () => {
                modal.classList.remove('show');
                document.removeEventListener('paste', handlePaste);
            };
        }

        async function initializeSDK() {
            return new Promise((resolve, reject) => {
                if (!window.sfdc || !window.sfdc.BlockSDK) {
                    reject(new Error('BlockSDK not available'));
                    return;
                }

                state.sdk = new window.sfdc.BlockSDK({
                    tabs: ['htmlblock']
                });

                state.sdk.getData((data) => {
                    if (data && typeof data === 'object') {
                        Object.keys(moduleConfig.fields).forEach(key => {
                            if (data.hasOwnProperty(key)) {
                                state.blockData[key] = data[key];
                            } else {
                                state.blockData[key] = moduleConfig.fields[key].defaultValue;
                            }
                        });
                    } else {
                        Object.keys(moduleConfig.fields).forEach(key => {
                            state.blockData[key] = moduleConfig.fields[key].defaultValue;
                        });
                    }
                    resolve();
                });
            });
        }

        async function initialize() {
            if (state.isInitialized) return;

            try {
                setLoadingState(true);
                cacheElements();

                await initializeSDK();
                initializeEventHandlers();
                updateUIFromData();
                refreshPreview();

                state.isInitialized = true;
            } catch (error) {
                utils.showError(`Initialization failed: ${error.message}`, true);
                state.retryCount++;
                if (state.retryCount < moduleConfig.maxRetries) {
                    setTimeout(initialize, 1000 * state.retryCount);
                }
            } finally {
                setLoadingState(false);
            }
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
