<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Spacer Block</title>
    <link rel="stylesheet" href="https://cloud.mail.milwaukeetool.eu/customblock-styles">
    <style>
        body{margin:0;padding:10px;font-family:Arial,sans-serif;background-color:white}.container{max-width:800px;margin:0 auto;background:white;padding:20px;transition:opacity 0.3s ease}.container.loading{opacity:0.6;pointer-events:none}.field-group{margin-bottom:20px}.field-label{display:block;margin-bottom:5px;font-weight:bold;color:#333;font-size:14px}.option-selector{display:flex;gap:10px;margin-bottom:15px}.option-button{flex:1;padding:8px;text-align:center;border:2px solid #ddd;border-radius:4px;cursor:pointer;transition:all .2s ease}.option-button:hover{border-color:#0074d9;background-color:#f0f8ff}.option-button.selected{border-color:#0074d9;background-color:#0074d9;color:white}.slider-group{display:flex;align-items:center;gap:15px}.slider-input{flex-grow:1;cursor:pointer}.slider-value{font-size:14px;font-weight:bold;color:#333;background-color:#f0f0f0;padding:4px 8px;border-radius:4px;min-width:50px;text-align:center}.section-divider{margin:30px 0;border-top:2px solid #eee;padding-top:20px}.section-title{font-size:16px;font-weight:bold;color:#333;margin-bottom:15px}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:none;align-items:center;justify-content:center;z-index:9999}.loading-overlay.show{display:flex}.loading-spinner{border:3px solid #f3f3f3;border-top:3px solid #0074d9;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.error-banner{background-color:#fee;border:1px solid #fcc;color:#c00;padding:10px;margin-bottom:20px;border-radius:4px;display:none}.error-banner.show{display:block}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>
    
    <div class="container" id="mainContainer">
        <h2 style="margin-top: 0; color: #333;">Spacer Settings</h2>
        <div class="error-banner" id="errorBanner"></div>
        
        <div class="section-divider" style="margin-top:0; padding-top:0; border-top:none;">
            <div class="section-title">Customisation</div>
            <div class="field-group">
                <label class="field-label">Background Colour</label>
                <div class="option-selector" id="backgroundColorSelector">
                    <div class="option-button" data-value="black">Black</div>
                    <div class="option-button" data-value="red">Red</div>
                </div>
            </div>

            <div class="field-group">
                <label for="spacerHeight" class="field-label">Spacer Height</label>
                <div class="slider-group">
                    <input type="range" id="spacerHeight" class="slider-input" min="8" max="120" step="8">
                    <span id="spacerHeightValue" class="slider-value"></span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cloud.mail.milwaukeetool.eu/customblock-base"></script>
    <script src="https://cloud.mail.milwaukeetool.eu/customblock-blocksdk"></script>
    <script>
        'use strict';

        // --- State and Config ---
        const PRESET_COLORS = {
            BLACK: '#000000',
            RED: '#DB021D'
        };
        const DEFAULTS = {
            backgroundColor: PRESET_COLORS.BLACK,
            spacerHeight: 40
        };
        const state = { 
            sdk: null, 
            dom: null // The single source of truth: our in-memory DOM element
        };
        const elements = {}; // For UI element caching

        const utils = {
            debounce(func, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), wait); }; }
        };

        // --- DOM and Template Functions ---

        /**
         * Creates the initial HTML for a new block.
         */
        function generateInitialTemplate(initialState) {
            const bgColor = initialState.backgroundColor;
            const height = `${initialState.spacerHeight}px`;
            return `<!-- START .fw-spacer --><table align="center" border="0" cellpadding="0" cellspacing="0" class="content-outer" role="presentation" style="background-color: ${bgColor}; width: 620px;">
                <tr>
                    <td>
                        <div style="clear: both; display: block; font-size: ${height}; height: ${height}; line-height: ${height}; margin: 0px; mso-line-height-rule: exactly; padding: 0px;">Â </div>
                    </td>
                </tr>
            </table><!-- END .fw-spacer -->`;
        }

        /**
         * Parses an HTML string into a DOM element.
         */
        function parseToDOM(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            return doc.body.firstChild;
        }

        // --- UI and State Sync Functions ---

        /**
         * Reads the state from the DOM and updates the UI.
         * This correctly handles the browser's RGB color format.
         */
        function updateUIFromDOM() {
            if (!state.dom) return;

            const table = state.dom;
            const div = table.querySelector('div');

            // Get the color from the DOM. It will often be in "rgb(r, g, b)" format.
            const domColor = table.style.backgroundColor;

            // Define the RGB values we expect for our presets.
            const blackRgb = 'rgb(0, 0, 0)';
            const redRgb = 'rgb(219, 2, 29)'; // The RGB equivalent of #DB021D

            // Compare the DOM color to our expected RGB values.
            const isBlack = domColor === blackRgb;
            const isRed = domColor === redRgb;

            // Update the UI based on the correct comparison.
            elements.btnBlack.classList.toggle('selected', isBlack);
            elements.btnRed.classList.toggle('selected', isRed);
            
            const currentHeight = parseInt(div.style.height, 10) || DEFAULTS.spacerHeight;
            elements.spacerHeight.value = currentHeight;
            elements.spacerHeightValue.textContent = `${currentHeight}px`;
        }
        
        // --- SDK Interaction ---

        /**
         * Saves the current state by serializing the DOM to HTML and updating the SDK.
         */
        function updateBlock() {
            if (!state.dom) return;
            
            const newContent = state.dom.outerHTML;
            state.sdk.setContent(newContent);
        }
        const debouncedUpdateBlock = utils.debounce(updateBlock, 250);

        // --- Initialization ---

        function cacheElements() {
            elements.mainContainer = document.getElementById('mainContainer');
            elements.backgroundColorSelector = document.getElementById('backgroundColorSelector');
            elements.spacerHeight = document.getElementById('spacerHeight');
            elements.spacerHeightValue = document.getElementById('spacerHeightValue');
            elements.btnBlack = elements.backgroundColorSelector.querySelector('[data-value="black"]');
            elements.btnRed = elements.backgroundColorSelector.querySelector('[data-value="red"]');
        }

        function initializeEventHandlers() {
            elements.backgroundColorSelector.addEventListener('click', e => {
                const button = e.target.closest('.option-button');
                if (button && state.dom) {
                    const value = button.dataset.value;
                    const newColor = (value === 'red') ? PRESET_COLORS.RED : PRESET_COLORS.BLACK;
                    
                    state.dom.style.backgroundColor = newColor;

                    updateUIFromDOM();
                    updateBlock();
                }
            });
            
            elements.spacerHeight.addEventListener('input', () => {
                if (state.dom) {
                    const newHeight = `${elements.spacerHeight.value}px`;
                    const div = state.dom.querySelector('div');

                    if (div) {
                        div.style.height = newHeight;
                        div.style.lineHeight = newHeight;
                        div.style.fontSize = newHeight;
                    }

                    elements.spacerHeightValue.textContent = newHeight;
                    debouncedUpdateBlock();
                }
            });
        }

        function loadData() {
            state.sdk.getContent((content) => {
                if (content && content.trim() !== '') {
                    state.dom = parseToDOM(content);
                } else {
                    const initialHtml = generateInitialTemplate(DEFAULTS);
                    state.dom = parseToDOM(initialHtml);
                    updateBlock(); 
                }
                
                updateUIFromDOM();
            });
        }

        function initialize() {
            cacheElements();
            
            state.sdk = new window.sfdc.BlockSDK({
                tabs: ['stylingblock', 'htmlblock']
            });
            
            initializeEventHandlers();
            loadData();
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>