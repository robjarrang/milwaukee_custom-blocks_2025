<script>
    'use strict';
    
    const moduleConfig = {
        name: 'Spacer',
        fields: {
            backgroundColor: { type: 'text', defaultValue: 'black' },
            spacerHeight: { type: 'number', defaultValue: 40 }
        },
        debounceDelay: 200 // Shorter delay for responsive slider
    };

    const state = { sdk: null, blockData: {} };
    const elements = {};

    const utils = {
        debounce(func, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), wait); }; },
        getFieldValue(fieldName) { return state.blockData[fieldName] !== undefined ? state.blockData[fieldName] : moduleConfig.fields[fieldName].defaultValue; }
    };

    function cacheElements() {
        elements.mainContainer = document.getElementById('mainContainer');
        elements.loadingOverlay = document.getElementById('loadingOverlay');
        elements.backgroundColorSelector = document.getElementById('backgroundColorSelector');
        elements.spacerHeight = document.getElementById('spacerHeight');
        elements.spacerHeightValue = document.getElementById('spacerHeightValue');
    }

    function setLoadingState(loading) {
        elements.mainContainer.classList.toggle('loading', loading);
        elements.loadingOverlay.classList.toggle('show', loading);
    }

    const updateStateFromUI = utils.debounce(() => {
        state.blockData.backgroundColor = elements.backgroundColorSelector.querySelector('.selected')?.dataset.value || 'black';
        state.blockData.spacerHeight = parseInt(elements.spacerHeight.value, 10);
        refreshPreview();
    }, moduleConfig.debounceDelay);

    function updateUIFromState() {
        const bgColor = utils.getFieldValue('backgroundColor');
        const height = utils.getFieldValue('spacerHeight');
        
        elements.backgroundColorSelector.querySelectorAll('.option-button').forEach(o => {
            o.classList.toggle('selected', o.dataset.value === bgColor);
        });
        elements.spacerHeight.value = height;
        elements.spacerHeightValue.textContent = `${height}px`;
    }

    function generateTemplate() {
        const backgroundColorValue = utils.getFieldValue('backgroundColor');
        const spacerHeightValue = utils.getFieldValue('spacerHeight');
        
        const bgColor = backgroundColorValue === 'red' ? '#DB021D' : '#000000';
        const height = `${spacerHeightValue}px`;

        return `<!-- START .fw-spacer --><table align="center" border="0" cellpadding="0" cellspacing="0" class="content-outer" role="presentation" style="background-color: ${bgColor}; width: 620px;">
            <tr>
                <td>
                    <div style="clear: both; display: block; font-size: ${height}; height: ${height}; line-height: ${height}; margin: 0px; mso-line-height-rule: exactly; padding: 0px;">Â </div>
                </td>
            </tr>
        </table><!-- END .fw-spacer -->`;
    }

    function refreshPreview() {
        try {
            const html = generateTemplate();
            state.sdk.setContent(html);
            state.sdk.setData({ ...state.blockData, content: html });
        } catch (error) {
            console.error(`Preview update failed: ${error.message}`);
        }
    }

    function initializeEventHandlers() {
        elements.backgroundColorSelector.addEventListener('click', e => {
            if (e.target.classList.contains('option-button')) {
                elements.backgroundColorSelector.querySelector('.selected')?.classList.remove('selected');
                e.target.classList.add('selected');
                updateStateFromUI();
            }
        });
        
        elements.spacerHeight.addEventListener('input', () => {
            elements.spacerHeightValue.textContent = `${elements.spacerHeight.value}px`;
            updateStateFromUI();
        });
    }

    function loadData() {
        if (!state.sdk) return console.error('SDK not available');
        setLoadingState(true);
        
        state.sdk.getData((data) => {
            const newBlockData = {};
            Object.keys(moduleConfig.fields).forEach(key => {
                newBlockData[key] = (data && data[key] !== undefined) ? data[key] : moduleConfig.fields[key].defaultValue;
            });
            state.blockData = newBlockData;

            updateUIFromState();
            refreshPreview();
            setLoadingState(false);
        });
    }

    function initialize() {
        try {
            if (!window.sfdc || !window.sfdc.BlockSDK) throw new Error('BlockSDK not loaded');
            
            // *** THIS IS THE MODIFIED LINE ***
            // Pass the 'tabs' array to show the HTML and Block Settings tabs
            state.sdk = new window.sfdc.BlockSDK({
                tabs: ['htmlblock', 'stylingblock']
            });

            cacheElements();
            initializeEventHandlers();
            loadData();
        } catch (error) {
            console.error(`Initialization failed: ${error.message}`);
            setLoadingState(false);
        }
    }

    document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', initialize) : initialize();
</script>