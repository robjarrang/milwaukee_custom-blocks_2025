<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>2 Column Story Block (Corrected)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.css">
    <link rel="stylesheet" href="https://cloud.mail.milwaukeetool.eu/customblock-styles">
    <style>
        body{margin:0;padding:10px;font-family:Arial,sans-serif;background-color:white}.container{max-width:800px;margin:0 auto;background:white;padding:20px;border-radius:8px;;transition:opacity 0.3s ease}.container.loading{opacity:0.6;pointer-events:none}.field-group{margin-bottom:20px}.field-label{display:block;margin-bottom:5px;font-weight:bold;color:#333;font-size:14px}.field-input{width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;transition:border-color 0.3s ease}.field-input:focus{outline:none;border-color:#0074d9;box-shadow:0 0 0 2px rgba(0,116,217,0.2)}.field-input.error{border-color:#ff0000}.field-error{color:#ff0000;font-size:12px;margin-top:4px;display:none}.field-input.error + .field-error{display:block}.checkbox-label{cursor:pointer;user-select:none;font-size:14px;color:#333}.color-selector,.option-selector{display:flex;gap:10px}.color-option,.option-button{flex:1;padding:8px;text-align:center;border:2px solid #ddd;border-radius:4px;cursor:pointer;transition:all .2s ease}.color-option:hover,.option-button:hover{border-color:#0074d9;background-color:#f0f8ff}.color-option.selected,.option-button.selected{border-color:#0074d9;background-color:#0074d9;color:white}.toggle-container{display:flex;align-items:center;gap:10px;margin-bottom:15px}.toggle-switch{position:relative;display:inline-block;width:48px;height:24px}.toggle-switch input{opacity:0;width:0;height:0}.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.3s;border-radius:24px}.toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.3s;border-radius:50%}input:checked + .toggle-slider{background-color:#0074d9}input:checked + .toggle-slider:before{transform:translateX(24px)}.disabled-field{opacity:0.5;pointer-events:none}.quill-container{background:white;border:1px solid #ddd;border-radius:4px}.ql-toolbar{border:none;border-bottom:1px solid #ddd;border-radius:4px 4px 0 0}.ql-container{border:none;border-radius:0 0 4px 4px;font-size:14px}.ql-editor{min-height:60px;padding:12px}.limited-toolbar .ql-toolbar{padding:5px}.limited-toolbar .ql-toolbar button{width:24px;height:24px}.section-divider{margin:30px 0;border-top:2px solid #eee;padding-top:20px}.section-title{font-size:16px;font-weight:bold;color:#333;margin-bottom:15px}.column-wrapper{display:flex;gap:20px;flex-wrap:wrap}.column{flex:1;min-width:300px;background-color:#fafafa;padding:15px;border-radius:6px;border:1px solid #eee}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:none;align-items:center;justify-content:center;z-index:9999}.loading-overlay.show{display:flex}.loading-spinner{border:3px solid #f3f3f3;border-top:3px solid #0074d9;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.error-banner{background-color:#fee;border:1px solid #fcc;color:#c00;padding:10px;margin-bottom:20px;border-radius:4px;display:none}.error-banner.show{display:block}
        .option-button svg { display: block; margin: 0 auto; fill: currentColor; }
        .style-controls-wrapper {display:flex;justify-content:space-between;align-items:center;gap:20px;margin-top:15px;}
        .style-control-group .field-label {margin-bottom:5px;}
        .style-control-group .field-input {width:80px;padding:6px 8px;}
        .style-control-group .option-selector {width:140px;}
        .items-container, .spacers-container {display:flex;flex-direction:column;gap:10px;margin-top:10px;}
        .item {background-color:#fdfdfd;padding:15px;border:1px solid #ddd;border-radius:6px;position:relative;}
        .spacer-item {display:flex;align-items:center;background-color:#fdfdfd;padding:10px;border:1px solid #ddd;border-radius:6px;position:relative;}
        .spacer-content {flex-grow:1;}
        .item-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
        .item-title {font-weight:bold;font-size:15px;margin:0;}
        .spacer-title {font-weight:normal;font-size:14px;color:#333;}
        .item-controls, .spacer-controls {display:flex;gap:8px;margin-left:15px;}
        .item-control-btn, .spacer-control-btn {background:none;border:none;cursor:pointer;padding:5px;font-size:18px;line-height:1;color:#555;transition:color .2s}
        .item-control-btn:hover, .spacer-control-btn:hover {color:#0074d9}
        .item-control-btn:disabled, .spacer-control-btn:disabled {color:#ccc;cursor:not-allowed}
        .btn{display:inline-block;padding:10px 15px;background-color:#0074d9;color:white;text-decoration:none;border-radius:4px;border:none;cursor:pointer;font-size:14px;font-weight:bold;transition:background-color .2s}.btn:hover{background-color:#005a9e}.add-item-btn{margin-top:20px}.checklist-section{display:none}
        .add-spacer-controls { display: flex; gap: 10px; margin-top: 10px; }
        .add-spacer-btn { flex: 1; font-size: 12px; padding: 6px 4px; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>
    
    <div class="container" id="mainContainer">
        <h2 style="margin-top: 0; color: #333;">2 Column Story</h2>
        <div class="error-banner" id="errorBanner"></div>
        <div class="section-divider" style="margin-top:0; padding-top:0; border-top:none;">
            <div class="section-title">General Settings</div>
            <div class="field-group"><label class="field-label">Background Colour</label><div class="color-selector" id="backgroundColorSelector"><div class="color-option" data-value="black">Black</div><div class="color-option" data-value="red">Red</div></div></div>
        </div>

        <div class="column-wrapper">
            <!-- Left Column -->
            <div class="column">
                <div class="section-title" style="margin-top:0;">Left Column</div>
                <div class="field-group"><label for="left_imageUrl" class="field-label">Image URL</label><input type="url" id="left_imageUrl" class="field-input"></div>
                <div class="field-group"><label for="left_imageAlt" class="field-label">Image Alt Text</label><input type="text" id="left_imageAlt" class="field-input"></div>
                <div class="field-group"><label for="left_imageLink" class="field-label">Image Link URL</label><input type="url" id="left_imageLink" class="field-input"></div>
                <div class="section-divider" style="margin:20px 0; padding-top: 15px;"></div>
                <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="left_showSubtitle"><span class="toggle-slider"></span></label><label for="left_showSubtitle" class="checkbox-label">Show Subtitle</label></div>
                <div class="field-group" id="left_subtitleGroup"><label for="left_subtitle" class="field-label">Subtitle</label><input type="text" id="left_subtitle" class="field-input"><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="left_subtitleFontSize" class="field-input" min="12" max="24" step="1"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="left_subtitleAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
                <div class="field-group"><label class="field-label">Title</label><div id="left_titleEditor" class="quill-container limited-toolbar"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="left_titleFontSize" class="field-input" min="16" max="32" step="1"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="left_titleAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
                <div class="field-group"><label class="field-label">Content Type</label><div class="option-selector" id="left_contentTypeSelector"><div class="option-button" data-value="description">Body Copy</div><div class="option-button" data-value="checklist">Checklist</div></div></div>
                <div id="left_descriptionSection"><div class="field-group"><label class="field-label">Description</label><div id="left_descriptionEditor" class="quill-container"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="left_descriptionFontSize" class="field-input" min="12" max="24" step="1"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="left_descriptionAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div></div>
                <div id="left_checklistSection" class="checklist-section"><div class="field-group"><label class="field-label">Checklist Items</label><div id="left_itemsContainer" class="items-container"></div><button id="left_addItemBtn" class="btn add-item-btn">Add New Item</button></div></div>
                <div class="section-divider" style="margin:20px 0; padding: 0; border-color: #e0e0e0;"></div>
                <div class="field-group" style="margin-top:20px;"><label class="field-label" style="font-weight:bold; color:#555;">Vertical Spacers</label><div id="left_spacersContainer" class="spacers-container"></div><div class="add-spacer-controls"><button id="left_addSpacerAllBtn" class="btn add-spacer-btn">Add (All)</button><button id="left_addSpacerMsoBtn" class="btn add-spacer-btn">Add (Outlook)</button><button id="left_addSpacerNotMsoBtn" class="btn add-spacer-btn">Add (Non-Outlook)</button></div></div>
                <div class="section-divider" style="margin:20px 0; padding-top: 15px;"></div>
                <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="left_showButton"><span class="toggle-slider"></span></label><label for="left_showButton" class="checkbox-label">Show Button</label></div>
                <div id="left_buttonFieldsGroup"><div class="field-group"><label for="left_buttonText" class="field-label">Button Text</label><input type="text" id="left_buttonText" class="field-input"></div><div class="field-group"><label for="left_buttonLink" class="field-label">Button Link URL</label><input type="url" id="left_buttonLink" class="field-input"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Button Alignment</label><div class="option-selector" id="left_buttonAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
            </div>
            <!-- Right Column -->
            <div class="column">
                <div class="section-title" style="margin-top:0;">Right Column</div>
                <div class="field-group"><label for="right_imageUrl" class="field-label">Image URL</label><input type="url" id="right_imageUrl" class="field-input"></div>
                <div class="field-group"><label for="right_imageAlt" class="field-label">Image Alt Text</label><input type="text" id="right_imageAlt" class="field-input"></div>
                <div class="field-group"><label for="right_imageLink" class="field-label">Image Link URL</label><input type="url" id="right_imageLink" class="field-input"></div>
                <div class="section-divider" style="margin:20px 0; padding-top: 15px;"></div>
                <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="right_showSubtitle"><span class="toggle-slider"></span></label><label for="right_showSubtitle" class="checkbox-label">Show Subtitle</label></div>
                <div class="field-group" id="right_subtitleGroup"><label for="right_subtitle" class="field-label">Subtitle</label><input type="text" id="right_subtitle" class="field-input"><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="right_subtitleFontSize" class="field-input" min="12" max="24" step="1"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="right_subtitleAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
                <div class="field-group"><label class="field-label">Title</label><div id="right_titleEditor" class="quill-container limited-toolbar"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="right_titleFontSize" class="field-input" min="16" max="32" step="1"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="right_titleAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
                <div class="field-group"><label class="field-label">Content Type</label><div class="option-selector" id="right_contentTypeSelector"><div class="option-button" data-value="description">Body Copy</div><div class="option-button" data-value="checklist">Checklist</div></div></div>
                <div id="right_descriptionSection"><div class="field-group"><label class="field-label">Description</label><div id="right_descriptionEditor" class="quill-container"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="right_descriptionFontSize" class="field-input" min="12" max="24" step="1"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="right_descriptionAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div></div>
                <div id="right_checklistSection" class="checklist-section"><div class="field-group"><label class="field-label">Checklist Items</label><div id="right_itemsContainer" class="items-container"></div><button id="right_addItemBtn" class="btn add-item-btn">Add New Item</button></div></div>
                <div class="section-divider" style="margin:20px 0; padding: 0; border-color: #e0e0e0;"></div>
                <div class="field-group" style="margin-top:20px;"><label class="field-label" style="font-weight:bold; color:#555;">Vertical Spacers</label><div id="right_spacersContainer" class="spacers-container"></div><div class="add-spacer-controls"><button id="right_addSpacerAllBtn" class="btn add-spacer-btn">Add (All)</button><button id="right_addSpacerMsoBtn" class="btn add-spacer-btn">Add (Outlook)</button><button id="right_addSpacerNotMsoBtn" class="btn add-spacer-btn">Add (Non-Outlook)</button></div></div>
                <div class="section-divider" style="margin:20px 0; padding-top: 15px;"></div>
                <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="right_showButton"><span class="toggle-slider"></span></label><label for="right_showButton" class="checkbox-label">Show Button</label></div>
                <div id="right_buttonFieldsGroup"><div class="field-group"><label for="right_buttonText" class="field-label">Button Text</label><input type="text" id="right_buttonText" class="field-input"></div><div class="field-group"><label for="right_buttonLink" class="field-label">Button Link URL</label><input type="url" id="right_buttonLink" class="field-input"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Button Alignment</label><div class="option-selector" id="right_buttonAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
            </div>
        </div>
    </div>
    <template id="itemTemplate"><div class="item"><div class="item-header"><h3 class="item-title">Item</h3><div class="item-controls"><button class="item-control-btn move-up-btn" title="Move Up">▲</button><button class="item-control-btn move-down-btn" title="Move Down">▼</button><button class="item-control-btn remove-btn" title="Remove Item">×</button></div></div><div class="quill-container limited-toolbar"></div></div></template>
    <template id="spacerTemplate"><div class="spacer-item"><div class="spacer-content"><span class="spacer-title">Spacer</span></div><div class="spacer-controls"><button class="spacer-control-btn remove-btn" title="Remove Item">×</button></div></div></template>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>
    <script src="https://cloud.mail.milwaukeetool.eu/customblock-base"></script>
    <script src="https://cloud.mail.milwaukeetool.eu/customblock-blocksdk"></script>
    
    <script>
        'use strict';
        
        // --- CONFIG & STATE ---
        const PRESET_COLORS = { BLACK: '#000000', RED: '#DB021D' };
        const DEFAULTS = {
            backgroundColor: PRESET_COLORS.BLACK,
            column: {
                imageUrl: 'https://placehold.co/280x180/cccccc/333333?text=Image',
                imageAlt: 'Story image',
                imageLink: 'https://www.milwaukeetool.eu/',
                subtitle: { show: true, text: 'SUBTITLE', fontSize: 16, alignment: 'center' },
                title: { html: '<strong>Column Title</strong>', fontSize: 20, alignment: 'center' },
                contentType: 'description',
                description: { html: 'Sed vitae aliquet neque. Integer arcu nulla, dictum id ipsum quis, varius tempor dolor.', fontSize: 16, alignment: 'center' },
                checklist: [],
                spacers: [],
                button: { show: true, text: 'Learn More', link: 'https://www.milwaukeetool.eu/', alignment: 'center' }
            }
        };
        const state = { sdk: null, dom: null, editors: {} };
        const elements = {};
        const COLUMN_KEYS = ['left', 'right'];
        const utils = {
            debounce(func, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), wait); }; },
            sanitizeHtml(h) { return h ? h.replace(/<p><br><\/p>/g, '').replace(/<p>/g, '').replace(/<\/p>/g, '<br>') : ''; }
        };

        // --- TEMPLATING & DOM PARSING ---
        function getElementTemplate(elementType, key, data) {
            switch(elementType) {
                case 'subtitle':
                    const subLineHeight = (data.fontSize || 16) + 12;
                    return `<tr data-element="${key}_subtitle-wrapper">
                                <td class="mobile-text-center" data-element="${key}_subtitle-text" style="color:#ffffff;font-family:'Helvetica Neue LT W05_55 Roman',sans-serif,'Open-Sans';font-size:${data.fontSize}px;font-weight:normal;line-height:${subLineHeight}px;text-align:${data.alignment};">${data.text}</td>
                            </tr>
                            <tr data-element="${key}_subtitle-spacer"><td style="font-size:8px;height:8px;line-height:8px;"> </td></tr>`;
                case 'button':
                    return `<tr data-element="${key}_button-wrapper">
                                <td>
                                    <table align="center" border="0" cellpadding="0" cellspacing="0" class="sect" role="presentation" style="width:100%;">
                                        <tr><td align="${data.alignment}" class="block" valign="top">
                                            <table border="0" cellpadding="0" cellspacing="0" role="presentation" style="background-color:transparent;border:2px solid #ffffff;border-collapse:separate;border-radius:4px !important;">
                                                <tr><td align="center" style="border-radius:4px !important;color:#ffffff;font-size:16px;font-weight:bold;line-height:28px;padding:12px 20px;text-transform:uppercase;">
                                                    <a data-element="${key}_button-link" href="${data.link}" style="color:#ffffff;text-decoration:none;" target="_blank">${data.text}</a>
                                                </td></tr>
                                            </table>
                                        </td></tr>
                                    </table>
                                </td>
                            </tr>`;
            }
            return '';
        }

        function generateInitialTemplate() {
            const generateColumn = (key) => {
                const col = DEFAULTS.column;
                const titleLineHeight = col.title.fontSize + 8;
                const descriptionLineHeight = col.description.fontSize + 8;
                
                return `<td data-element="${key}_column" align="center" class="block" style="width:280px;" valign="top">
                    <table align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:100%;">
                        <tr><td><a data-element="${key}_image-link" href="${col.imageLink}" target="_blank"><img data-element="${key}_image" alt="${col.imageAlt}" src="${col.imageUrl}" width="280" style="border:none;display:block;height:auto;"></a></td></tr>
                        <tr><td align="center" style="padding:12px 0;"><table data-element="${key}_content-table" border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:100%;"><tbody>
                            <tr><td><div style="font-size:12px;height:12px;"> </div></td></tr>
                            ${getElementTemplate('subtitle', key, col.subtitle)}
                            <tr><td data-element="${key}_title-cell" style="text-align:${col.title.alignment};"><h3 data-element="${key}_title-text" style="color:#ffffff;font-family:'Helvetica Neue LT W05_93 Blk E',Arial,sans-serif;font-size:${col.title.fontSize}px;font-weight:bold;line-height:${titleLineHeight}px;margin:0;">${col.title.html}</h3></td></tr>
                            <tr><td><div style="font-size:8px;height:8px;"> </div></td></tr>
                            <tr data-element="${key}_content-container" data-content-type="${col.contentType}"><td style="padding:0;">
                                <table data-element="${key}_description-container" align="left" border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:100%;">
                                    <tr data-element="${key}_description-wrapper"><td data-element="${key}_description-text" class="mobile-text-center" style="color:#ffffff;font-size:${col.description.fontSize}px;line-height:${descriptionLineHeight}px;text-align:${col.description.alignment};">${col.description.html}</td></tr>
                                </table>
                                <table data-element="${key}_checklist-container" align="left" border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:100%; display:none;"></table>
                            </td></tr>
                            <tbody data-element="${key}_spacers-container"></tbody>
                            <tr><td><div style="font-size:20px;height:20px;"> </div></td></tr>
                            ${getElementTemplate('button', key, col.button)}
                        </tbody></table></td></tr>
                    </table></td>`;
            };

            return `<!-- I AM A 2-COL STORY BLOCK -->
                <table data-element="main-table" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="background-color:${DEFAULTS.backgroundColor};width:620px;">
                    <tr><td style="width:20px;"> </td><td align="center" style="width:580px;" valign="top"><table border="0" cellpadding="0" cellspacing="0" role="presentation" style="width:100%;">
                        <tr>${generateColumn('left')}<td style="width:20px;"> </td>${generateColumn('right')}</tr>
                    </table></td><td style="width:20px;"> </td></tr>
                </table>`;
        }

        function parseToDOM(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            return doc.body.firstChild;
        }

        // --- UI & DOM SYNC ---
        function updateUIFromDOM() {
            if (!state.dom) return;
            const mainTable = state.dom.querySelector('[data-element="main-table"]');
            const domColor = mainTable.style.backgroundColor;
            const isRed = domColor === 'rgb(219, 2, 29)' || domColor.toUpperCase() === PRESET_COLORS.RED;
            setSelectorState(elements.backgroundColorSelector, isRed ? 'red' : 'black');

            COLUMN_KEYS.forEach(key => {
                const p = `${key}_`;
                const img = state.dom.querySelector(`[data-element="${p}image"]`), imgLink = state.dom.querySelector(`[data-element="${p}image-link"]`);
                elements[p + 'imageUrl'].value = img ? img.getAttribute('src') : '';
                elements[p + 'imageLink'].value = imgLink ? imgLink.getAttribute('href') : '';
                elements[p + 'imageAlt'].value = img ? img.getAttribute('alt') : '';

                const subWrapper = state.dom.querySelector(`[data-element="${p}subtitle-wrapper"]`), subText = state.dom.querySelector(`[data-element="${p}subtitle-text"]`);
                elements[p + 'showSubtitle'].checked = !!subWrapper;
                elements[p + 'subtitleGroup'].style.display = subWrapper ? 'block' : 'none';
                if(subText) {
                    elements[p + 'subtitle'].value = subText.textContent;
                    elements[p + 'subtitleFontSize'].value = parseInt(subText.style.fontSize, 10);
                    setSelectorState(elements[p + 'subtitleAlignmentSelector'], subText.style.textAlign);
                }

                const titleText = state.dom.querySelector(`[data-element="${p}title-text"]`), titleCell = state.dom.querySelector(`[data-element="${p}title-cell"]`);
                state.editors[p + 'title'].root.innerHTML = titleText ? utils.sanitizeHtml(titleText.innerHTML) : '';
                if(titleText) elements[p + 'titleFontSize'].value = parseInt(titleText.style.fontSize, 10);
                if(titleCell) setSelectorState(elements[p + 'titleAlignmentSelector'], titleCell.style.textAlign);
                
                const contentContainer = state.dom.querySelector(`[data-element="${p}content-container"]`);
                const contentType = contentContainer ? contentContainer.dataset.contentType : 'description';
                setSelectorState(elements[p + 'contentTypeSelector'], contentType);
                elements[p + 'descriptionSection'].style.display = (contentType === 'description') ? 'block' : 'none';
                elements[p + 'checklistSection'].style.display = (contentType === 'checklist') ? 'block' : 'none';
                
                const descText = state.dom.querySelector(`[data-element="${p}description-text"]`);
                if(state.editors[p + 'description']) state.editors[p + 'description'].root.innerHTML = descText ? utils.sanitizeHtml(descText.innerHTML) : '';
                if(descText) {
                    elements[p + 'descriptionFontSize'].value = parseInt(descText.style.fontSize, 10);
                    setSelectorState(elements[p + 'descriptionAlignmentSelector'], descText.style.textAlign);
                }

                const btnWrapper = state.dom.querySelector(`[data-element="${p}button-wrapper"]`), btnLink = state.dom.querySelector(`[data-element="${p}button-link"]`);
                elements[p + 'showButton'].checked = !!btnWrapper;
                elements[p + 'buttonFieldsGroup'].style.display = btnWrapper ? 'block' : 'none';
                if(btnLink) {
                    elements[p + 'buttonText'].value = btnLink.textContent;
                    elements[p + 'buttonLink'].value = btnLink.getAttribute('href');
                    const btnCell = btnLink.closest('td[align]');
                    if(btnCell) setSelectorState(elements[p + 'buttonAlignmentSelector'], btnCell.getAttribute('align'));
                }
            });
        }
        
        function setSelectorState(selector, value) {
            if (!selector) return;
            selector.querySelectorAll('.color-option, .option-button').forEach(o => o.classList.remove('selected'));
            const toSelect = selector.querySelector(`[data-value="${value}"]`);
            if (toSelect) toSelect.classList.add('selected');
        }

        // --- SDK & LIFECYCLE ---
        function updateBlock() { if (!state.dom) return; state.sdk.setContent(state.dom.outerHTML); }
        const debouncedUpdateBlock = utils.debounce(updateBlock, 500);

        function loadData() {
            state.sdk.getContent((content) => {
                if (content && content.includes('<!-- I AM A 2-COL STORY BLOCK -->')) {
                    state.dom = parseToDOM(content);
                } else {
                    state.dom = parseToDOM(generateInitialTemplate());
                    updateBlock();
                }
                updateUIFromDOM();
            });
        }
        
        function initialize() {
            cacheElements();
            initializeEditors();
            state.sdk = new window.sfdc.BlockSDK({ tabs: ['stylingblock', 'htmlblock'] });
            initializeEventHandlers();
            loadData();
        }

        function cacheElements() {
            elements.mainContainer = document.getElementById('mainContainer');
            elements.backgroundColorSelector = document.getElementById('backgroundColorSelector');
            COLUMN_KEYS.forEach(p => {
                const prefix = p + '_';
                const keys = ['imageUrl', 'imageAlt', 'imageLink', 'subtitle', 'subtitleFontSize', 'subtitleAlignmentSelector', 'titleEditor', 'titleFontSize', 'titleAlignmentSelector', 'descriptionEditor', 'descriptionFontSize', 'descriptionAlignmentSelector', 'buttonText', 'buttonLink', 'buttonAlignmentSelector', 'showSubtitle', 'subtitleGroup', 'showButton', 'buttonFieldsGroup', 'contentTypeSelector', 'descriptionSection', 'checklistSection'];
                keys.forEach(k => { elements[prefix + k] = document.getElementById(prefix + k); });
            });
        }

        function initializeEditors() {
            COLUMN_KEYS.forEach(key => {
                const p = key + '_';
                ['title', 'description'].forEach(type => {
                    const editorId = p + type;
                    const editorElement = elements[editorId + 'Editor'];
                    state.editors[editorId] = new Quill(editorElement, { theme: 'snow', modules: { toolbar: type === 'title' ? [['bold']] : [['bold', 'italic', 'link']] } });
                    state.editors[editorId].on('text-change', () => {
                        const targetNode = state.dom.querySelector(`[data-element="${editorId}-text"]`);
                        if (targetNode) targetNode.innerHTML = utils.sanitizeHtml(state.editors[editorId].root.innerHTML);
                        debouncedUpdateBlock();
                    });
                });
            });
        }

        function initializeEventHandlers() {
            elements.backgroundColorSelector.addEventListener('click', e => {
                const btn = e.target.closest('.color-option');
                if (btn && state.dom) {
                    state.dom.style.backgroundColor = btn.dataset.value === 'red' ? PRESET_COLORS.RED : PRESET_COLORS.BLACK;
                    setSelectorState(elements.backgroundColorSelector, btn.dataset.value);
                    updateBlock();
                }
            });

            COLUMN_KEYS.forEach(key => {
                const p = `${key}_`;
                ['imageUrl', 'imageAlt', 'imageLink', 'subtitle', 'buttonText', 'buttonLink'].forEach(type => {
                    elements[p + type].addEventListener('input', e => {
                        if (!state.dom) return;
                        const value = e.target.value;
                        const mappings = {imageUrl: "src", imageAlt: "alt", imageLink: "href", buttonLink: "href"};
                        const targetSelector = `[data-element="${p}${mappings[type] ? 'image' : type}${mappings[type] ? (type === 'imageLink' ? '-link' : '') : '-text'}"]`;
                        const targetNode = state.dom.querySelector(targetSelector);
                        if(targetNode) {
                            if (mappings[type]) targetNode.setAttribute(mappings[type], value);
                            else targetNode.textContent = value;
                            debouncedUpdateBlock();
                        }
                    });
                });

                ['subtitleFontSize', 'titleFontSize', 'descriptionFontSize'].forEach(type => {
                    elements[p + type].addEventListener('input', e => {
                        if (!state.dom) return;
                        const size = e.target.value, elementKey = type.replace('FontSize', '');
                        const targetNode = state.dom.querySelector(`[data-element="${p}${elementKey}-text"]`);
                        if (targetNode) {
                            targetNode.style.fontSize = `${size}px`;
                            targetNode.style.lineHeight = `${parseInt(size, 10) + (elementKey === 'subtitle' ? 12 : 8)}px`;
                            debouncedUpdateBlock();
                        }
                    });
                });
                
                ['subtitleAlignment', 'titleAlignment', 'descriptionAlignment', 'buttonAlignment'].forEach(type => {
                    elements[p + type + 'Selector'].addEventListener('click', e => {
                        const btn = e.target.closest('.option-button');
                        if (btn && state.dom) {
                            const align = btn.dataset.value, elementKey = type.replace('Alignment', '');
                            const targetNode = state.dom.querySelector(`[data-element="${p}${elementKey}-${elementKey === 'title' ? 'cell' : 'text'}"]`) || state.dom.querySelector(`[data-element="${p}${elementKey}-link"]`)?.closest('td[align]');
                            if (targetNode) {
                                if (elementKey === 'button') targetNode.setAttribute('align', align); else targetNode.style.textAlign = align;
                            }
                            setSelectorState(elements[p + type + 'Selector'], align);
                            updateBlock();
                        }
                    });
                });

                // --- TOGGLES ---
                elements[p + 'showSubtitle'].addEventListener('change', e => {
                    if(!state.dom) return;
                    const contentTableBody = state.dom.querySelector(`[data-element="${p}content-table"] > tbody`);
                    const titleRow = state.dom.querySelector(`[data-element="${p}title-cell"]`).parentElement;
                    if (e.target.checked) {
                        const template = getElementTemplate('subtitle', key, DEFAULTS.column.subtitle);
                        const newNodes = parseToDOM(`<table><tbody>${template}</tbody></table>`).querySelector('tbody').children;
                        contentTableBody.insertBefore(newNodes[1], titleRow);
                        contentTableBody.insertBefore(newNodes[0], newNodes[1]);
                    } else {
                        state.dom.querySelector(`[data-element="${p}subtitle-wrapper"]`)?.remove();
                        state.dom.querySelector(`[data-element="${p}subtitle-spacer"]`)?.remove();
                    }
                    updateUIFromDOM(); // Resync UI state
                    updateBlock();
                });
                
                elements[p + 'showButton'].addEventListener('change', e => {
                    if(!state.dom) return;
                    const contentTableBody = state.dom.querySelector(`[data-element="${p}content-table"] > tbody`);
                    if (e.target.checked) {
                        const template = getElementTemplate('button', key, DEFAULTS.column.button);
                        const newButtonNode = parseToDOM(`<table><tbody>${template}</tbody></table>`).querySelector('tr');
                        contentTableBody.appendChild(newButtonNode);
                    } else {
                        state.dom.querySelector(`[data-element="${p}button-wrapper"]`)?.remove();
                    }
                    updateUIFromDOM();
                    updateBlock();
                });

                // --- CONTENT TYPE SWITCHER ---
                elements[p + 'contentTypeSelector'].addEventListener('click', e => {
                    const btn = e.target.closest('.option-button');
                    if (btn && state.dom) {
                        const type = btn.dataset.value;
                        state.dom.querySelector(`[data-element="${p}content-container"]`).dataset.contentType = type;
                        state.dom.querySelector(`[data-element="${p}description-container"]`).style.display = type === 'description' ? '' : 'none';
                        state.dom.querySelector(`[data-element="${p}checklist-container"]`).style.display = type === 'checklist' ? '' : 'none';
                        setSelectorState(elements[p + 'contentTypeSelector'], type);
                        updateUIFromDOM(); // Refresh UI to show/hide sections
                        updateBlock();
                    }
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>