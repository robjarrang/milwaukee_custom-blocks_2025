<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>2 Column Story Block (DOM-Based)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.css">
    <link rel="stylesheet" href="https://cloud.mail.milwaukeetool.eu/customblock-styles">
    <style>
        body{margin:0;padding:10px;font-family:Arial,sans-serif;background-color:white}.container{max-width:800px;margin:0 auto;background:white;padding:20px;border-radius:8px;;transition:opacity 0.3s ease}.container.loading{opacity:0.6;pointer-events:none}.field-group{margin-bottom:20px}.field-label{display:block;margin-bottom:5px;font-weight:bold;color:#333;font-size:14px}.field-input{width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;transition:border-color 0.3s ease}.field-input:focus{outline:none;border-color:#0074d9;box-shadow:0 0 0 2px rgba(0,116,217,0.2)}.field-input.error{border-color:#ff0000}.field-error{color:#ff0000;font-size:12px;margin-top:4px;display:none}.field-input.error + .field-error{display:block}.checkbox-label{cursor:pointer;user-select:none;font-size:14px;color:#333}.color-selector,.option-selector{display:flex;gap:10px}.color-option,.option-button{flex:1;padding:8px;text-align:center;border:2px solid #ddd;border-radius:4px;cursor:pointer;transition:all .2s ease}.color-option:hover,.option-button:hover{border-color:#0074d9;background-color:#f0f8ff}.color-option.selected,.option-button.selected{border-color:#0074d9;background-color:#0074d9;color:white}.toggle-container{display:flex;align-items:center;gap:10px;margin-bottom:15px}.toggle-switch{position:relative;display:inline-block;width:48px;height:24px}.toggle-switch input{opacity:0;width:0;height:0}.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.3s;border-radius:24px}.toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.3s;border-radius:50%}input:checked + .toggle-slider{background-color:#0074d9}input:checked + .toggle-slider:before{transform:translateX(24px)}.disabled-field{opacity:0.5;pointer-events:none}.quill-container{background:white;border:1px solid #ddd;border-radius:4px}.ql-toolbar{border:none;border-bottom:1px solid #ddd;border-radius:4px 4px 0 0}.ql-container{border:none;border-radius:0 0 4px 4px;font-size:14px}.ql-editor{min-height:60px;padding:12px}.limited-toolbar .ql-toolbar{padding:5px}.limited-toolbar .ql-toolbar button{width:24px;height:24px}.section-divider{margin:30px 0;border-top:2px solid #eee;padding-top:20px}.section-title{font-size:16px;font-weight:bold;color:#333;margin-bottom:15px}.column-wrapper{display:flex;gap:20px;flex-wrap:wrap}.column{flex:1;min-width:300px;background-color:#fafafa;padding:15px;border-radius:6px;border:1px solid #eee}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:none;align-items:center;justify-content:center;z-index:9999}.loading-overlay.show{display:flex}.loading-spinner{border:3px solid #f3f3f3;border-top:3px solid #0074d9;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.error-banner{background-color:#fee;border:1px solid #fcc;color:#c00;padding:10px;margin-bottom:20px;border-radius:4px;display:none}.error-banner.show{display:block}
        .option-button svg { display: block; margin: 0 auto; fill: currentColor; }
        .style-controls-wrapper {display:flex;justify-content:space-between;align-items:center;gap:20px;margin-top:15px;}
        .style-control-group .field-label {margin-bottom:5px;}
        .style-control-group .field-input {width:80px;padding:6px 8px;}
        .style-control-group .option-selector {width:140px;}
        .items-container, .spacers-container {display:flex;flex-direction:column;gap:10px;margin-top:10px;}
        .item {background-color:#fdfdfd;padding:15px;border:1px solid #ddd;border-radius:6px;position:relative;}
        .spacer-item {display:flex;align-items:center;background-color:#fdfdfd;padding:10px;border:1px solid #ddd;border-radius:6px;position:relative;}
        .spacer-content {flex-grow:1;}
        .item-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
        .item-title {font-weight:bold;font-size:15px;margin:0;}
        .spacer-title {font-weight:normal;font-size:14px;color:#333;}
        .item-controls, .spacer-controls {display:flex;gap:8px;margin-left:15px;}
        .item-control-btn, .spacer-control-btn {background:none;border:none;cursor:pointer;padding:5px;font-size:18px;line-height:1;color:#555;transition:color .2s}
        .item-control-btn:hover, .spacer-control-btn:hover {color:#0074d9}
        .item-control-btn:disabled, .spacer-control-btn:disabled {color:#ccc;cursor:not-allowed}
        .btn{display:inline-block;padding:10px 15px;background-color:#0074d9;color:white;text-decoration:none;border-radius:4px;border:none;cursor:pointer;font-size:14px;font-weight:bold;transition:background-color .2s}.btn:hover{background-color:#005a9e}.add-item-btn{margin-top:20px}.checklist-section{display:none}
        .add-spacer-controls { display: flex; gap: 10px; margin-top: 10px; }
        .add-spacer-btn { flex: 1; font-size: 12px; padding: 6px 4px; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>
    
    <div class="container" id="mainContainer">
        <h2 style="margin-top: 0; color: #333;">2 Column Story</h2>
        <div class="section-divider" style="margin-top:0; padding-top:0; border-top:none;">
            <div class="section-title">General Settings</div>
            <div class="field-group">
                <label class="field-label">Background Colour</label>
                <div class="option-selector" id="backgroundColorSelector">
                    <div class="option-button" data-value="black">Black</div>
                    <div class="option-button" data-value="red">Red</div>
                </div>
            </div>
        </div>

        <div class="column-wrapper">
            <!-- Left Column UI -->
            <div class="column" data-col-prefix="left_">
                <div class="section-title" style="margin-top:0;">Left Column</div>
                <div class="field-group"><label for="left_imageUrl" class="field-label">Image URL</label><input type="url" id="left_imageUrl" class="field-input"></div>
                <div class="field-group"><label for="left_imageAlt" class="field-label">Image Alt Text</label><input type="text" id="left_imageAlt" class="field-input"></div>
                <div class="field-group"><label for="left_imageLink" class="field-label">Image Link URL</label><input type="url" id="left_imageLink" class="field-input"></div>
                <div class="section-divider" style="margin:20px 0; padding-top: 15px;"></div>
                <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="left_showSubtitle"><span class="toggle-slider"></span></label><label for="left_showSubtitle" class="checkbox-label">Show Subtitle</label></div>
                <div class="field-group" id="left_subtitleGroup"><label for="left_subtitle" class="field-label">Subtitle</label><input type="text" id="left_subtitle" class="field-input"><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="left_subtitleFontSize" class="field-input" min="12" max="24" step="4"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="left_subtitleAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button selected" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
                <div class="field-group"><label class="field-label">Title</label><div id="left_titleEditor" class="quill-container limited-toolbar"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="left_titleFontSize" class="field-input" min="16" max="32" step="4"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="left_titleAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button selected" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
                <div class="field-group"><label class="field-label">Content Type</label><div class="option-selector" id="left_contentTypeSelector"><div class="option-button" data-value="description">Body Copy</div><div class="option-button" data-value="checklist">Checklist</div></div></div>
                <div id="left_descriptionSection"><div class="field-group"><label class="field-label">Description</label><div id="left_descriptionEditor" class="quill-container"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="left_descriptionFontSize" class="field-input" min="12" max="24" step="4"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="left_descriptionAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button selected" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div></div>
                <div id="left_checklistSection" class="checklist-section"><div class="field-group"><label class="field-label">Checklist Items</label><div id="left_itemsContainer" class="items-container"></div><button id="left_addItemBtn" class="btn add-item-btn">Add New Item</button></div></div>
                <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="left_showButton"><span class="toggle-slider"></span></label><label for="left_showButton" class="checkbox-label">Show Button</label></div>
                <div id="left_buttonFieldsGroup"><div class="field-group"><label for="left_buttonText" class="field-label">Button Text</label><input type="text" id="left_buttonText" class="field-input"></div><div class="field-group"><label for="left_buttonLink" class="field-label">Button Link URL</label><input type="url" id="left_buttonLink" class="field-input"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Button Alignment</label><div class="option-selector" id="left_buttonAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button selected" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
            </div>
            <!-- Right Column UI -->
            <div class="column" data-col-prefix="right_">
                <div class="section-title" style="margin-top:0;">Right Column</div>
                <div class="field-group"><label for="right_imageUrl" class="field-label">Image URL</label><input type="url" id="right_imageUrl" class="field-input"></div>
                <div class="field-group"><label for="right_imageAlt" class="field-label">Image Alt Text</label><input type="text" id="right_imageAlt" class="field-input"></div>
                <div class="field-group"><label for="right_imageLink" class="field-label">Image Link URL</label><input type="url" id="right_imageLink" class="field-input"></div>
                <div class="section-divider" style="margin:20px 0; padding-top: 15px;"></div>
                <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="right_showSubtitle"><span class="toggle-slider"></span></label><label for="right_showSubtitle" class="checkbox-label">Show Subtitle</label></div>
                <div class="field-group" id="right_subtitleGroup"><label for="right_subtitle" class="field-label">Subtitle</label><input type="text" id="right_subtitle" class="field-input"><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="right_subtitleFontSize" class="field-input" min="12" max="24" step="4"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="right_subtitleAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button selected" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
                <div class="field-group"><label class="field-label">Title</label><div id="right_titleEditor" class="quill-container limited-toolbar"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="right_titleFontSize" class="field-input" min="16" max="32" step="4"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="right_titleAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button selected" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
                <div class="field-group"><label class="field-label">Content Type</label><div class="option-selector" id="right_contentTypeSelector"><div class="option-button" data-value="description">Body Copy</div><div class="option-button" data-value="checklist">Checklist</div></div></div>
                <div id="right_descriptionSection"><div class="field-group"><label class="field-label">Description</label><div id="right_descriptionEditor" class="quill-container"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="right_descriptionFontSize" class="field-input" min="12" max="24" step="4"></div><div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="right_descriptionAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button selected" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div></div>
                <div id="right_checklistSection" class="checklist-section"><div class="field-group"><label class="field-label">Checklist Items</label><div id="right_itemsContainer" class="items-container"></div><button id="right_addItemBtn" class="btn add-item-btn">Add New Item</button></div></div>
                <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="right_showButton"><span class="toggle-slider"></span></label><label for="right_showButton" class="checkbox-label">Show Button</label></div>
                <div id="right_buttonFieldsGroup"><div class="field-group"><label for="right_buttonText" class="field-label">Button Text</label><input type="text" id="right_buttonText" class="field-input"></div><div class="field-group"><label for="right_buttonLink" class="field-label">Button Link URL</label><input type="url" id="right_buttonLink" class="field-input"></div><div class="style-controls-wrapper"><div class="style-control-group"><label class="field-label">Button Alignment</label><div class="option-selector" id="right_buttonAlignmentSelector"><div class="option-button" data-value="left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button selected" data-value="center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div><div class="option-button" data-value="right"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm6-4h10v-2H10v2zM4 9h16V7H4v2zm6-4h10V3H10v2z"/></svg></div></div></div></div></div>
            </div>
        </div>
    </div>
    <template id="itemTemplate"><div class="item"><div class="item-header"><h3 class="item-title">Item</h3><div class="item-controls"><button class="item-control-btn move-up-btn" title="Move Up">▲</button><button class="item-control-btn move-down-btn" title="Move Down">▼</button><button class="item-control-btn remove-btn" title="Remove Item">×</button></div></div><div class="quill-container limited-toolbar"></div></div></template>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>
    <script src="https://cloud.mail.milwaukeetool.eu/customblock-base"></script>
    <script src="https://cloud.mail.milwaukeetool.eu/customblock-blocksdk"></script>
    <script>
        'use strict';
        
        // --- Config and State ---
        const PRESET_COLORS = { RED: '#DB021D', BLACK: '#000000' };
        const DEFAULTS = {
            backgroundColor: PRESET_COLORS.BLACK,
            left: {
                imageUrl: 'https://image.s11.sfmc-content.com/lib/fe3011737164047e741c71/m/1/dd01584c-1d82-4914-b49b-c564344955d7.png',
                imageAlt: 'Story image',
                imageLink: 'https://www.milwaukeetool.eu/',
                showSubtitle: true, subtitle: 'M12 FHAC16-502X', subtitleFontSize: 16, subtitleAlignment: 'center',
                title: '<b>Left Column Title</b>', titleFontSize: 20, titleAlignment: 'center',
                contentType: 'description', description: 'Sed vitae aliquet neque. Integer arcu nulla, dictum id ipsum quis, varius tempor dolor.', descriptionFontSize: 16, descriptionAlignment: 'center',
                items: [{ text: 'Item 1' }, { text: 'Item 2' }],
                showButton: true, buttonText: 'Learn More', buttonLink: 'https://www.milwaukeetool.eu/', buttonAlignment: 'center'
            },
            right: {
                imageUrl: 'https://image.s11.sfmc-content.com/lib/fe3011737164047e741c71/m/1/dd01584c-1d82-4914-b49b-c564344955d7.png',
                imageAlt: 'Story image',
                imageLink: 'https://www.milwaukeetool.eu/',
                showSubtitle: true, subtitle: 'M12 SIM-0', subtitleFontSize: 16, subtitleAlignment: 'center',
                title: '<b>Right Column Title</b>', titleFontSize: 20, titleAlignment: 'center',
                contentType: 'description', description: 'Sed vitae aliquet neque. Integer arcu nulla, dictum id ipsum quis, varius tempor dolor.', descriptionFontSize: 16, descriptionAlignment: 'center',
                items: [],
                showButton: true, buttonText: 'Find Out More', buttonLink: 'https://www.milwaukeetool.eu/', buttonAlignment: 'center'
            }
        };

        const state = { sdk: null, dom: null, editors: {} };
        const elements = {};
        const COLUMN_PREFIXES = ['left_', 'right_'];
        const utils = {
            debounce(func, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), wait); }; },
            parseStyle(styleString, prop) {
                const regex = new RegExp(`${prop}:\\s*([^;]+)`);
                const match = styleString.match(regex);
                return match ? match[1].trim() : null;
            }
        };

        // --- DOM and Template Generation ---
        function parseToDOM(html) { return new DOMParser().parseFromString(html, 'text/html').body.firstChild; }
        
        function generateColumnHtml(col, d) {
            const isChecklist = d.contentType === 'checklist';
            const itemsHtml = isChecklist ? d.items.map(item => `<tr><td valign="top" style="padding-bottom:8px;width:20px;"><img alt="Checkmark" src="https://image.s50.sfmc-content.com/lib/fe301171756404787c1679/m/1/73ad311a-bf28-4d11-b80d-d0da32b9d2b2.png" style="display:block;height:auto;outline:none;text-decoration:none;" width="20"></td><td valign="top" style="width:12px;padding-bottom:8px;"> </td><td class="mobile-text-left" valign="top" style="color:#ffffff;font-family:'Helvetica-Neue',sans-serif,'Open-Sans';font-size:16px;font-weight:normal;line-height:24px;margin:0;mso-line-height-rule:exactly;text-align:left;padding-bottom:8px;">${item.text}</td></tr>`).join('') : '';
            const contentHtml = isChecklist ? `<tr><td data-type="content-wrapper" style="padding:0;"><table align="left" border="0" cellpadding="0" cellspacing="0" role="presentation" data-type="checklist-table" style="width:100%;">${itemsHtml}</table></td></tr>` : `<tr><td class="mobile-text-center" data-type="description" style="color:#ffffff;font-family:'Helvetica Neue LT W05_55 Roman',sans-serif,'Open-Sans';font-size:${d.descriptionFontSize}px;font-weight:normal;line-height:${d.descriptionFontSize + 8}px;margin:0;mso-line-height-rule:exactly;text-align:${d.descriptionAlignment};mso-hyphenate:none;hyphens:none;">${d.description}</td></tr>`;
            const subtitleHtml = d.showSubtitle ? `<tr><td class="mobile-text-center" data-type="subtitle" style="color:#ffffff;font-family:'Helvetica Neue LT W05_55 Roman',sans-serif,'Open-Sans';font-size:${d.subtitleFontSize}px;font-weight:normal;line-height:${d.subtitleFontSize+12}px;margin:0;mso-line-height-rule:exactly;text-align:${d.subtitleAlignment};mso-hyphenate:none;hyphens:none;">${d.subtitle}</td></tr><tr><td><div style="font-size:8px;height:8px;line-height:8px;"> </div></td></tr>` : `<tr data-type="subtitle-wrapper" style="display:none;"><td data-type="subtitle"></td></tr>`;
            const buttonHtml = d.showButton ? `<tr><td><div style="font-size:20px;height:20px;line-height:20px;"> </div></td></tr><tr><td><table align="${d.buttonAlignment}" border="0" cellpadding="0" cellspacing="0" class="button-2-white" role="presentation" style="background-color:transparent;border:2px solid #ffffff;border-collapse:separate;border-radius:4px !important;"><tr><td align="center" style="border-radius:4px !important;color:#ffffff;font-family:'Helvetica Neue LT W05_55 Roman',sans-serif,'Open-Sans';font-size:16px;font-weight:bold;line-height:28px;padding:12px 20px;text-transform:uppercase;"><a href="${d.buttonLink}" style="color:#ffffff;text-decoration:none;" target="_blank">${d.buttonText}</a></td></tr></table></td></tr>` : `<tr data-type="button-wrapper" style="display:none;"><td></td></tr>`;
            return `<td align="center" class="block" data-column-prefix="${col}" style="width:280px;" valign="top"><table align="center" border="0" cellpadding="0" cellspacing="0" class="sect" role="presentation" style="width:100%;"><tr><td><div><a href="${d.imageLink}" target="_blank"><img align="top" alt="${d.imageAlt}" class="fill" src="${d.imageUrl}" style="border:none;display:block;height:auto;outline:none;text-decoration:none;" width="280"></a></div></td></tr><tr><td align="center" style="padding-bottom:12px;padding-top:12px;"><table border="0" cellpadding="0" cellspacing="0" class="sect" style="width:100%;"><tr><td><div style="font-size:12px;height:12px;line-height:12px;"> </div></td></tr>${subtitleHtml}<tr><td class="mobile-text-center" style="text-align:${d.titleAlignment};"><h3 style="color:#ffffff;font-family:'Helvetica Neue LT W05_93 Blk E',Arial,sans-serif,'Open-Sans';font-size:${d.titleFontSize}px;font-stretch:condensed;font-weight:bold;line-height:${d.titleFontSize+8}px;margin:0;text-transform:uppercase;">${d.title}</h3></td></tr><tr><td><div style="font-size:8px;height:8px;line-height:8px;"> </div></td></tr>${contentHtml}${buttonHtml}</table></td></tr></table></td>`;
        }

        function generateInitialTemplate() {
            const leftHtml = generateColumnHtml('left_', DEFAULTS.left);
            const rightHtml = generateColumnHtml('right_', DEFAULTS.right);
            return `<!-- START .story-2col --><table align="center" border="0" cellpadding="0" cellspacing="0" class="content-outer" role="presentation" style="background-color:${DEFAULTS.backgroundColor};width:620px;"><tr><td class="side" style="width:20px;"> </td><td align="center" class="content-inner" style="width:580px;" valign="top"><table align="center" border="0" cellpadding="0" cellspacing="0" class="sect" role="presentation" style="width:100%;"><tr>${leftHtml}<td class="gap block" style="width:20px;"> </td>${rightHtml}</tr></table></td><td class="side" style="width:20px;"> </td></tr></table><!-- END .story-2col -->`;
        }
        
        // --- UI Sync and Rendering ---
        function getColumnRoot(prefix) { return state.dom.querySelector(`[data-column-prefix="${prefix}"]`); }
        
        function updateUIFromDOM() {
            if (!state.dom) return;
            const mainTable = state.dom.matches('.content-outer') ? state.dom : state.dom.querySelector('.content-outer');
            const domColor = mainTable.style.backgroundColor;
            const redRgb = 'rgb(219, 2, 29)', blackRgb = 'rgb(0, 0, 0)';
            elements.backgroundColorSelector.querySelector('[data-value="red"]').classList.toggle('selected', domColor === PRESET_COLORS.RED.toLowerCase() || domColor === redRgb);
            elements.backgroundColorSelector.querySelector('[data-value="black"]').classList.toggle('selected', domColor === PRESET_COLORS.BLACK || domColor === blackRgb);

            COLUMN_PREFIXES.forEach(prefix => {
                const colRoot = getColumnRoot(prefix);
                if (!colRoot) return;

                const img = colRoot.querySelector('img'), link = colRoot.querySelector('a');
                const subtitleWrapper = colRoot.querySelector('[data-type="subtitle-wrapper"]');
                const subtitle = colRoot.querySelector('[data-type="subtitle"]');
                const title = colRoot.querySelector('h3');
                const description = colRoot.querySelector('[data-type="description"]');
                const checklistTable = colRoot.querySelector('[data-type="checklist-table"]');
                const buttonWrapper = colRoot.querySelector('[data-type="button-wrapper"]');
                const button = colRoot.querySelector('.button-2-white a');
                
                // Image
                document.getElementById(prefix + 'imageUrl').value = img ? img.src : '';
                document.getElementById(prefix + 'imageAlt').value = img ? img.alt : '';
                document.getElementById(prefix + 'imageLink').value = link ? link.href : '';

                // Toggles
                const showSubtitle = subtitleWrapper ? subtitleWrapper.style.display !== 'none' : !!subtitle;
                document.getElementById(prefix + 'showSubtitle').checked = showSubtitle;
                document.getElementById(prefix + 'subtitleGroup').classList.toggle('disabled-field', !showSubtitle);
                
                const showButton = buttonWrapper ? buttonWrapper.style.display !== 'none' : !!button;
                document.getElementById(prefix + 'showButton').checked = showButton;
                document.getElementById(prefix + 'buttonFieldsGroup').classList.toggle('disabled-field', !showButton);

                // Text & Rich Text
                if (subtitle) { document.getElementById(prefix + 'subtitle').value = subtitle.textContent.trim(); }
                if (state.editors[prefix + 'title']) state.editors[prefix + 'title'].root.innerHTML = title ? title.innerHTML : '';
                if (description && state.editors[prefix + 'description']) state.editors[prefix + 'description'].root.innerHTML = description.innerHTML;

                // Font Sizes
                if (subtitle) document.getElementById(prefix + 'subtitleFontSize').value = parseInt(utils.parseStyle(subtitle.style.cssText, 'font-size'), 10) || 16;
                if (title) document.getElementById(prefix + 'titleFontSize').value = parseInt(utils.parseStyle(title.style.cssText, 'font-size'), 10) || 20;
                if (description) document.getElementById(prefix + 'descriptionFontSize').value = parseInt(utils.parseStyle(description.style.cssText, 'font-size'), 10) || 16;
                
                // Alignments
                const setAlignUI = (el, val) => el.querySelectorAll('.option-button').forEach(o => o.classList.toggle('selected', o.dataset.value === val));
                if(subtitle) setAlignUI(document.getElementById(prefix + 'subtitleAlignmentSelector'), subtitle.style.textAlign || 'center');
                if(title) setAlignUI(document.getElementById(prefix + 'titleAlignmentSelector'), title.parentElement.style.textAlign || 'center');
                if(description) setAlignUI(document.getElementById(prefix + 'descriptionAlignmentSelector'), description.style.textAlign || 'center');
                if(button) setAlignUI(document.getElementById(prefix + 'buttonAlignmentSelector'), button.closest('table[align]').getAttribute('align') || 'center');
                
                // Content Type
                const contentType = checklistTable ? 'checklist' : 'description';
                document.getElementById(prefix + 'contentTypeSelector').querySelector(`[data-value="${contentType}"]`).click();
                
                // Button
                if (button) { document.getElementById(prefix + 'buttonText').value = button.textContent; document.getElementById(prefix + 'buttonLink').value = button.href; }
            });
        }
        
        // --- SDK Interaction ---
        function updateBlock() { if (state.dom) state.sdk.setContent(state.dom.outerHTML); }
        const debouncedUpdateBlock = utils.debounce(updateBlock, 500);

        // --- Initialization and Event Handlers ---
        function cacheElements() { /* ... caching is implicit via getElementById ... */ }

        function initializeEditorsAndEvents() {
            COLUMN_PREFIXES.forEach(prefix => {
                // Initialize Quill editors
                state.editors[prefix + 'title'] = new Quill(`#${prefix}titleEditor`, { theme: 'snow', modules: { toolbar: [['bold']] } });
                state.editors[prefix + 'description'] = new Quill(`#${prefix}descriptionEditor`, { theme: 'snow', modules: { toolbar: [['bold', 'italic'], ['link']] } });
                
                // Debounced update handlers for Quill
                const updateTitle = utils.debounce(() => { getColumnRoot(prefix).querySelector('h3').innerHTML = state.editors[prefix+'title'].root.innerHTML; updateBlock(); }, 400);
                const updateDesc = utils.debounce(() => { getColumnRoot(prefix).querySelector('[data-type="description"]').innerHTML = state.editors[prefix+'description'].root.innerHTML; updateBlock(); }, 400);
                state.editors[prefix + 'title'].on('text-change', updateTitle);
                state.editors[prefix + 'description'].on('text-change', updateDesc);
            });
            
            // General background color
            document.getElementById('backgroundColorSelector').addEventListener('click', e => {
                const btn = e.target.closest('.option-button');
                if (btn && state.dom) {
                    const mainTable = state.dom.matches('.content-outer') ? state.dom : state.dom.querySelector('.content-outer');
                    mainTable.style.backgroundColor = btn.dataset.value === 'red' ? PRESET_COLORS.RED : PRESET_COLORS.BLACK;
                    debouncedUpdateBlock();
                }
            });

            // Column-specific event handlers
            document.querySelectorAll('.column').forEach(col => {
                const prefix = col.dataset.colPrefix;
                const getEl = id => document.getElementById(prefix + id);

                // Simple text/url inputs
                ['imageUrl', 'imageAlt', 'imageLink', 'subtitle', 'buttonText', 'buttonLink'].forEach(id => {
                    getEl(id).addEventListener('input', utils.debounce(e => {
                        const colRoot = getColumnRoot(prefix);
                        switch(id) {
                            case 'imageUrl': colRoot.querySelector('img').src = e.target.value; break;
                            case 'imageAlt': colRoot.querySelector('img').alt = e.target.value; break;
                            case 'imageLink': colRoot.querySelector('a').href = e.target.value; break;
                            case 'subtitle': colRoot.querySelector('[data-type="subtitle"]').textContent = e.target.value; break;
                            case 'buttonText': colRoot.querySelector('.button-2-white a').textContent = e.target.value; break;
                            case 'buttonLink': colRoot.querySelector('.button-2-white a').href = e.target.value; break;
                        }
                        updateBlock();
                    }, 400));
                });
                
                // Toggles
                getEl('showSubtitle').addEventListener('change', e => {
                    const el = getColumnRoot(prefix).querySelector('[data-type="subtitle-wrapper"]') || getColumnRoot(prefix).querySelector('[data-type="subtitle"]').parentElement;
                    el.style.display = e.target.checked ? '' : 'none';
                    getEl('subtitleGroup').classList.toggle('disabled-field', !e.target.checked);
                    debouncedUpdateBlock();
                });
                getEl('showButton').addEventListener('change', e => {
                    const el = getColumnRoot(prefix).querySelector('[data-type="button-wrapper"]') || getColumnRoot(prefix).querySelector('.button-2-white').closest('tr');
                    el.style.display = e.target.checked ? '' : 'none';
                    getEl('buttonFieldsGroup').classList.toggle('disabled-field', !e.target.checked);
                    debouncedUpdateBlock();
                });

                // Content Type Switch
                getEl('contentTypeSelector').addEventListener('click', e => {
                    const btn = e.target.closest('.option-button');
                    if (btn) {
                        const type = btn.dataset.value;
                        getEl('descriptionSection').style.display = type === 'description' ? 'block' : 'none';
                        getEl('checklistSection').style.display = type === 'checklist' ? 'block' : 'none';
                        // TODO: Implement DOM swap for content type
                        console.warn('Content type switching in DOM not fully implemented.');
                    }
                });

                // Style controls (Font Size, Alignment)
                const setupStyleControl = (controlId, targetSelector, styleProp, parentSelector = null, isAttr = false) => {
                    getEl(controlId).addEventListener('input', e => {
                        const val = e.target.type === 'number' ? e.target.value + 'px' : e.target.value;
                        const target = getColumnRoot(prefix).querySelector(targetSelector);
                        if(target) {
                           const elToStyle = parentSelector ? target.closest(parentSelector) : target;
                           if (isAttr) elToStyle.setAttribute(styleProp, val); else elToStyle.style[styleProp] = val;
                           if (styleProp === 'fontSize') { // Also update line-height
                                const lh = parseInt(e.target.value, 10) + 8;
                                elToStyle.style.lineHeight = lh + 'px';
                           }
                           debouncedUpdateBlock();
                        }
                    });
                };
                setupStyleControl('subtitleFontSize', '[data-type="subtitle"]', 'fontSize');
                setupStyleControl('titleFontSize', 'h3', 'fontSize');
                setupStyleControl('descriptionFontSize', '[data-type="description"]', 'fontSize');
                
                const setupAlign = (sel, target, parent, attr) => document.getElementById(prefix + sel).addEventListener('click', e => {
                    const btn = e.target.closest('.option-button');
                    if(btn) {
                        const el = getColumnRoot(prefix).querySelector(target);
                        if (el) {
                            const targetEl = parent ? el.closest(parent) : el;
                            if (attr) targetEl.setAttribute(attr, btn.dataset.value); else targetEl.style.textAlign = btn.dataset.value;
                            debouncedUpdateBlock();
                        }
                    }
                });
                setupAlign('subtitleAlignmentSelector', '[data-type="subtitle"]');
                setupAlign('titleAlignmentSelector', 'h3', 'td');
                setupAlign('descriptionAlignmentSelector', '[data-type="description"]');
                setupAlign('buttonAlignmentSelector', '.button-2-white', 'table', 'align');
            });
        }
        
        function loadData() {
            state.sdk.getContent(content => {
                if (content && content.trim() !== '') {
                    state.dom = parseToDOM(content);
                } else {
                    state.dom = parseToDOM(generateInitialTemplate());
                    updateBlock();
                }
                updateUIFromDOM();
            });
        }

        function initialize() {
            cacheElements();
            state.sdk = new window.sfdc.BlockSDK({ tabs: ['stylingblock', 'htmlblock'] });
            initializeEditorsAndEvents();
            loadData();
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>