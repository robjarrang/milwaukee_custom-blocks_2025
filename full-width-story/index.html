<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Full Width Story Block</title>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cloud.mail.milwaukeetool.eu/customblock-styles">
    <style>
        body{margin:0;padding:10px;font-family:Arial,sans-serif;background-color:white}.container{max-width:800px;margin:0 auto;background:white;padding:20px;;transition:opacity 0.3s ease}.container.loading{opacity:0.6;pointer-events:none}
        
        /* Enhanced input fields with floating labels */
        .field-group{position:relative;margin-bottom:24px}
        .field-input{width:100%;padding:20px 12px 8px 12px;border:2px solid #e1e4e8;border-radius:8px;font-size:14px;transition:all 0.2s ease;background:#fafbfc;box-sizing:border-box}
        .field-input:focus{border-color:#0074d9;background:white;box-shadow:0 0 0 3px rgba(0,116,217,0.1);outline:none}
        .field-label{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;color:#586069;pointer-events:none;transition:all 0.2s ease;background:white;padding:0 4px;font-weight:bold}
        .field-input:focus ~ .field-label,.field-input:not(:placeholder-shown) ~ .field-label{top:-8px;font-size:12px;color:#0074d9}
        
        .field-input.error{border-color:#ff0000}.field-error{color:#ff0000;font-size:12px;margin-top:4px;display:none}.field-input.error + .field-error{display:block}
        
        /* Enhanced option selector with micro-interactions */
        .option-selector{display:flex;gap:10px}
        .option-button{flex:1;padding:12px;text-align:center;border:2px solid #e1e4e8;border-radius:8px;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);background:#fafbfc;font-weight:500;position:relative;overflow:hidden}
        .option-button::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);transition:left 0.6s}
        .option-button:hover{border-color:#0074d9;background-color:#f0f8ff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,116,217,0.15)}
        .option-button:hover::before{left:100%}
        .option-button.selected{border-color:#0074d9;background:linear-gradient(135deg,#0074d9,#0366d6);color:white;transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,116,217,0.3)}
        .option-button:active{transform:translateY(0);transition:transform 0.1s}
        .option-button svg{display:block;margin:0 auto;fill:currentColor}
        
        /* Enhanced toggle switch */
        .toggle-container{display:flex;align-items:center;gap:10px;margin-bottom:15px}
        .toggle-switch{position:relative;display:inline-block;width:56px;height:32px}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:linear-gradient(to right,#e1e4e8 0%,#e1e4e8 100%);transition:all 0.3s;border-radius:32px;box-shadow:inset 0 2px 4px rgba(0,0,0,0.1)}
        .toggle-slider:before{position:absolute;content:"";height:26px;width:26px;left:3px;bottom:3px;background-color:white;transition:all 0.3s;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
        input:checked + .toggle-slider{background:linear-gradient(to right,#0074d9 0%,#0366d6 100%)}
        input:checked + .toggle-slider:before{transform:translateX(24px)}
        
        .disabled-field{opacity:0.5;pointer-events:none}
        
        /* Enhanced Quill editor styling */
        .quill-container{background:white;border:2px solid #e1e4e8;border-radius:8px;transition:all 0.2s ease}
        .quill-container:focus-within{border-color:#0074d9;box-shadow:0 0 0 3px rgba(0,116,217,0.1)}
        .ql-toolbar{border:none;border-bottom:1px solid #e1e4e8;border-radius:8px 8px 0 0;background:#fafbfc}
        .ql-container{border:none;border-radius:0 0 8px 8px;font-size:14px}
        .ql-editor{min-height:80px;padding:12px}
        .limited-toolbar .ql-editor{min-height:40px}
        
        .section-divider{margin:30px 0;border-top:2px solid #eee;padding-top:20px}.section-title{font-size:16px;font-weight:bold;color:#333;margin-bottom:15px}
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:none;align-items:center;justify-content:center;z-index:9999}.loading-overlay.show{display:flex}.loading-spinner{border:3px solid #f3f3f3;border-top:3px solid #0074d9;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.error-banner{background-color:#fee;border:1px solid #fcc;color:#c00;padding:10px;margin-bottom:20px;border-radius:4px;display:none}.error-banner.show{display:block}
        
        /* Enhanced style controls */
        .style-controls-wrapper{display:flex;justify-content:space-between;align-items:center;gap:20px;margin-top:15px}
        .style-control-group .field-label{margin-bottom:5px;position:static;transform:none;font-size:14px;color:#24292e;font-weight:600}
        .style-control-group .field-input{width:80px;padding:8px 12px;height:auto}
        .style-control-group .option-selector{width:110px}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
    
    <div class="container" id="mainContainer">
        <h2 style="margin-top: 0; color: #333;">Full Width Story</h2>
        <div class="error-banner" id="errorBanner"></div>
        
        <!-- General Settings -->
        <div class="section-divider" style="margin-top:0; padding-top:0; border-top:none;">
            <div class="section-title">General Settings</div>
            <div class="field-group"><label class="field-label">Background Colour</label><div class="option-selector" id="backgroundColorSelector"><div class="option-button selected" data-value="red">Red</div><div class="option-button" data-value="black">Black</div></div></div>
        </div>

        <!-- Content Settings -->
        <div class="section-divider">
            <div class="section-title">Content Settings</div>
            <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="showTitle" checked><span class="toggle-slider"></span></label><label for="showTitle" class="checkbox-label">Show Title</label></div>
            <div class="field-group" id="titleGroup">
                <label class="field-label">Title</label>
                <div id="titleEditor" class="quill-container limited-toolbar"></div>
                <div class="style-controls-wrapper">
                    <div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="titleFontSize" class="field-input" min="16" max="48" step="4"></div>
                    <div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="titleAlignmentSelector"><div class="option-button selected" data-value="left" title="Align Left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button" data-value="center" title="Align Center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div></div></div>
                </div>
            </div>
            <div class="field-group">
                <label class="field-label">Body Text</label>
                <div id="bodyEditor" class="quill-container"></div>
                <div class="style-controls-wrapper">
                    <div class="style-control-group"><label class="field-label">Font Size</label><input type="number" id="bodyFontSize" class="field-input" min="12" max="28" step="4"></div>
                    <div class="style-control-group"><label class="field-label">Alignment</label><div class="option-selector" id="bodyAlignmentSelector"><div class="option-button selected" data-value="left" title="Align Left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button" data-value="center" title="Align Center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div></div></div>
                </div>
            </div>
        </div>
        
        <!-- Button Settings -->
        <div class="section-divider">
            <div class="section-title">Button Settings</div>
            <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="showButton" checked><span class="toggle-slider"></span></label><label for="showButton" class="checkbox-label">Show Button</label></div>
            <div id="buttonFieldsGroup">
                <div class="field-group"><label for="buttonText" class="field-label">Button Text</label><div id="buttonTextEditor" class="quill-container limited-toolbar"></div></div>
                <div class="field-group"><label for="buttonUrl" class="field-label">Button Link URL</label><input type="url" id="buttonUrl" class="field-input"><div class="field-error" id="buttonUrlError">Please enter a valid URL.</div></div>
                <div class="style-controls-wrapper">
                    <div class="style-control-group"><label class="field-label">Button Alignment</label><div class="option-selector" id="buttonAlignmentSelector"><div class="option-button" data-value="left" title="Align Left"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm0-4h10v-2H4v2zm0-4h16v-2H4v2zM4 5v2h10V5H4z"/></svg></div><div class="option-button selected" data-value="center" title="Align Center"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19h16v-2H4v2zm4-4h8v-2H8v2zm-4-4h16v-2H4v2zm4-4h8V5H8v2z"/></svg></div></div></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script src="https://cloud.mail.milwaukeetool.eu/customblock-base"></script>
    <script src="https://cloud.mail.milwaukeetool.eu/customblock-blocksdk"></script>
    <script>
        'use strict';
        
        const moduleConfig = {
            name: 'Full Width Story',
            fields: {
                backgroundColor: { type: 'text', defaultValue: 'red' },
                showTitle: { type: 'boolean', defaultValue: true },
                title: { type: 'richtext', defaultValue: 'Lorem ipsum dolor sit amet', maxLength: 100 },
                titleFontSize: { type: 'number', defaultValue: 24 },
                titleAlignment: { type: 'text', defaultValue: 'left' },
                bodyText: { type: 'richtext', defaultValue: 'Consectetur elit. Integer fermentum scelerisque urna, at lacinia purus sagittis non. Aenean nisl risus, consequat eu diam sit amet, consectetur pulvinar nisi. Nunc nec est non mi faucibus finibus.', maxLength: 400 },
                bodyFontSize: { type: 'number', defaultValue: 16 },
                bodyAlignment: { type: 'text', defaultValue: 'left' },
                showButton: { type: 'boolean', defaultValue: true },
                buttonText: { type: 'richtext', defaultValue: 'Phasellus a mauris', maxLength: 50 },
                buttonUrl: { type: 'url', defaultValue: 'https://www.milwaukeetool.eu/', validator: 'url' },
                buttonAlignment: { type: 'text', defaultValue: 'center' }
            },
            debounceDelay: 300,
            maxRetries: 3
        };

        const state = { 
            sdk: null, 
            editors: {}, 
            blockData: {}, 
            isLoading: false, 
            isInitialized: false, 
            eventListeners: [], 
            retryCount: 0 
        };
        const elements = {};

        // Advanced memory management
        const editorMetadata = new WeakMap();
        const cleanupRegistry = new FinalizationRegistry((heldValue) => {
            console.log('Cleanup registry triggered for editor:', heldValue);
        });

        const utils = {
            debounce(func, wait) { 
                let timeout; 
                return function(...args) { 
                    const later = () => { 
                        clearTimeout(timeout); 
                        func.apply(this, args); 
                    }; 
                    clearTimeout(timeout); 
                    timeout = setTimeout(later, wait); 
                }; 
            },
            isValidUrl(s) { 
                if (!s || s.trim() === '') return true; 
                try { 
                    const u = new URL(s); 
                    return u.protocol === 'http:' || u.protocol === 'https:'; 
                } catch (_) { 
                    return false; 
                } 
            },
            sanitizeHtml(h) { 
                if (!h) return ''; 
                const t = document.createElement('div'); 
                t.innerHTML = h; 
                t.querySelectorAll('script, style').forEach(e => e.remove()); 
                const a = t.getElementsByTagName('*'); 
                for (let e of a) { 
                    for (let r of e.attributes) { 
                        if (r.name.startsWith('on')) e.removeAttribute(r.name); 
                    } 
                } 
                return t.innerHTML; 
            },
            showError(m, p = false) { 
                if (elements.errorBanner) { 
                    elements.errorBanner.textContent = m; 
                    elements.errorBanner.classList.add('show'); 
                    if (!p) setTimeout(() => elements.errorBanner.classList.remove('show'), 5000); 
                } 
                console.error(`${moduleConfig.name} Error:`, m); 
            },
            getFieldValue(f) { 
                const v = state.blockData[f]; 
                const c = moduleConfig.fields[f]; 
                return (v !== undefined && v !== null) ? (c.type === 'number' ? parseFloat(v) : v) : c.defaultValue; 
            },
            
            createEditor(container, id, content = '', config = {}) {
                // Create editor with memory tracking
                const defaultConfig = { 
                    theme: 'snow', 
                    modules: { 
                        toolbar: [['bold', 'italic'], ['link']], 
                        clipboard: { matchVisual: false } 
                    }, 
                    formats: ['bold', 'italic', 'link'], 
                    placeholder: 'Enter text...' 
                };
                
                const editorConfig = { ...defaultConfig, ...config };
                const editor = new Quill(container, editorConfig);

                // Track editor metadata
                const metadata = {
                    id,
                    created: Date.now(),
                    container,
                    hasContent: Boolean(content && content.trim())
                };
                
                editorMetadata.set(editor, metadata);
                cleanupRegistry.register(editor, id);
                
                // Set content if provided
                if (content && content.trim()) {
                    editor.setContents([]);
                    editor.clipboard.dangerouslyPasteHTML(content);
                }
                
                return editor;
            },
            
            cleanupEditor(id) {
                const editor = state.editors[id];
                if (editor) {
                    // Get metadata before cleanup
                    const metadata = editorMetadata.get(editor);
                    
                    // Clean up event listeners
                    if (editor.off) {
                        editor.off('text-change');
                    }
                    
                    // Log cleanup info
                    console.log('Cleaning up editor:', {
                        id,
                        metadata,
                        hadListeners: Boolean(editor.off)
                    });
                    
                    // Remove from state
                    delete state.editors[id];
                }
            }
        };

        function cacheElements() {
            elements.mainContainer = document.getElementById('mainContainer');
            elements.loadingOverlay = document.getElementById('loadingOverlay');
            elements.errorBanner = document.getElementById('errorBanner');
            elements.backgroundColorSelector = document.getElementById('backgroundColorSelector');
            elements.showTitle = document.getElementById('showTitle');
            elements.titleGroup = document.getElementById('titleGroup');
            elements.titleEditor = document.getElementById('titleEditor');
            elements.titleFontSize = document.getElementById('titleFontSize');
            elements.titleAlignmentSelector = document.getElementById('titleAlignmentSelector');
            elements.bodyEditor = document.getElementById('bodyEditor');
            elements.bodyFontSize = document.getElementById('bodyFontSize');
            elements.bodyAlignmentSelector = document.getElementById('bodyAlignmentSelector');
            elements.showButton = document.getElementById('showButton');
            elements.buttonFieldsGroup = document.getElementById('buttonFieldsGroup');
            elements.buttonTextEditor = document.getElementById('buttonTextEditor');
            elements.buttonUrl = document.getElementById('buttonUrl');
            elements.buttonUrlError = document.getElementById('buttonUrlError');
            elements.buttonAlignmentSelector = document.getElementById('buttonAlignmentSelector');
        }

        function setLoadingState(loading) {
            state.isLoading = loading;
            if (elements.mainContainer && elements.loadingOverlay) {
                elements.mainContainer.classList.toggle('loading', loading);
                elements.loadingOverlay.classList.toggle('show', loading);
            }
        }

        function initializeEditors() {
            if (!window.Quill) throw new Error('Quill library not loaded');
            
            function createEditor(selector, fieldName, placeholder, formats, toolbarOptions) {
                // Create editor with memory management
                const editor = utils.createEditor(selector, fieldName, '', {
                    modules: { 
                        toolbar: toolbarOptions, 
                        clipboard: { matchVisual: false } 
                    },
                    formats: formats,
                    placeholder: placeholder
                });
                
                state.editors[fieldName] = editor;
                
                // Text change events work the same way in Quill 2.0
                const debouncedUpdate = utils.debounce((delta, oldDelta, source) => { 
                    if (source === 'user') {
                        // Use getSemanticHTML() for Quill 2.0
                        const content = editor.getSemanticHTML ? 
                            editor.getSemanticHTML() : 
                            editor.root.innerHTML;
                        updateData(fieldName, utils.sanitizeHtml(content)); 
                    }
                }, moduleConfig.debounceDelay);
                
                editor.on('text-change', debouncedUpdate);
                
                // Length limiting using new API
                editor.on('text-change', () => { 
                    const text = editor.getText(); 
                    const maxLength = moduleConfig.fields[fieldName].maxLength; 
                    if (text.length > maxLength) {
                        const range = editor.getSelection();
                        editor.deleteText(maxLength, text.length - maxLength);
                        if (range) {
                            editor.setSelection(Math.min(range.index, maxLength));
                        }
                    }
                });
            }
            
            try {
                // Updated toolbar configurations for Quill 2.0
                createEditor('#titleEditor', 'title', 'Enter title...', ['script', 'link'], [[{ 'script': 'super' }], ['link']]);
                createEditor('#bodyEditor', 'bodyText', 'Enter body text...', ['bold', 'italic', 'script', 'link'], [['bold', 'italic', { 'script': 'super' }], ['link']]);
                createEditor('#buttonTextEditor', 'buttonText', 'Enter button text...', ['script'], [[{ 'script': 'super' }]]);
            } catch (error) { 
                throw new Error(`Failed to initialize editors: ${error.message}`); 
            }
        }
        
        function processRichText(html) {
            if (!html) return '';
            const temp = document.createElement('div');
            temp.innerHTML = utils.sanitizeHtml(html);
            return temp.innerHTML.replace(/<p>|<\/p>|<br>/g, '');
        }

        function updateData(field, value) {
            if (state.blockData[field] != value) {
                state.blockData[field] = value;
                refreshPreview();
            }
        }
        
        const debouncedUpdateData = utils.debounce(updateData, moduleConfig.debounceDelay);
        let rafId = null;
        function generateTemplate() {
            const backgroundColor = utils.getFieldValue('backgroundColor');
            const bgColorHex = backgroundColor === 'red' ? '#DB021D' : '#000000';
            const showTitle = utils.getFieldValue('showTitle');
            const showButton = utils.getFieldValue('showButton');

            let titleHtml = '';
            if (showTitle) {
                const processedTitle = processRichText(utils.getFieldValue('title'));
                const titleSize = utils.getFieldValue('titleFontSize');
                const titleAlign = utils.getFieldValue('titleAlignment');
                const titleLineHeight = titleSize + 8;
                titleHtml = `<tr><td class="mobile-text-left" style="text-align: ${titleAlign};"><h1 style="color: #ffffff; font-family: 'Helvetica Neue LT W05_93 Blk E', Arial, sans-serif, 'Open-Sans'; font-size: ${titleSize}px; font-weight: bold; line-height: ${titleLineHeight}px; margin: 0; padding-bottom: 0px !important; text-transform: uppercase; mso-hyphenate: none; hyphens: none;">${processedTitle}</h1></td></tr><tr><td><div style="clear: both; display: block; font-size: 8px; height: 8px; line-height: 8px; margin: 0px; mso-line-height-rule: exactly; padding: 0px;"> </div></td></tr>`;
            }

            const processedBody = processRichText(utils.getFieldValue('bodyText'));
            const bodySize = utils.getFieldValue('bodyFontSize');
            const bodyAlign = utils.getFieldValue('bodyAlignment');
            const bodyLineHeight = bodySize + 12;
            const bodyHtml = `<tr><td class="mobile-text-left" style="color: #ffffff; font-family: 'Helvetica Neue LT W05_55 Roman', sans-serif, 'Open-Sans'; font-size: ${bodySize}px; font-weight: normal; line-height: ${bodyLineHeight}px; margin: 0; mso-line-height-rule: exactly; text-align: ${bodyAlign}; mso-hyphenate: none; hyphens: none;">${processedBody}</td></tr>`;
            
            let buttonHtml = '';
            if (showButton) {
                const buttonAlign = utils.getFieldValue('buttonAlignment');
                const buttonUrl = utils.getFieldValue('buttonUrl');
                const processedButtonText = processRichText(utils.getFieldValue('buttonText'));
                const buttonTableStyle = backgroundColor === 'black' ? 
                    `background-color: transparent; border: 2px solid #ffffff; border-collapse: separate; border-radius: 4px !important;` : 
                    `background-color: #000000; border-radius: 4px !important;`;
                buttonHtml = `<tr><td><div style="clear: both; display: block; font-size: 20px; height: 20px; line-height: 20px; margin: 0px; mso-line-height-rule: exactly; padding: 0px;"> </div></td></tr><tr><td><table align="center" border="0" cellpadding="0" cellspacing="0" class="sect" role="presentation" style="width: 100%;"><tr><td align="${buttonAlign}" class="block" style="width: 100%;" valign="middle"><table border="0" cellpadding="0" cellspacing="0" class="button" role="presentation" style="${buttonTableStyle}"><tr><td align="center" style="color: #ffffff; font-family: 'Helvetica Neue LT W05_55 Roman', sans-serif, 'Open-Sans'; font-size: 16px; font-weight: bold; line-height: 28px; mso-line-height-rule: exactly; mso-text-raise: 2px; padding: 12px 20px; text-align: center; text-transform: uppercase; width: 100%; border-radius: 4px !important;"><a href="${buttonUrl}" style="color: #ffffff; text-decoration: none;" target="_blank">${processedButtonText}</a></td></tr></table></td></tr></table></td></tr>`;
            }

            return `<!-- START .fw-lead --><table align="center" border="0" cellpadding="0" cellspacing="0" class="content-outer" role="presentation" style="background-color: ${bgColorHex}; width: 620px;"><tr><td class="side" style="width: 20px;"> </td><td align="center" class="content-inner" style="width: 580px;"><table align="center" border="0" cellpadding="0" cellspacing="0" class="sect" role="presentation" style="width: 100%;"><tr><td align="left" class="block" style="width: 100%;"><table border="0" cellpadding="0" cellspacing="0" class="sect" style="width: 100%;">${!showTitle ? '<tr><td><div style="clear: both; display: block; font-size: 8px; height: 8px; line-height: 8px; margin: 0px; mso-line-height-rule: exactly; padding: 0px;"> </div></td></tr>' : ''}${titleHtml}${bodyHtml}${buttonHtml}<tr><td><div style="clear: both; display: block; font-size: 28px; height: 28px; line-height: 28px; margin: 0px; mso-line-height-rule: exactly; padding: 0px;"> </div></td></tr></table></td></tr></table></td><td class="side" style="width: 20px;"> </td></tr></table><!-- END .fw-lead -->`;
        }

        function refreshPreview() {
            if (rafId) cancelAnimationFrame(rafId);
            
            rafId = requestAnimationFrame(() => {
                if (state.isLoading || !state.sdk) return;
                try { 
                    const html = generateTemplate(); 
                    state.sdk.setContent(html); 
                    if (state.sdk.setData) { 
                        state.sdk.setData({ ...state.blockData, content: html }); 
                    } 
                } catch (error) { 
                    utils.showError(`Preview update failed: ${error.message}`); 
                }
            });
        }

        function initializeEventHandlers() {
            state.eventListeners = [];
            
            function setupOptionSelector(selectorElement, dataKey) { 
                if (!selectorElement) return; 
                selectorElement.querySelectorAll('.option-button').forEach(option => { 
                    const handler = (e) => { 
                        const button = e.currentTarget; 
                        updateData(dataKey, button.dataset.value); 
                        selectorElement.querySelectorAll('.option-button').forEach(o => o.classList.remove('selected')); 
                        button.classList.add('selected'); 
                    }; 
                    option.addEventListener('click', handler); 
                    state.eventListeners.push({ element: option, event: 'click', handler }); 
                }); 
            }
            
            setupOptionSelector(elements.backgroundColorSelector, 'backgroundColor');
            setupOptionSelector(elements.buttonAlignmentSelector, 'buttonAlignment');
            setupOptionSelector(elements.titleAlignmentSelector, 'titleAlignment');
            setupOptionSelector(elements.bodyAlignmentSelector, 'bodyAlignment');

            function setupToggle(toggleElement, groupElement, dataKey) { 
                const handler = (e) => { 
                    const isChecked = e.target.checked; 
                    updateData(dataKey, isChecked); 
                    groupElement.classList.toggle('disabled-field', !isChecked); 
                }; 
                toggleElement.addEventListener('change', handler); 
                state.eventListeners.push({ element: toggleElement, event: 'change', handler }); 
            }
            
            setupToggle(elements.showTitle, elements.titleGroup, 'showTitle');
            setupToggle(elements.showButton, elements.buttonFieldsGroup, 'showButton');

            function setupNumberInput(inputElement, dataKey) { 
                const step = 4; 
                const correctValueOnBlur = (e) => { 
                    const input = e.target; 
                    let value = parseInt(input.value, 10); 
                    const min = parseInt(input.min, 10), max = parseInt(input.max, 10); 
                    if (isNaN(value)) { 
                        value = moduleConfig.fields[dataKey].defaultValue; 
                    } 
                    value = Math.max(min, Math.min(value, max)); 
                    const correctedValue = Math.round(value / step) * step; 
                    input.value = correctedValue; 
                    updateData(dataKey, correctedValue); 
                }; 
                const liveUpdateOnInput = (e) => { 
                    const value = parseInt(e.target.value, 10); 
                    if (!isNaN(value)) { 
                        debouncedUpdateData(dataKey, value); 
                    } 
                }; 
                inputElement.addEventListener('input', liveUpdateOnInput); 
                inputElement.addEventListener('blur', correctValueOnBlur); 
                state.eventListeners.push({ element: inputElement, event: 'input', handler: liveUpdateOnInput }); 
                state.eventListeners.push({ element: inputElement, event: 'blur', handler: correctValueOnBlur }); 
            }
            
            setupNumberInput(elements.titleFontSize, 'titleFontSize');
            setupNumberInput(elements.bodyFontSize, 'bodyFontSize');

            const urlHandler = (e) => { 
                if (utils.isValidUrl(elements.buttonUrl.value)) { 
                    debouncedUpdateData('buttonUrl', e.target.value.trim()); 
                } 
            };
            elements.buttonUrl.addEventListener('input', urlHandler);
            elements.buttonUrl.addEventListener('blur', () => utils.isValidUrl(elements.buttonUrl.value));
            state.eventListeners.push({ element: elements.buttonUrl, event: 'input', handler: urlHandler });
        }

        function loadData() {
            if (!state.sdk || !state.sdk.getData) return utils.showError('SDK not available');
            setLoadingState(true);
            
            state.sdk.getData((data) => {
                try {
                    state.blockData = {};
                    Object.keys(moduleConfig.fields).forEach(key => { 
                        state.blockData[key] = (data && data.hasOwnProperty(key)) ? 
                            (moduleConfig.fields[key].type === 'richtext' ? utils.sanitizeHtml(data[key]) : data[key]) : 
                            moduleConfig.fields[key].defaultValue; 
                    });
                    
                    function setSelectorState(selectorElement, dataKey) { 
                        const value = utils.getFieldValue(dataKey); 
                        if (selectorElement) { 
                            selectorElement.querySelectorAll('.option-button').forEach(o => 
                                o.classList.toggle('selected', o.dataset.value === value)
                            ); 
                        } 
                    }
                    
                    setSelectorState(elements.backgroundColorSelector, 'backgroundColor');
                    setSelectorState(elements.buttonAlignmentSelector, 'buttonAlignment');
                    setSelectorState(elements.titleAlignmentSelector, 'titleAlignment');
                    setSelectorState(elements.bodyAlignmentSelector, 'bodyAlignment');

                    function setToggleState(toggleEl, groupEl, dataKey) { 
                        const isChecked = utils.getFieldValue(dataKey); 
                        toggleEl.checked = isChecked; 
                        groupEl.classList.toggle('disabled-field', !isChecked); 
                    }
                    
                    setToggleState(elements.showTitle, elements.titleGroup, 'showTitle');
                    setToggleState(elements.showButton, elements.buttonFieldsGroup, 'showButton');
                    
                    if (elements.titleFontSize) elements.titleFontSize.value = utils.getFieldValue('titleFontSize');
                    if (elements.bodyFontSize) elements.bodyFontSize.value = utils.getFieldValue('bodyFontSize');
                    if (elements.buttonUrl) elements.buttonUrl.value = utils.getFieldValue('buttonUrl');
                    
                    // Updated for Quill 2.0 - use clipboard.dangerouslyPasteHTML for setting HTML content
                    Object.keys(state.editors).forEach(key => { 
                        if (state.editors[key]) {
                            const content = utils.getFieldValue(key);
                            try {
                                // Clear existing content first
                                state.editors[key].setContents([]);
                                // Use the new clipboard API to paste HTML content
                                if (content && content.trim()) {
                                    state.editors[key].clipboard.dangerouslyPasteHTML(content);
                                }
                            } catch (error) {
                                // Fallback to root innerHTML for compatibility
                                console.warn(`Using fallback method for editor ${key}:`, error);
                                state.editors[key].root.innerHTML = content || '';
                            }
                        }
                    });
                    
                    refreshPreview();
                    state.retryCount = 0;
                } catch (error) {
                    utils.showError(`Failed to load data: ${error.message}`);
                    Object.keys(moduleConfig.fields).forEach(key => { 
                        state.blockData[key] = moduleConfig.fields[key].defaultValue; 
                    });
                    refreshPreview();
                } finally {
                    setLoadingState(false);
                }
            });
        }

        function cleanup() { 
            // Enhanced cleanup with memory management
            Object.keys(state.editors).forEach(editorId => {
                utils.cleanupEditor(editorId);
            });
            
            // Clean up tracked event listeners
            state.eventListeners.forEach(({ element, event, handler }) => { 
                if (element && element.removeEventListener) element.removeEventListener(event, handler); 
            }); 
            state.eventListeners = [];
            
            // Cancel any pending RAF
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
            
            console.log('Full-width story cleanup completed');
        }

        function initializeWithRetry() {
            try {
                if (!window.sfdc || !window.sfdc.BlockSDK) throw new Error('BlockSDK not loaded');
                if (!window.Quill) throw new Error('Quill not loaded');
                
                state.sdk = new window.sfdc.BlockSDK();
                cacheElements();
                initializeEditors();
                initializeEventHandlers();
                loadData();
                
                window.addEventListener('beforeunload', cleanup);
                document.addEventListener('visibilitychange', () => { 
                    if (!document.hidden && state.isInitialized) loadData(); 
                });
                
                state.isInitialized = true;
            } catch (error) {
                utils.showError(`Initialisation failed: ${error.message}`);
                if (state.retryCount < moduleConfig.maxRetries) {
                    state.retryCount++;
                    setTimeout(() => initializeWithRetry(), 1000 * state.retryCount);
                } else {
                    utils.showError('Failed to initialise after multiple attempts. Please refresh.', true);
                }
                setLoadingState(false);
            }
        }

        if (document.readyState === 'loading') { 
            document.addEventListener('DOMContentLoaded', initializeWithRetry); 
        } else { 
            initializeWithRetry(); 
        }
    </script>
</body>
</html>