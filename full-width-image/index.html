<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Full Width Image Block</title>
    <link rel="stylesheet" href="https://cloud.mail.milwaukeetool.eu/custom-block-styles">
    <style>
        body{margin:0;padding:10px;font-family:Arial,sans-serif;background-color:white}.container{max-width:800px;margin:0 auto;background:white;padding:20px;border-radius:8px;transition:opacity 0.3s ease}.container.loading{opacity:0.6;pointer-events:none}.field-group{margin-bottom:20px}.field-label{display:block;margin-bottom:5px;font-weight:bold;color:#333;font-size:14px}.field-input{width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box;transition:border-color 0.3s ease}.field-input:focus{outline:none;border-color:#0074d9;box-shadow:0 0 0 2px rgba(0,116,217,0.2)}.field-input.error{border-color:#ff0000}.field-error{color:#ff0000;font-size:12px;margin-top:4px;display:none}.field-input.error + .field-error{display:block}.option-selector{display:flex;gap:10px}.option-button{flex:1;padding:8px;text-align:center;border:2px solid #ddd;border-radius:4px;cursor:pointer;transition:all .2s ease}.option-button:hover{border-color:#0074d9;background-color:#f0f8ff}.option-button.selected{border-color:#0074d9;background-color:#0074d9;color:white}.toggle-container{display:flex;align-items:center;gap:10px;margin-bottom:15px}.toggle-switch{position:relative;display:inline-block;width:48px;height:24px}.toggle-switch input{opacity:0;width:0;height:0}.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.3s;border-radius:24px}.toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.3s;border-radius:50%}input:checked + .toggle-slider{background-color:#0074d9}input:checked + .toggle-slider:before{transform:translateX(24px)}.section-divider{margin:30px 0;border-top:2px solid #eee;padding-top:20px}.section-title{font-size:16px;font-weight:bold;color:#333;margin-bottom:15px}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:none;align-items:center;justify-content:center;z-index:9999}.loading-overlay.show{display:flex}.loading-spinner{border:3px solid #f3f3f3;border-top:3px solid #0074d9;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.error-banner{background-color:#fee;border:1px solid #fcc;color:#c00;padding:10px;margin-bottom:20px;border-radius:4px;display:none}.error-banner.show{display:block}

        /* Copy/Paste Configuration */
        .config-tools{position:absolute;top:20px;right:20px;display:flex;gap:8px;z-index:100}
        .config-tool-btn{background:none;border:1px solid #ddd;border-radius:4px;padding:8px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;width:36px;height:36px}
        .config-tool-btn:hover{border-color:#0074d9;background-color:#f0f8ff}
        .config-tool-btn svg{width:20px;height:20px;fill:#555}
        .config-tool-btn:hover svg{fill:#0074d9}
        .config-tool-btn.success{background-color:#d4edda;border-color:#28a745}
        .config-tool-btn.success svg{fill:#28a745}
        @keyframes fadeSuccess{0%{opacity:1}100%{opacity:0}}
        .config-tool-btn.fade-out{animation:fadeSuccess 0.5s ease-out forwards}
        .paste-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center}
        .paste-modal.show{display:flex}
        .paste-modal-content{background:white;border-radius:12px;padding:40px;max-width:400px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.3);animation:modalSlideIn 0.3s ease-out;text-align:center}
        @keyframes modalSlideIn{from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}
        .paste-modal-icon{width:64px;height:64px;margin:0 auto 20px;background:#f0f8ff;border-radius:50%;display:flex;align-items:center;justify-content:center}
        .paste-modal-icon svg{width:32px;height:32px;fill:#0074d9}
        .paste-modal-title{font-size:22px;font-weight:bold;color:#333;margin:0 0 12px 0}
        .paste-modal-instructions{color:#666;font-size:15px;line-height:1.5;margin-bottom:24px}
        .paste-modal-hint{background:#f9f9f9;padding:12px;border-radius:6px;color:#888;font-size:13px;margin-bottom:24px;transition:all 0.3s ease}
        .paste-modal-hint.error{background:#fee;border:1px solid #fcc;color:#c00}
        .paste-modal-footer{display:flex;gap:10px;justify-content:center}
        .paste-modal-btn{padding:12px 24px;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:bold;transition:all 0.2s;min-width:100px}
        .paste-modal-btn.primary{background-color:#0074d9;color:white;box-shadow:0 2px 8px rgba(0,116,217,0.3)}
        .paste-modal-btn.primary:hover{background-color:#005a9e;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,116,217,0.4)}
        .paste-modal-btn.secondary{background-color:#f0f0f0;color:#666}
        .paste-modal-btn.secondary:hover{background-color:#e0e0e0}
        .paste-hidden-textarea{position:absolute;left:-9999px;opacity:0}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>

    <div class="container" id="mainContainer">
        <h2 style="margin-top: 0; color: #333;">Full Width Image</h2>
        <div class="error-banner" id="errorBanner"></div>

        <!-- Copy/Paste Tools -->
        <div class="config-tools">
            <button id="copyConfigBtn" class="config-tool-btn" title="Copy block configuration to clipboard">
                <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
            </button>
            <button id="pasteConfigBtn" class="config-tool-btn" title="Paste block configuration from clipboard">
                <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
            </button>
        </div>

        <div class="section-divider" style="margin-top:0; padding-top:0; border-top:none;">
            <div class="section-title">General Settings</div>
            <div class="field-group">
                <label class="field-label">Background Colour</label>
                <div class="option-selector" id="backgroundColorSelector">
                    <div class="option-button" data-value="red">Red</div>
                    <div class="option-button" data-value="black">Black</div>
                </div>
            </div>
        </div>

        <div class="section-divider">
            <div class="section-title">Image Settings</div>
            <div class="field-group">
                <label for="imageUrl" class="field-label">Image URL</label>
                <input type="url" id="imageUrl" class="field-input" placeholder="https://example.com/image.jpg">
                <div class="field-error" id="imageUrlError">Please enter a valid image URL.</div>
            </div>
             <div class="field-group">
                <label for="imageLink" class="field-label">Image Link URL</label>
                <input type="url" id="imageLink" class="field-input" placeholder="https://www.milwaukeetool.eu/">
                <div class="field-error" id="imageLinkError">Please enter a valid URL.</div>
            </div>
            <div class="field-group">
                <label for="imageAlt" class="field-label">Image Alt Text</label>
                <input type="text" id="imageAlt" class="field-input" placeholder="Descriptive text for the image">
            </div>
        </div>

        <!-- Spacing Settings -->
        <div class="section-divider">
            <div class="section-title">Spacing Settings</div>
            <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="showTopSpacer" checked><span class="toggle-slider"></span></label><label for="showTopSpacer" class="checkbox-label">Show Top Spacer</label></div>
            <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="showBottomSpacer" checked><span class="toggle-slider"></span></label><label for="showBottomSpacer" class="checkbox-label">Show Bottom Spacer</label></div>
            <div class="toggle-container"><label class="toggle-switch"><input type="checkbox" id="showSidePadding" checked><span class="toggle-slider"></span></label><label for="showSidePadding" class="checkbox-label">Show Side Padding</label></div>
        </div>
    </div>

    <!-- Paste Modal -->
    <div id="pasteModal" class="paste-modal">
        <div class="paste-modal-content">
            <div class="paste-modal-icon">
                <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
            </div>
            <h3 class="paste-modal-title">Ready to Paste</h3>
            <p class="paste-modal-instructions">Press <strong>Ctrl+V</strong> (or <strong>Cmd+V</strong> on Mac) to paste your copied block configuration.</p>
            <div class="paste-modal-hint" id="pasteModalHint">The block will automatically update with the pasted settings</div>
            <div class="paste-modal-footer">
                <button id="pasteModalCancel" class="paste-modal-btn secondary">Cancel</button>
            </div>
        </div>
    </div>
    <textarea id="pasteHiddenTextarea" class="paste-hidden-textarea"></textarea>

    <script src="https://cloud.mail.milwaukeetool.eu/customblock-base"></script>
    <script src="https://cloud.mail.milwaukeetool.eu/customblock-blocksdk"></script>
    <script>
        'use strict';

        const moduleConfig = {
            name: 'Full Width Image',
            fields: {
                backgroundColor: { type: 'text', defaultValue: 'red' },
                imageUrl: { type: 'url', defaultValue: 'https://image.mail.milwaukeetool.eu/lib/fe2f11717564047a761c78/m/1/f7924b67-2ff3-4899-8dcc-da1a977b16ff.jpg' },
                imageLink: { type: 'url', defaultValue: 'https://www.milwaukeetool.eu/' },
                imageAlt: { type: 'text', defaultValue: 'Promotional Image' },
                showTopSpacer: { type: 'boolean', defaultValue: true },
                showBottomSpacer: { type: 'boolean', defaultValue: true },
                showSidePadding: { type: 'boolean', defaultValue: true }
            },
            debounceDelay: 400
        };

        const state = { sdk: null, blockData: {} };
        const elements = {};
        let rafId = null;

        const utils = {
            debounce(func, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => func.apply(this, a), wait); }; },
            isValidUrl(s) { if (!s || s.trim() === '') return true; try { new URL(s); return true; } catch (_) { return false; } },
            getFieldValue(fieldName) { return state.blockData[fieldName] !== undefined ? state.blockData[fieldName] : moduleConfig.fields[fieldName].defaultValue; }
        };

        function cacheElements() {
            elements.mainContainer = document.getElementById('mainContainer');
            elements.loadingOverlay = document.getElementById('loadingOverlay');
            elements.backgroundColorSelector = document.getElementById('backgroundColorSelector');
            elements.imageUrl = document.getElementById('imageUrl');
            elements.imageLink = document.getElementById('imageLink');
            elements.imageAlt = document.getElementById('imageAlt');
            elements.showTopSpacer = document.getElementById('showTopSpacer');
            elements.showBottomSpacer = document.getElementById('showBottomSpacer');
            elements.showSidePadding = document.getElementById('showSidePadding');
        }

        function setLoadingState(loading) {
            elements.mainContainer.classList.toggle('loading', loading);
            elements.loadingOverlay.classList.toggle('show', loading);
        }

        const updateStateFromUI = utils.debounce(() => {
            state.blockData.backgroundColor = elements.backgroundColorSelector.querySelector('.selected')?.dataset.value || 'red';
            state.blockData.imageUrl = elements.imageUrl.value;
            state.blockData.imageLink = elements.imageLink.value;
            state.blockData.imageAlt = elements.imageAlt.value;
            state.blockData.showTopSpacer = elements.showTopSpacer.checked;
            state.blockData.showBottomSpacer = elements.showBottomSpacer.checked;
            state.blockData.showSidePadding = elements.showSidePadding.checked;
            refreshPreview();
        }, moduleConfig.debounceDelay);

        function updateUIFromState() {
            const bgColor = utils.getFieldValue('backgroundColor');
            elements.backgroundColorSelector.querySelectorAll('.option-button').forEach(o => {
                o.classList.toggle('selected', o.dataset.value === bgColor);
            });
            elements.imageUrl.value = utils.getFieldValue('imageUrl');
            elements.imageLink.value = utils.getFieldValue('imageLink');
            elements.imageAlt.value = utils.getFieldValue('imageAlt');
            elements.showTopSpacer.checked = utils.getFieldValue('showTopSpacer');
            elements.showBottomSpacer.checked = utils.getFieldValue('showBottomSpacer');
            elements.showSidePadding.checked = utils.getFieldValue('showSidePadding');
        }

        function generateTemplate() {
            const backgroundColor = utils.getFieldValue('backgroundColor');
            const imageUrl = utils.getFieldValue('imageUrl');
            const imageLink = utils.getFieldValue('imageLink');
            const imageAlt = utils.getFieldValue('imageAlt');
            const showTopSpacer = utils.getFieldValue('showTopSpacer');
            const showBottomSpacer = utils.getFieldValue('showBottomSpacer');
            const showSidePadding = utils.getFieldValue('showSidePadding');

            const bgColorHex = backgroundColor === 'red' ? '#DB021D' : '#000000';

            if (!imageUrl) {
                return `<table align="center" style="width:620px; background-color:${bgColorHex};"><tr><td style="padding:40px;text-align:center;font-family:Arial,sans-serif;color:#fff;">Please provide an image URL.</td></tr></table>`;
            }

            const topSpacerHtml = showTopSpacer ? 
                '<tr><td style="font-size: 28px; line-height: 28px;">&nbsp;</td></tr>' : 
                '';
            
            const bottomSpacerHtml = showBottomSpacer ? 
                '<tr><td style="font-size: 28px; line-height: 28px;">&nbsp;</td></tr>' : 
                '';

            if (!showSidePadding) {
                // Full width image without side padding - spans full 620px
                return `<!-- START .fw-image --><table align="center" border="0" cellpadding="0" cellspacing="0" class="content-outer" role="presentation" style="background-color: ${bgColorHex}; width: 620px;">
<tr>
<td align="center" class="content-inner" style="width: 100%;" valign="top">
<table align="center" border="0" cellpadding="0" cellspacing="0" class="sect" role="presentation" style="width: 100%;">
${topSpacerHtml}
<tr>
<td align="center" class="block" style="width: 100%;" valign="top">
<a href="${imageLink || '#'}" target="_blank" style="text-decoration: none; color: #000001;">
<img align="top" alt="${imageAlt}" class="fill" src="${imageUrl}" style="border: none; display: block; height: auto; outline: none; text-decoration: none; width: 100%; max-width: 620px;" width="620">
</a>
</td>
</tr>
${bottomSpacerHtml}
</table>
</td>
</tr>
</table><!-- END .fw-image -->`;
            } else {
                // Standard layout with side padding
                return `<!-- START .fw-image --><table align="center" border="0" cellpadding="0" cellspacing="0" class="content-outer" role="presentation" style="background-color: ${bgColorHex}; width: 620px;">
<tr>
<td class="side" style="width: 20px;">&nbsp;</td>
<td align="center" class="content-inner" style="width: 580px;" valign="top">
<table align="center" border="0" cellpadding="0" cellspacing="0" class="sect" role="presentation" style="width: 100%;">
${topSpacerHtml}
<tr>
<td align="center" class="block" style="width: 100%;" valign="top">
<a href="${imageLink || '#'}" target="_blank" style="text-decoration: none; color: #000001;">
<img align="top" alt="${imageAlt}" class="fill" src="${imageUrl}" style="border: none; display: block; height: auto; outline: none; text-decoration: none; width: 100%; max-width: 580px;" width="580">
</a>
</td>
</tr>
${bottomSpacerHtml}
</table>
</td>
<td class="side" style="width: 20px;">&nbsp;</td>
</tr>
</table><!-- END .fw-image -->`;
            }
        }

        function refreshPreview() {
            if (rafId) cancelAnimationFrame(rafId);

            rafId = requestAnimationFrame(() => {
                try {
                    const html = generateTemplate();
                    state.sdk.setContent(html);
                    state.sdk.setData({ ...state.blockData, content: html });
                } catch (error) {
                    console.error(`Preview update failed: ${error.message}`);
                }
            });
        }

        function initializeEventHandlers() {
            elements.mainContainer.addEventListener('input', e => {
                if(e.target.classList.contains('field-input')) {
                    updateStateFromUI();
                }
            });
            elements.backgroundColorSelector.addEventListener('click', e => {
                if (e.target.classList.contains('option-button')) {
                    elements.backgroundColorSelector.querySelector('.selected')?.classList.remove('selected');
                    e.target.classList.add('selected');
                    updateStateFromUI();
                }
            });
            
            // Add spacer toggle handlers
            elements.showTopSpacer.addEventListener('change', updateStateFromUI);
            elements.showBottomSpacer.addEventListener('change', updateStateFromUI);
            elements.showSidePadding.addEventListener('change', updateStateFromUI);

            // Copy/Paste configuration buttons
            const copyConfigBtn = document.getElementById('copyConfigBtn');
            const pasteConfigBtn = document.getElementById('pasteConfigBtn');
            
            if (copyConfigBtn) {
                copyConfigBtn.addEventListener('click', () => copyConfiguration());
            }
            
            if (pasteConfigBtn) {
                pasteConfigBtn.addEventListener('click', () => pasteConfiguration());
            }
        }

        function copyConfiguration() {
            const configData = {
                version: '1.0',
                module: 'full-width-image',
                timestamp: new Date().toISOString(),
                data: {
                    backgroundColor: utils.getFieldValue('backgroundColor'),
                    imageUrl: utils.getFieldValue('imageUrl'),
                    imageLink: utils.getFieldValue('imageLink'),
                    imageAlt: utils.getFieldValue('imageAlt'),
                    showTopSpacer: utils.getFieldValue('showTopSpacer'),
                    showBottomSpacer: utils.getFieldValue('showBottomSpacer'),
                    showSidePadding: utils.getFieldValue('showSidePadding')
                }
            };
            
            const jsonString = JSON.stringify(configData, null, 2);
            const tempTextarea = document.getElementById('tempCopyArea');
            tempTextarea.value = jsonString;
            tempTextarea.select();
            
            try {
                document.execCommand('copy');
                const copyBtn = document.getElementById('copyConfigBtn');
                copyBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
                }, 1500);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
            tempTextarea.value = '';
        }

        function pasteConfiguration() {
            const modal = document.getElementById('pasteModal');
            const hintBox = document.getElementById('pasteHint');
            const tempTextarea = document.getElementById('tempPasteArea');
            
            modal.style.display = 'flex';
            tempTextarea.value = '';
            tempTextarea.focus();
            hintBox.textContent = 'Press Cmd+V (Mac) or Ctrl+V (Windows) to paste';
            hintBox.className = 'paste-hint';
            
            const handlePaste = (e) => {
                setTimeout(() => {
                    try {
                        const pastedData = tempTextarea.value;
                        if (!pastedData.trim()) {
                            hintBox.textContent = 'No data pasted. Please try again.';
                            hintBox.className = 'paste-hint error';
                            return;
                        }
                        
                        const configData = JSON.parse(pastedData);
                        
                        if (!configData.version || !configData.module || !configData.data) {
                            throw new Error('Invalid configuration format');
                        }
                        
                        if (configData.module !== 'full-width-image') {
                            throw new Error(`This configuration is for '${configData.module}' module, not 'full-width-image'`);
                        }
                        
                        const data = configData.data;
                        
                        if (data.backgroundColor !== undefined) utils.setFieldValue('backgroundColor', data.backgroundColor);
                        if (data.imageUrl !== undefined) utils.setFieldValue('imageUrl', data.imageUrl);
                        if (data.imageLink !== undefined) utils.setFieldValue('imageLink', data.imageLink);
                        if (data.imageAlt !== undefined) utils.setFieldValue('imageAlt', data.imageAlt);
                        if (data.showTopSpacer !== undefined) utils.setFieldValue('showTopSpacer', data.showTopSpacer);
                        if (data.showBottomSpacer !== undefined) utils.setFieldValue('showBottomSpacer', data.showBottomSpacer);
                        if (data.showSidePadding !== undefined) utils.setFieldValue('showSidePadding', data.showSidePadding);
                        
                        updateUIFromState();
                        refreshPreview();
                        
                        hintBox.textContent = '✓ Configuration applied successfully!';
                        hintBox.className = 'paste-hint success';
                        
                        const pasteBtn = document.getElementById('pasteConfigBtn');
                        pasteBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
                        setTimeout(() => {
                            pasteBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>';
                            modal.style.display = 'none';
                        }, 1500);
                        
                    } catch (err) {
                        hintBox.textContent = `Error: ${err.message}`;
                        hintBox.className = 'paste-hint error';
                    }
                }, 10);
            };
            
            tempTextarea.addEventListener('paste', handlePaste, { once: true });
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    tempTextarea.removeEventListener('paste', handlePaste);
                }
            };
        }

        function loadData() {
            if (!state.sdk) return console.error('SDK not available');
            setLoadingState(true);

            state.sdk.getData((data) => {
                const newBlockData = {};
                Object.keys(moduleConfig.fields).forEach(key => {
                    newBlockData[key] = (data && data[key] !== undefined) ? data[key] : moduleConfig.fields[key].defaultValue;
                });
                state.blockData = newBlockData;

                updateUIFromState();
                refreshPreview();
                setLoadingState(false);
            });
        }

        function initialize() {
            try {
                if (!window.sfdc || !window.sfdc.BlockSDK) throw new Error('BlockSDK not loaded');
                state.sdk = new window.sfdc.BlockSDK({
                    tabs: ['htmlblock']
                });
                cacheElements();
                initializeEventHandlers();
                loadData();
            } catch (error) {
                console.error(`Initialization failed: ${error.message}`);
                setLoadingState(false);
            }
        }

        document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', initialize) : initialize();
    </script>
</body>
</html>