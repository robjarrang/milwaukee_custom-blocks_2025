<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Full Width Video Block</title>
    
    <!-- Early SFMC handshake to prevent timeout while scripts load -->
    <script>window.parent.postMessage({method:"handShake",origin:window.location.origin},'*');</script>
    
    <!-- Local assets for fastest loading (no external dependencies) -->
    <link rel="stylesheet" href="../shared-assets/customblock-styles.css">
    <style>
        body{margin:0;padding:10px;font-family:Arial,sans-serif;background-color:white}.container{max-width:800px;margin:0 auto;background:white;padding:20px;border-radius:8px;transition:opacity 0.3s ease}.container.loading{opacity:0.6;pointer-events:none}.field-group{margin-bottom:20px}.field-label{display:block;margin-bottom:5px;font-weight:bold;color:#333;font-size:14px}.field-input{width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box}.field-input.error{border-color:#ff0000}.field-input:disabled{background-color:#f5f5f5;color:#666;cursor:not-allowed}.field-error{color:#ff0000;font-size:12px;margin-top:4px;display:none}.field-input.error + .field-error{display:block}.field-hint{font-size:12px;color:#666;margin-top:4px}.section-divider{margin:30px 0;border-top:2px solid #eee;padding-top:20px}.section-title{font-size:16px;font-weight:bold;color:#333;margin-bottom:15px}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:none;align-items:center;justify-content:center;z-index:9999}.loading-overlay.show{display:flex}.loading-spinner{border:3px solid #f3f3f3;border-top:3px solid #0074d9;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.error-banner{background-color:#fee;border:1px solid #fcc;color:#c00;padding:10px;margin-bottom:20px;border-radius:4px;display:none}.error-banner.show{display:block}

        /* Copy/Paste Configuration */
        .config-tools{position:absolute;top:20px;right:20px;display:flex;gap:8px;z-index:100}
        .config-tool-btn{background:none;border:1px solid #ddd;border-radius:4px;padding:8px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;width:36px;height:36px}
        .config-tool-btn:hover{border-color:#0074d9;background-color:#f0f8ff}
        .config-tool-btn svg{width:20px;height:20px;fill:#555}
        .config-tool-btn:hover svg{fill:#0074d9}
        .config-tool-btn.success{background-color:#d4edda;border-color:#28a745}
        .config-tool-btn.success svg{fill:#28a745}
        @keyframes fadeSuccess{0%{opacity:1}100%{opacity:0}}
        .config-tool-btn.fade-out{animation:fadeSuccess 0.5s ease-out forwards}
        .paste-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center}
        .paste-modal.show{display:flex}
        .paste-modal-content{background:white;padding:40px;max-width:400px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.3);animation:modalSlideIn 0.3s ease-out;text-align:center}
        @keyframes modalSlideIn{from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1}}
        .paste-modal-icon{width:64px;height:64px;margin:0 auto 20px;background:#f0f8ff;border-radius:50%;display:flex;align-items:center;justify-content:center}
        .paste-modal-icon svg{width:32px;height:32px;fill:#0074d9}
        .paste-modal-title{font-size:22px;font-weight:bold;color:#333;margin:0 0 12px 0}
        .paste-modal-instructions{color:#666;font-size:15px;line-height:1.5;margin-bottom:24px}
        .paste-modal-hint{background:#f9f9f9;padding:12px;border-radius:6px;color:#888;font-size:13px;margin-bottom:24px;transition:all 0.3s ease}
        .paste-modal-hint.error{background:#fee;border:1px solid #fcc;color:#c00}
        .paste-modal-footer{display:flex;gap:10px;justify-content:center}
        .paste-modal-btn{padding:12px 24px;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:bold;transition:all 0.2s;min-width:100px}
        .paste-modal-btn.primary{background-color:#0074d9;color:white;box-shadow:0 2px 8px rgba(0,116,217,0.3)}
        .paste-modal-btn.primary:hover{background-color:#005a9e;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,116,217,0.4)}
        .paste-modal-btn.secondary{background-color:#f0f0f0;color:#666}
        .paste-modal-btn.secondary:hover{background-color:#e0e0e0}
        .paste-hidden-textarea{position:absolute;left:-9999px;opacity:0}

        /* Info Banner */
        .info-banner{background:#fff3cd;border:1px solid #ffc107;border-left:4px solid #ffc107;color:#856404;padding:16px;margin-bottom:20px;border-radius:4px;display:flex;align-items:flex-start;gap:12px}
        .info-banner-icon{flex-shrink:0;width:24px;height:24px;margin-top:2px}
        .info-banner-icon svg{width:100%;height:100%;fill:#856404}
        .info-banner-content{flex:1}
        .info-banner-title{font-weight:bold;font-size:14px;margin:0 0 6px 0}
        .info-banner-text{font-size:13px;line-height:1.5;margin:0}

        /* Generated URLs display */
        .generated-urls{background:#f9f9f9;border:1px solid #e0e0e0;border-radius:4px;padding:12px;margin-top:10px}
        .generated-url-item{margin-bottom:8px}
        .generated-url-item:last-child{margin-bottom:0}
        .generated-url-label{font-size:11px;color:#666;text-transform:uppercase;font-weight:bold;margin-bottom:2px}
        .generated-url-value{font-size:12px;color:#333;word-break:break-all;font-family:monospace;background:#fff;padding:4px 6px;border-radius:3px;border:1px solid #ddd}
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>

    <div class="container" id="mainContainer">
        <h2 style="margin-top: 0; color: #333;">Full Width Video</h2>
        <div class="error-banner" id="errorBanner"></div>

        <!-- Info Banner -->
        <div class="info-banner">
            <div class="info-banner-icon">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
            </div>
            <div class="info-banner-content">
                <div class="info-banner-title">For Jarrang Development Team Use Only</div>
                <div class="info-banner-text">This module is intended for use by the Jarrang development team only. If you would like to include a video in your email campaign, please contact the Jarrang team who will be happy to assist you with the setup and configuration.</div>
            </div>
        </div>

        <!-- Copy/Paste Tools -->
        <div class="config-tools">
            <button id="copyConfigBtn" class="config-tool-btn" title="Copy block configuration to clipboard">
                <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
            </button>
            <button id="pasteConfigBtn" class="config-tool-btn" title="Paste block configuration from clipboard">
                <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
            </button>
        </div>

        <div class="section-divider" style="margin-top:0; padding-top:0; border-top:none;">
            <div class="section-title">Video Settings</div>
            <div class="field-group">
                <label class="field-label">CDN Root</label>
                <input type="text" class="field-input" id="cdnRoot" value="https://d3k0c4pvx4gwcz.cloudfront.net" disabled>
                <div class="field-hint">The CDN root URL is fixed and cannot be changed.</div>
            </div>
            <div class="field-group">
                <label class="field-label">Video Path</label>
                <input type="text" class="field-input" id="videoPath" placeholder="milwaukee/2025/11/AAThankYouEd">
                <div class="field-hint">Enter the video path (e.g., <code>milwaukee/2025/11/AAThankYouEd</code>). Do not include leading or trailing slashes.</div>
                <div class="field-error" id="videoPathError">Please enter a valid video path.</div>
            </div>
            <div class="generated-urls" id="generatedUrls">
                <div class="generated-url-item">
                    <div class="generated-url-label">HLS URL (iOS/Safari)</div>
                    <div class="generated-url-value" id="hlsUrlPreview">—</div>
                </div>
                <div class="generated-url-item">
                    <div class="generated-url-label">MP4 URL (Other clients)</div>
                    <div class="generated-url-value" id="mp4UrlPreview">—</div>
                </div>
            </div>
        </div>

        <div class="section-divider">
            <div class="section-title">Dimensions</div>
            <div class="field-group">
                <label class="field-label">Video Height (px)</label>
                <input type="number" class="field-input" id="videoHeight" min="100" max="800" step="10" value="350">
                <div class="field-hint">Width is fixed at 620px. Height applies to both video and fallback image.</div>
            </div>
        </div>

        <div class="section-divider">
            <div class="section-title">Fallback Settings</div>
            <p style="font-size:12px; color:#666; margin-top:0; margin-bottom:15px;">These settings apply when video cannot be played (e.g., Outlook, Gmail).</p>
            <div class="field-group">
                <label class="field-label">Fallback Image URL</label>
                <input type="url" class="field-input" id="fallbackImageUrl" placeholder="https://example.com/video-poster.jpg">
                <div class="field-hint">This image is shown as the video poster and as a fallback for non-supporting clients.</div>
                <div class="field-error" id="fallbackImageUrlError">Please enter a valid image URL.</div>
            </div>
            <div class="field-group">
                <label class="field-label">Fallback Link URL</label>
                <input type="url" class="field-input" id="fallbackLinkUrl" placeholder="https://www.milwaukeetool.eu/">
                <div class="field-hint">Where users are taken when they click the fallback image.</div>
                <div class="field-error" id="fallbackLinkUrlError">Please enter a valid link URL.</div>
            </div>
            <div class="field-group">
                <label class="field-label">Fallback Image Alt Text</label>
                <input type="text" class="field-input" id="fallbackAltText" placeholder="Watch our video">
            </div>
        </div>

    </div>

    <!-- Paste Modal -->
    <div id="pasteModal" class="paste-modal">
        <div class="paste-modal-content">
            <div class="paste-modal-icon">
                <svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
            </div>
            <h3 class="paste-modal-title">Ready to Paste</h3>
            <p class="paste-modal-instructions">Press <strong>Ctrl+V</strong> (or <strong>Cmd+V</strong> on Mac) to paste your copied block configuration.</p>
            <div class="paste-modal-hint" id="pasteModalHint">The block will automatically update with the pasted settings</div>
            <div class="paste-modal-footer">
                <button id="pasteModalCancel" class="paste-modal-btn secondary">Cancel</button>
            </div>
        </div>
    </div>
    <textarea id="pasteHiddenTextarea" class="paste-hidden-textarea"></textarea>

    <!-- Local bundle for fastest loading (no external dependencies) -->
    <script src="../shared-assets/customblock-bundle.js"></script>
    <script>
        'use strict';

        const CDN_ROOT = 'https://d3k0c4pvx4gwcz.cloudfront.net';

        const moduleConfig = {
            name: 'Full Width Video',
            fields: {
                videoPath: { type: 'text', defaultValue: 'milwaukee/2025/11/AAThankYouEd' },
                videoHeight: { type: 'number', defaultValue: 350 },
                fallbackImageUrl: { type: 'url', defaultValue: '' },
                fallbackLinkUrl: { type: 'url', defaultValue: 'https://www.milwaukeetool.eu/' },
                fallbackAltText: { type: 'text', defaultValue: 'Watch our video' }
            },
            debounceDelay: 300,
            maxRetries: 3
        };

        const state = { sdk: null, blockData: {}, isLoading: false, isInitialized: false, eventListeners: [], retryCount: 0 };
        const elements = {};
        let rafId = null;

        const utils = {
            debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; },
            isValidUrl(s) { if (!s || s.trim() === '') return true; try { const u = new URL(s); return u.protocol === 'http:' || u.protocol === 'https:'; } catch (e) { return false; } },
            showError(msg, permanent = false) { console.error(msg); if(elements.errorBanner) { elements.errorBanner.textContent = msg; elements.errorBanner.classList.add('show'); if(!permanent) setTimeout(() => elements.errorBanner.classList.remove('show'), 5000); } },
            getFieldValue(f) { const v = state.blockData[f]; const c = moduleConfig.fields[f]; return (v !== undefined && v !== null) ? (c.type === 'number' ? parseFloat(v) : v) : c.defaultValue; },
            addEventListenerTracked(element, event, handler) { element.addEventListener(event, handler); state.eventListeners.push({ element, event, handler }); }
        };

        function cacheElements() {
            elements.mainContainer = document.getElementById('mainContainer');
            elements.loadingOverlay = document.getElementById('loadingOverlay');
            elements.errorBanner = document.getElementById('errorBanner');
            elements.cdnRoot = document.getElementById('cdnRoot');
            elements.videoPath = document.getElementById('videoPath');
            elements.videoPathError = document.getElementById('videoPathError');
            elements.videoHeight = document.getElementById('videoHeight');
            elements.fallbackImageUrl = document.getElementById('fallbackImageUrl');
            elements.fallbackImageUrlError = document.getElementById('fallbackImageUrlError');
            elements.fallbackLinkUrl = document.getElementById('fallbackLinkUrl');
            elements.fallbackLinkUrlError = document.getElementById('fallbackLinkUrlError');
            elements.fallbackAltText = document.getElementById('fallbackAltText');
            elements.hlsUrlPreview = document.getElementById('hlsUrlPreview');
            elements.mp4UrlPreview = document.getElementById('mp4UrlPreview');
        }

        function setLoadingState(loading) {
            state.isLoading = loading;
            elements.mainContainer.classList.toggle('loading', loading);
            elements.loadingOverlay.classList.toggle('show', loading);
        }

        function getVideoUrls(videoPath) {
            const cleanPath = videoPath.replace(/^\/+|\/+$/g, ''); // Remove leading/trailing slashes
            return {
                hlsUrl: `${CDN_ROOT}/${cleanPath}/output/master.m3u8`,
                mp4Url: `${CDN_ROOT}/${cleanPath}/output/video.mp4`
            };
        }

        function updateUrlPreviews() {
            const videoPath = utils.getFieldValue('videoPath');
            if (videoPath && videoPath.trim()) {
                const urls = getVideoUrls(videoPath);
                elements.hlsUrlPreview.textContent = urls.hlsUrl;
                elements.mp4UrlPreview.textContent = urls.mp4Url;
            } else {
                elements.hlsUrlPreview.textContent = '—';
                elements.mp4UrlPreview.textContent = '—';
            }
        }

        function updateData(field, value) {
            if (JSON.stringify(state.blockData[field]) !== JSON.stringify(value)) {
                state.blockData[field] = value;
                updateUrlPreviews();
                refreshPreview();
            }
        }

        const debouncedUpdateData = utils.debounce(updateData, moduleConfig.debounceDelay);

        function generateTemplate() {
            const videoPath = utils.getFieldValue('videoPath');
            const videoHeight = utils.getFieldValue('videoHeight');
            const fallbackImageUrl = utils.getFieldValue('fallbackImageUrl');
            const fallbackLinkUrl = utils.getFieldValue('fallbackLinkUrl');
            const fallbackAltText = utils.getFieldValue('fallbackAltText');

            const urls = getVideoUrls(videoPath);
            const hlsUrl = urls.hlsUrl;
            const mp4Url = urls.mp4Url;

            return `<!-- START .fw-video --><table align="center" border="0" cellpadding="0" cellspacing="0" class="content-outer" role="presentation" style="background-color: #DB011C; width: 620px;">
 
  <tr>
   <td align="center" class="content-inner" style="width: 580px;" valign="top">
    <table align="center" border="0" cellpadding="0" cellspacing="0" class="sect" role="presentation" style="width: 100%;">
     
      <tr>
       <td align="center" class="block" style="width: 100%;" valign="top">
        <!-- JARRANG VIDEO IN EMAIL --><!--[if !mso]--><style type="text/css">
@media (-webkit-video-playable-inline),(-webkit-min-device-pixel-ratio: 0) {
.video-other {
display: block !important;
}
.video-fallback {
display: none !important;
}
}
_:-webkit-full-screen,
_::-webkit-full-page-media,
_:future,
:root body:not(.Singleton) .video-other {
display: none !important;
}
_:-webkit-full-screen,
_::-webkit-full-page-media,
_:future,
:root body:not(.Singleton) .video-fallback {
display: block !important;
}
@supports (-webkit-overflow-scrolling:touch) and (color:#ffff) {
.video div.video-fallback, div.video-fallback img {
display: none !important;
}
.video-ios {
display: block !important;
}
.video-other {
display: none !important;
}
}
[class~="x_video-other"]{
display: none!important;
}
[class~="x_video-fallback"]{
display: block!important;
}        </style><style type="text/css">
.video-other\\0 {
display: none !important;
}
.video-fallback\\0 {
display: block !important;
}        </style><div class="video" style="width: 100%; display: block; overflow: hidden;">
         <div class="video-ios" height="${videoHeight}" style="display: none; max-height: ${videoHeight}px;">
          <video align="center" class="fill" controls="true" height="${videoHeight}" loop="true" playsinline="true" poster="${fallbackImageUrl}" style="text-align:center; padding: 0; margin: 0; height: auto;" width="620">
           <source align="center" src="${hlsUrl}" type="application/x-mpegURL"> <source align="center" src="${mp4Url}" type="video/mp4"> <!-- Fallback --> <a href="${fallbackLinkUrl}" target="_blank"> <img class="fill" height="${videoHeight}" src="${fallbackImageUrl}" style="border: none; display: block; height: auto; outline: none; text-decoration: none;" width="620"> </a></video></div><div class="video-other" style="display: none; max-height: ${videoHeight}px;">
          <video align="center" autoplay="true" class="fill" controls="true" height="${videoHeight}" loop="true" muted="true" playsinline="true" poster="${fallbackImageUrl}" style="text-align:center; padding: 0; margin: 0; height: auto;" width="620">
           <source align="center" src="${hlsUrl}" type="application/x-mpegURL"> <source align="center" src="${mp4Url}" type="video/mp4"> <!-- Fallback --> <a href="${fallbackLinkUrl}" target="_blank"> <img class="fill" height="${videoHeight}" src="${fallbackImageUrl}" style="border: none; display: block; height: auto; outline: none; text-decoration: none;" width="620"> </a></video></div><div class="video-fallback" style="display: block;">
          <!--[endif]--><a href="${fallbackLinkUrl}" target="_blank"><img alt="${fallbackAltText}" class="fill" height="${videoHeight}" src="${fallbackImageUrl}" style="border: none; display: block; height: auto; outline: none; text-decoration: none;" width="620"> </a> <!--[if !mso]--></div></div><!--[endif]--><!-- END VIDEO IN EMAIL --></td></tr></table></td></tr></table><!-- END .fw-video -->`;
        }

        function refreshPreview() {
            if (rafId) cancelAnimationFrame(rafId);
            rafId = requestAnimationFrame(() => {
                if (state.isLoading || !state.sdk) return;
                try {
                    const html = generateTemplate();
                    state.sdk.setContent(html);
                    if (state.sdk.setData) {
                        state.sdk.setData({ ...state.blockData, content: html });
                    }
                } catch (error) {
                    utils.showError(`Preview update failed: ${error.message}`);
                }
            });
        }

        function updateUIFromData() {
            elements.videoPath.value = utils.getFieldValue('videoPath');
            elements.videoHeight.value = utils.getFieldValue('videoHeight');
            elements.fallbackImageUrl.value = utils.getFieldValue('fallbackImageUrl');
            elements.fallbackLinkUrl.value = utils.getFieldValue('fallbackLinkUrl');
            elements.fallbackAltText.value = utils.getFieldValue('fallbackAltText');
            updateUrlPreviews();
        }

        function initializeEventHandlers() {
            // Video path input
            utils.addEventListenerTracked(elements.videoPath, 'input', (e) => {
                const value = e.target.value;
                debouncedUpdateData('videoPath', value);
            });

            // Video height input
            utils.addEventListenerTracked(elements.videoHeight, 'input', (e) => {
                let value = parseInt(e.target.value, 10);
                if (!isNaN(value)) {
                    value = Math.max(100, Math.min(value, 800));
                    debouncedUpdateData('videoHeight', value);
                }
            });

            utils.addEventListenerTracked(elements.videoHeight, 'blur', (e) => {
                let value = parseInt(e.target.value, 10);
                if (isNaN(value)) value = 350;
                value = Math.max(100, Math.min(value, 800));
                // Snap to nearest 10
                value = Math.round(value / 10) * 10;
                e.target.value = value;
                updateData('videoHeight', value);
            });

            // Fallback image URL input
            utils.addEventListenerTracked(elements.fallbackImageUrl, 'input', (e) => {
                const value = e.target.value;
                const isValid = utils.isValidUrl(value);
                e.target.classList.toggle('error', !isValid);
                elements.fallbackImageUrlError.style.display = isValid ? 'none' : 'block';
                if (isValid) debouncedUpdateData('fallbackImageUrl', value);
            });

            // Fallback link URL input
            utils.addEventListenerTracked(elements.fallbackLinkUrl, 'input', (e) => {
                const value = e.target.value;
                const isValid = utils.isValidUrl(value);
                e.target.classList.toggle('error', !isValid);
                elements.fallbackLinkUrlError.style.display = isValid ? 'none' : 'block';
                if (isValid) debouncedUpdateData('fallbackLinkUrl', value);
            });

            // Fallback alt text input
            utils.addEventListenerTracked(elements.fallbackAltText, 'input', (e) => {
                debouncedUpdateData('fallbackAltText', e.target.value);
            });

            // Copy/Paste configuration buttons
            const copyConfigBtn = document.getElementById('copyConfigBtn');
            const pasteConfigBtn = document.getElementById('pasteConfigBtn');
            
            if (copyConfigBtn) {
                utils.addEventListenerTracked(copyConfigBtn, 'click', () => copyConfiguration());
            }
            
            if (pasteConfigBtn) {
                utils.addEventListenerTracked(pasteConfigBtn, 'click', () => pasteConfiguration());
            }
        }

        function copyConfiguration() {
            const configData = {
                version: '1.0',
                module: moduleConfig.name,
                timestamp: new Date().toISOString(),
                data: state.blockData
            };
            
            const copyBtn = document.getElementById('copyConfigBtn');
            const jsonString = JSON.stringify(configData, null, 2);
            
            const textarea = document.createElement('textarea');
            textarea.value = jsonString;
            textarea.style.position = 'fixed';
            textarea.style.top = '0';
            textarea.style.left = '0';
            textarea.style.width = '1px';
            textarea.style.height = '1px';
            textarea.style.padding = '0';
            textarea.style.border = 'none';
            textarea.style.outline = 'none';
            textarea.style.boxShadow = 'none';
            textarea.style.background = 'transparent';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (successful) {
                    copyBtn.classList.add('success');
                    copyBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
                    
                    setTimeout(() => {
                        copyBtn.classList.add('fade-out');
                        setTimeout(() => {
                            copyBtn.classList.remove('success', 'fade-out');
                            copyBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
                        }, 500);
                    }, 1500);
                    
                    console.log('Block configuration copied to clipboard');
                } else {
                    throw new Error('Copy command failed');
                }
            } catch (err) {
                document.body.removeChild(textarea);
                utils.showError(`Failed to copy: ${err.message}`);
                console.error('Copy error:', err);
            }
        }

        function pasteConfiguration() {
            const modal = document.getElementById('pasteModal');
            const hiddenTextarea = document.getElementById('pasteHiddenTextarea');
            const cancelBtn = document.getElementById('pasteModalCancel');
            const pasteBtn = document.getElementById('pasteConfigBtn');
            const hintBox = document.getElementById('pasteModalHint');
            const defaultHintText = 'The block will automatically update with the pasted settings';
            
            modal.classList.add('show');
            hintBox.classList.remove('error');
            hintBox.textContent = defaultHintText;
            
            setTimeout(() => {
                hiddenTextarea.value = '';
                hiddenTextarea.focus();
            }, 100);
            
            const closeModal = () => {
                modal.classList.remove('show');
                hiddenTextarea.value = '';
                hiddenTextarea.blur();
                hintBox.classList.remove('error');
                hintBox.textContent = defaultHintText;
            };
            
            const handleBackgroundClick = (e) => {
                if (e.target === modal) {
                    closeModal();
                    cleanup();
                }
            };
            modal.addEventListener('click', handleBackgroundClick);
            
            const handleCancel = () => {
                closeModal();
                cleanup();
            };
            cancelBtn.addEventListener('click', handleCancel);
            
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    cleanup();
                }
            };
            document.addEventListener('keydown', handleEscape);
            
            const cleanup = () => {
                document.removeEventListener('keydown', handleEscape);
                document.removeEventListener('keydown', handlePaste);
                cancelBtn.removeEventListener('click', handleCancel);
                modal.removeEventListener('click', handleBackgroundClick);
            };
            
            const handlePaste = (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                    hintBox.classList.remove('error');
                    hintBox.textContent = defaultHintText;
                    
                    setTimeout(() => {
                        const text = hiddenTextarea.value.trim();
                        
                        if (!text) {
                            hintBox.textContent = 'No configuration found in clipboard. Please copy a block configuration first.';
                            hintBox.classList.add('error');
                            return;
                        }
                        
                        try {
                            const importData = JSON.parse(text);
                            
                            if (!importData.data) {
                                throw new Error('Invalid configuration format: missing data');
                            }
                            
                            if (!importData.module) {
                                throw new Error('Invalid configuration format: missing module name');
                            }
                            
                            if (importData.module !== moduleConfig.name) {
                                throw new Error(`Configuration mismatch: This is for "${importData.module}", but you're using "${moduleConfig.name}"`);
                            }
                            
                            if (!importData.version) {
                                throw new Error('Invalid configuration format: missing version');
                            }
                            
                            const validFields = Object.keys(moduleConfig.fields);
                            const importedFields = Object.keys(importData.data);
                            const hasValidFields = importedFields.some(field => validFields.includes(field));
                            
                            if (!hasValidFields) {
                                throw new Error('Configuration contains no valid fields for this module');
                            }
                            
                            validFields.forEach(key => {
                                if (importData.data.hasOwnProperty(key)) {
                                    state.blockData[key] = importData.data[key];
                                }
                            });
                            
                            updateUIFromData();
                            refreshPreview();
                            
                            closeModal();
                            cleanup();
                            
                            pasteBtn.classList.add('success');
                            pasteBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
                            
                            setTimeout(() => {
                                pasteBtn.classList.add('fade-out');
                                setTimeout(() => {
                                    pasteBtn.classList.remove('success', 'fade-out');
                                    pasteBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>';
                                }, 500);
                            }, 1500);
                            
                            console.log('Block configuration pasted successfully');
                            
                        } catch (error) {
                            let errorMsg = 'Failed to paste configuration';
                            if (error.message.includes('mismatch')) {
                                errorMsg = error.message;
                            } else if (error.message.includes('Invalid configuration')) {
                                errorMsg = error.message;
                            } else if (error.message.includes('JSON')) {
                                errorMsg = 'Clipboard does not contain valid block configuration. Please copy a block configuration first.';
                            } else {
                                errorMsg = error.message || 'An error occurred while pasting';
                            }
                            
                            hintBox.textContent = errorMsg;
                            hintBox.classList.add('error');
                            console.error('Paste configuration error:', error);
                        }
                    }, 50);
                }
            };
            
            document.addEventListener('keydown', handlePaste);
        }

        function loadData() {
            if (!state.sdk) return utils.showError('SDK not available');
            setLoadingState(true);

            state.sdk.getData((data) => {
                try {
                    state.blockData.videoPath = data?.videoPath || moduleConfig.fields.videoPath.defaultValue;
                    state.blockData.videoHeight = data?.videoHeight || moduleConfig.fields.videoHeight.defaultValue;
                    state.blockData.fallbackImageUrl = data?.fallbackImageUrl || '';
                    state.blockData.fallbackLinkUrl = data?.fallbackLinkUrl || moduleConfig.fields.fallbackLinkUrl.defaultValue;
                    state.blockData.fallbackAltText = data?.fallbackAltText || moduleConfig.fields.fallbackAltText.defaultValue;

                    updateUIFromData();
                    refreshPreview();
                    state.retryCount = 0;
                } catch (error) {
                    utils.showError(`Failed to load data: ${error.message}`);
                    state.blockData = {};
                    refreshPreview();
                } finally {
                    setLoadingState(false);
                }
            });
        }

        function cleanup() {
            state.eventListeners.forEach(({ element, event, handler }) => {
                if (element && element.removeEventListener) element.removeEventListener(event, handler);
            });
            state.eventListeners = [];

            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }

            console.log('Full Width Video cleanup completed');
        }

        function initializeWithRetry() {
            try {
                if (!window.sfdc || !window.sfdc.BlockSDK) throw new Error('BlockSDK not loaded');

                state.sdk = new window.sfdc.BlockSDK({
                    tabs: ['htmlblock']
                });
                
                cacheElements();
                initializeEventHandlers();
                loadData();

                window.addEventListener('beforeunload', cleanup);

                state.isInitialized = true;
            } catch (error) {
                utils.showError(`Initialisation failed: ${error.message}`);
                if (state.retryCount < moduleConfig.maxRetries) {
                    state.retryCount++;
                    setTimeout(() => initializeWithRetry(), 1000 * state.retryCount);
                } else {
                    utils.showError('Failed to initialise after multiple attempts. Please refresh.', true);
                }
                setLoadingState(false);
            }
        }

        document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', initializeWithRetry) : initializeWithRetry();
    </script>
</body>
</html>
